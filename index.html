<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Einstein's Relativity — Interactive Three.js Journey</title>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth;overflow-x:hidden}
body{font-family:'Georgia','Times New Roman',serif;background:#12051f;color:#f0e8dc;overflow-x:hidden;line-height:1.7}

/* Loader */
#loader{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#12051f,#1a0a2e,#12051f);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 1s,visibility 1s}
#loader.hidden{opacity:0;visibility:hidden;pointer-events:none}
#loader h2{color:#f0c060;font-size:1.6rem;margin-top:30px;letter-spacing:2px;animation:pulse 1.5s ease-in-out infinite;text-shadow:0 0 20px rgba(240,180,80,.4)}
@keyframes pulse{0%,100%{opacity:.6;transform:scale(1)}50%{opacity:1;transform:scale(1.05)}}
#loader-bar-wrap{width:260px;height:8px;background:rgba(255,255,255,.15);border-radius:4px;margin-top:20px;overflow:hidden}
#loader-bar{height:100%;width:0%;background:linear-gradient(90deg,#f0c060,#e88840,#c06030);border-radius:4px;transition:width .3s}
.loader-einstein{width:100px;height:140px;animation:bounce 1s ease-in-out infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-40px)}}

/* Progress */
#progress-bar{position:fixed;top:0;left:0;height:4px;background:linear-gradient(90deg,#f0c060,#e88840,#d06838);z-index:1000;transition:width .15s;border-radius:0 2px 2px 0;box-shadow:0 0 10px rgba(240,180,80,.5)}

/* Nav dots */
#nav-dots{position:fixed;right:20px;top:50%;transform:translateY(-50%);z-index:900;display:flex;flex-direction:column;gap:14px}
.nav-dot{width:14px;height:14px;border-radius:50%;background:rgba(240,200,140,.25);cursor:pointer;transition:all .3s;border:2px solid transparent;position:relative}
.nav-dot:hover,.nav-dot.active{background:#f0c060;border-color:rgba(255,240,200,.8);transform:scale(1.3);box-shadow:0 0 12px rgba(240,180,80,.5)}
.nav-dot .tooltip{position:absolute;right:24px;top:50%;transform:translateY(-50%);background:rgba(20,10,30,.9);color:#f0c060;padding:4px 12px;border-radius:6px;font-size:.75rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s}
.nav-dot:hover .tooltip{opacity:1}

/* Scroll indicator */
#scroll-indicator{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);z-index:800;display:flex;flex-direction:column;align-items:center;gap:6px;opacity:1;transition:opacity .5s;pointer-events:none}
#scroll-indicator span{color:rgba(240,200,140,.6);font-size:.8rem;letter-spacing:1px}
.arrow{width:24px;height:24px;border-right:2px solid rgba(240,200,140,.6);border-bottom:2px solid rgba(240,200,140,.6);transform:rotate(45deg);animation:scrollBounce 2s ease-in-out infinite}
@keyframes scrollBounce{0%,100%{transform:rotate(45deg) translateY(0);opacity:.4}50%{transform:rotate(45deg) translateY(8px);opacity:1}}

/* Chapters */
.chapter{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px 80px;position:relative;overflow:hidden}
.chapter-inner{max-width:800px;width:100%;text-align:center;position:relative;z-index:2;opacity:0;transform:translateY(30px);transition:opacity 1s cubic-bezier(.25,.46,.45,.94),transform 1s cubic-bezier(.25,.46,.45,.94)}
.chapter.in-view .chapter-inner{opacity:1;transform:translateY(0)}
.chapter-number{font-size:.85rem;color:rgba(240,180,80,.7);letter-spacing:4px;text-transform:uppercase;margin-bottom:8px}
.chapter h2{font-size:2.4rem;color:#f0c060;margin-bottom:6px;text-shadow:0 0 30px rgba(240,180,80,.35);line-height:1.2}
.chapter h3{font-size:1.1rem;color:rgba(240,220,180,.45);font-weight:normal;font-style:italic;margin-bottom:30px}

.ch-1{background:linear-gradient(180deg,#12051f,#1a0a2e 30%,#22103a 50%,#1a0a2e 70%,#12051f)}
.ch-2{background:linear-gradient(180deg,#0f0818,#18102a 30%,#201638 50%,#18102a 70%,#0f0818)}
.ch-3{background:linear-gradient(180deg,#100a1a,#1c1230 30%,#261a3e 50%,#1c1230 70%,#100a1a)}
.ch-4{background:#12051f}
.ch-5{background:linear-gradient(180deg,#0a0510,#120a1e 30%,#180e28 50%,#120a1e 70%,#0a0510)}
.ch-6{background:linear-gradient(180deg,#0e0a18,#1a1430 30%,#221a3e 50%,#1a1430 70%,#0e0a18)}
.ch-7{background:linear-gradient(180deg,#130a1c,#221235 30%,#2e1a45 50%,#221235 70%,#130a1c)}
.ch-8{background:linear-gradient(180deg,#180822,#2a1040 30%,#381650 50%,#2a1040 70%,#180822)}
.ch-9{background:linear-gradient(180deg,#0d0818,#181028 30%,#201636 50%,#181028 70%,#0d0818)}
.ch-10{background:linear-gradient(180deg,#150a22,#24123a 30%,#301a4a 50%,#24123a 70%,#150a22)}

/* Three.js canvas containers */
.three-container{width:100%;max-width:700px;height:400px;border-radius:16px;margin:20px auto;position:relative;background:rgba(10,5,18,.5);box-shadow:0 8px 32px rgba(0,0,0,.5),0 0 60px rgba(180,120,40,.06);overflow:hidden}
.three-container canvas{width:100%!important;height:100%!important;border-radius:16px;display:block}

/* Speech bubble */
.speech-bubble{background:rgba(40,20,55,.5);border:1px solid rgba(240,200,140,.15);border-radius:20px;padding:24px 30px;margin:20px auto;max-width:600px;position:relative;backdrop-filter:blur(8px);font-size:1.05rem;line-height:1.8;color:rgba(255,240,220,.85);text-align:left;box-shadow:0 4px 20px rgba(0,0,0,.3)}
.speech-bubble::after{content:'';position:absolute;top:-12px;left:50%;transform:translateX(-50%);border:12px solid transparent;border-bottom-color:rgba(40,20,55,.5)}

/* Einstein */
.einstein-wrap{width:200px;height:240px;margin:0 auto 10px;position:relative}
.einstein-svg{width:100%;height:100%;animation:breathe 4s ease-in-out infinite}
@keyframes breathe{0%,100%{transform:scaleY(1) scaleX(1)}50%{transform:scaleY(1.02) scaleX(.99)}}

/* Responsive */
@media(max-width:768px){
  .chapter h2{font-size:1.8rem}
  .three-container{height:280px}
  #nav-dots{right:8px;gap:10px}
  .nav-dot{width:10px;height:10px}
  .einstein-wrap{width:160px;height:190px}
  .speech-bubble{padding:16px 20px;font-size:.95rem}
}
</style>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>
<body>

<!-- Loader -->
<div id="loader">
  <div class="loader-einstein">
    <svg viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
      <defs><radialGradient id="lsg" cx="38%" cy="32%"><stop offset="0%" stop-color="#fde8cc"/><stop offset="100%" stop-color="#dda868"/></radialGradient></defs>
      <ellipse cx="50" cy="50" rx="28" ry="32" fill="url(#lsg)"/>
      <path d="M22 38 Q10 15 30 20 Q25 5 50 10 Q75 5 70 20 Q90 15 78 38" fill="#e8ddd0"/>
      <ellipse cx="38" cy="48" rx="9" ry="10" fill="white"/><ellipse cx="62" cy="48" rx="9" ry="10" fill="white"/>
      <circle cx="39" cy="49" r="5" fill="#6b4420"/><circle cx="63" cy="49" r="5" fill="#6b4420"/>
      <circle cx="39" cy="49" r="2.5" fill="#1a0e05"/><circle cx="63" cy="49" r="2.5" fill="#1a0e05"/>
      <circle cx="41" cy="46" r="2" fill="white" opacity=".9"/><circle cx="65" cy="46" r="2" fill="white" opacity=".9"/>
      <path d="M38 68 Q50 76 62 68" fill="none" stroke="rgba(180,110,70,.6)" stroke-width="2" stroke-linecap="round"/>
      <path d="M36 63 Q43 60 50 65 Q57 60 64 63" fill="rgba(180,170,155,.8)"/>
      <circle cx="26" cy="58" r="7" fill="#ff9988" opacity=".3"/><circle cx="74" cy="58" r="7" fill="#ff9988" opacity=".3"/>
      <rect x="30" y="82" width="40" height="50" rx="8" fill="#f0e4d0"/>
      <polygon points="44,86 50,90 56,86 56,94 50,90 44,94" fill="#8b2020"/>
      <circle cx="50" cy="90" r="2.5" fill="#c83838"/>
    </svg>
  </div>
  <h2>Warming Up the Universe...</h2>
  <div id="loader-bar-wrap"><div id="loader-bar"></div></div>
</div>

<div id="progress-bar"></div>
<div id="nav-dots"></div>
<div id="scroll-indicator"><span>SCROLL DOWN</span><div class="arrow"></div></div>

<!-- Chapter 1 -->
<section class="chapter ch-1" id="ch1" data-title="What is Gravity?">
<div class="chapter-inner">
  <div class="einstein-wrap" id="einstein-1"></div>
  <span class="chapter-number">Chapter I</span>
  <h2>What is Gravity?</h2>
  <h3>Newton's apple meets Einstein's curved spacetime</h3>
  <div class="three-container" id="tc1"></div>
  <div class="speech-bubble"><span class="typewriter" data-text="Gravity isn't a force pulling you down — it's the curvature of spacetime itself! Imagine a bowling ball on a trampoline. Everything nearby rolls toward it, not because of a mysterious pull, but because the fabric of space is bent."></span></div>
</div>
</section>

<!-- Chapter 2 -->
<section class="chapter ch-2" id="ch2" data-title="The Fabric of Space-Time">
<div class="chapter-inner">
  <div class="einstein-wrap" id="einstein-2"></div>
  <span class="chapter-number">Chapter II</span>
  <h2>The Fabric of Space-Time</h2>
  <h3>Touch to warp the universe</h3>
  <div class="three-container" id="tc2"></div>
  <div class="speech-bubble"><span class="typewriter" data-text="Space and time aren't separate — they're woven together into a single fabric. Massive objects like stars and planets create dips in this fabric. Touch the grid and watch spacetime curve beneath your finger."></span></div>
</div>
</section>

<!-- Chapter 3 -->
<section class="chapter ch-3" id="ch3" data-title="Time Slows Down">
<div class="chapter-inner">
  <div class="einstein-wrap" id="einstein-3"></div>
  <span class="chapter-number">Chapter III</span>
  <h2>Time Slows Down</h2>
  <h3>Gravitational time dilation in action</h3>
  <div class="three-container" id="tc3"></div>
  <div class="speech-bubble"><span class="typewriter" data-text="Near a massive object, time literally runs slower! A clock near a black hole ticks much more slowly than one floating in deep space. GPS satellites must account for this effect every single day."></span></div>
</div>
</section>

<!-- Chapter 4 -->
<section class="chapter ch-4" id="ch4" data-title="Light Bends">
<div class="chapter-inner">
  <div class="einstein-wrap" id="einstein-4"></div>
  <span class="chapter-number">Chapter IV</span>
  <h2>Light Bends</h2>
  <h3>Gravitational lensing & Einstein rings</h3>
  <div class="three-container" id="tc4"></div>
  <div class="speech-bubble"><span class="typewriter" data-text="Even light follows the curves of spacetime! When light passes near a massive object, it bends — creating beautiful rings and arcs. This effect was the first proof of General Relativity!"></span></div>
</div>
</section>

<!-- Chapter 5 -->
<section class="chapter ch-5" id="ch5" data-title="Black Holes">
<div class="chapter-inner">
  <div class="einstein-wrap" id="einstein-5"></div>
  <span class="chapter-number">Chapter V</span>
  <h2>Black Holes</h2>
  <h3>Where spacetime curves to infinity</h3>
  <div class="three-container" id="tc5"></div>
  <div class="speech-bubble"><span class="typewriter" data-text="When a massive star collapses, it creates a region where gravity is so strong that nothing — not even light — can escape. The boundary is the event horizon. Beyond it, the known laws of physics break down entirely!"></span></div>
</div>
</section>

<!-- Chapter 6 -->
<section class="chapter ch-6" id="ch6" data-title="Gravitational Waves">
<div class="chapter-inner">
  <div class="einstein-wrap" id="einstein-6"></div>
  <span class="chapter-number">Chapter VI</span>
  <h2>Gravitational Waves</h2>
  <h3>Ripples in the fabric of spacetime</h3>
  <div class="three-container" id="tc6"></div>
  <div class="speech-bubble"><span class="typewriter" data-text="When massive objects accelerate — like two black holes spiraling together — they send ripples through spacetime. Einstein predicted these waves in 1916, and we finally detected them in 2015!"></span></div>
</div>
</section>

<!-- Chapter 7 -->
<section class="chapter ch-7" id="ch7" data-title="Speed of Light">
<div class="chapter-inner">
  <div class="einstein-wrap" id="einstein-7"></div>
  <span class="chapter-number">Chapter VII</span>
  <h2>Speed of Light</h2>
  <h3>The cosmic speed limit: 299,792,458 m/s</h3>
  <div class="three-container" id="tc7"></div>
  <div class="speech-bubble"><span class="typewriter" data-text="Nothing can travel faster than light — it's the ultimate speed limit! As you approach light speed, time slows, length contracts, and your mass effectively increases toward infinity."></span></div>
</div>
</section>

<!-- Chapter 8 -->
<section class="chapter ch-8" id="ch8" data-title="E = mc²">
<div class="chapter-inner">
  <div class="einstein-wrap" id="einstein-8"></div>
  <span class="chapter-number">Chapter VIII</span>
  <h2>E = mc²</h2>
  <h3>The most famous equation in history</h3>
  <div class="three-container" id="tc8"></div>
  <div class="speech-bubble"><span class="typewriter" data-text="Mass and energy are the same thing! A tiny amount of mass contains enormous energy — because you multiply by the speed of light squared. This powers the Sun, nuclear reactors, and nuclear weapons."></span></div>
</div>
</section>

<!-- Chapter 9 -->
<section class="chapter ch-9" id="ch9" data-title="Length Contraction">
<div class="chapter-inner">
  <div class="einstein-wrap" id="einstein-9"></div>
  <span class="chapter-number">Chapter IX</span>
  <h2>Length Contraction</h2>
  <h3>Objects shrink at relativistic speeds</h3>
  <div class="three-container" id="tc9"></div>
  <div class="speech-bubble"><span class="typewriter" data-text="As an object moves faster, it gets shorter in the direction of motion! At 90% the speed of light, a spaceship appears squished to less than half its resting length. Space itself contracts!"></span></div>
</div>
</section>

<!-- Chapter 10 -->
<section class="chapter ch-10" id="ch10" data-title="The Twin Paradox">
<div class="chapter-inner">
  <div class="einstein-wrap" id="einstein-10"></div>
  <span class="chapter-number">Chapter X</span>
  <h2>The Twin Paradox</h2>
  <h3>One twin ages while the other stays young</h3>
  <div class="three-container" id="tc10"></div>
  <div class="speech-bubble"><span class="typewriter" data-text="Imagine twins: one stays on Earth, the other travels near light speed to a distant star and back. When the traveler returns, they've barely aged — while their twin is now old and gray. It's real physics!"></span></div>
</div>
</section>

<script src="https://unpkg.com/gsap@3.12.5/dist/gsap.min.js"></script>
<script src="https://unpkg.com/gsap@3.12.5/dist/ScrollTrigger.min.js"></script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

/* ===================== GLOBALS ===================== */
const chapters = document.querySelectorAll('.chapter');
const chapterTitles = ['What is Gravity?','Space-Time Fabric','Time Dilation','Light Bending','Black Holes','Gravitational Waves','Speed of Light','E = mc²','Length Contraction','Twin Paradox'];
const visibleChapters = new Set();
const chapterAnimators = {};
let globalTime = 0;

/* ===================== EINSTEIN SVG ===================== */
function createEinstein(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = `<svg class="einstein-svg" viewBox="-15 -15 130 160" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="sg${id}" cx="38%" cy="32%"><stop offset="0%" stop-color="#fde8cc"/><stop offset="100%" stop-color="#dba56a"/></radialGradient>
      <radialGradient id="cg${id}" cx="50%" cy="40%"><stop offset="0%" stop-color="#ff8877" stop-opacity=".55"/><stop offset="100%" stop-color="#ff8877" stop-opacity="0"/></radialGradient>
    </defs>
    <g>
      <path d="M24,88 C20,92 18,108 20,125 Q22,135 30,138 L70,138 Q78,135 80,125 C82,108 80,92 76,88 Q68,83 50,81 Q32,83 24,88Z" fill="#f0e4d0" stroke="rgba(170,140,100,.35)" stroke-width=".5"/>
      <polygon points="44,86 50,90 56,86 56,94 50,90 44,94" fill="#8b2020"/>
      <circle cx="50" cy="90" r="2.5" fill="#c83838"/>
      <ellipse cx="20" cy="52" rx="6" ry="8" fill="#e4b474"/>
      <ellipse cx="80" cy="52" rx="6" ry="8" fill="#e4b474"/>
      <ellipse cx="50" cy="48" rx="31" ry="36" fill="url(#sg${id})"/>
      <g style="transform-origin:50px 18px">
        <path d="M18 44 Q2 26 14 14 Q8 -2 28 4 Q22 -10 46 -6 Q40 -14 56 -10 Q52 -14 68 -6 Q62 -10 80 0 Q74 -4 88 8 Q96 2 88 22 Q102 16 84 42" fill="#e8ddd0" stroke="rgba(140,128,108,.4)" stroke-width=".8"/>
        <path d="M14 42 Q-2 30 6 14" fill="none" stroke="rgba(210,200,182,.8)" stroke-width="5" stroke-linecap="round"/>
        <path d="M86 42 Q102 30 94 14" fill="none" stroke="rgba(210,200,182,.8)" stroke-width="5" stroke-linecap="round"/>
      </g>
      <ellipse cx="37" cy="47" rx="10" ry="11" fill="white"/>
      <ellipse cx="63" cy="47" rx="10" ry="11" fill="white"/>
      <circle cx="38" cy="48" r="6" fill="#5a3818"/>
      <circle cx="64" cy="48" r="6" fill="#5a3818"/>
      <circle cx="38" cy="48" r="3" fill="#0e0802"/>
      <circle cx="64" cy="48" r="3" fill="#0e0802"/>
      <circle cx="41" cy="45" r="2.5" fill="white" opacity=".9"/>
      <circle cx="67" cy="45" r="2.5" fill="white" opacity=".9"/>
      <path d="M26,36 Q37,28 48,35" fill="none" stroke="rgba(100,70,35,.8)" stroke-width="3" stroke-linecap="round"/>
      <path d="M52,35 Q63,28 74,36" fill="none" stroke="rgba(100,70,35,.8)" stroke-width="3" stroke-linecap="round"/>
      <circle cx="24" cy="58" r="8" fill="url(#cg${id})"/>
      <circle cx="76" cy="58" r="8" fill="url(#cg${id})"/>
      <path d="M46,58 Q50,63 54,58" fill="none" stroke="rgba(160,100,50,.45)" stroke-width="1.2" stroke-linecap="round"/>
      <path d="M32,66 Q40,62 50,68 Q60,62 68,66" fill="rgba(170,160,142,.9)"/>
      <path d="M36,69 Q50,79 64,69" fill="rgba(120,50,30,.15)" stroke="rgba(180,110,70,.6)" stroke-width="1.8" stroke-linecap="round"/>
    </g>
  </svg>`;
}
for (let i = 1; i <= 10; i++) createEinstein('einstein-' + i);

/* ===================== NAV DOTS ===================== */
const navDots = document.getElementById('nav-dots');
chapterTitles.forEach((t, i) => {
  const d = document.createElement('div');
  d.className = 'nav-dot';
  d.innerHTML = `<span class="tooltip">${t}</span>`;
  d.onclick = () => document.getElementById('ch' + (i + 1)).scrollIntoView({ behavior: 'smooth' });
  navDots.appendChild(d);
});
const dots = navDots.querySelectorAll('.nav-dot');

/* ===================== TYPEWRITER ===================== */
function startTypewriter(el) {
  if (el.dataset.started) return;
  el.dataset.started = '1';
  const text = el.dataset.text;
  let i = 0;
  const iv = setInterval(() => {
    el.textContent = text.slice(0, ++i);
    if (i >= text.length) clearInterval(iv);
  }, 25);
}

/* ===================== INTERSECTION OBSERVER ===================== */
const observer = new IntersectionObserver((entries) => {
  entries.forEach(e => {
    const id = e.target.id;
    const idx = parseInt(id.replace('ch', '')) - 1;
    if (e.isIntersecting) {
      e.target.classList.add('in-view');
      visibleChapters.add(id);
      dots.forEach((d, di) => d.classList.toggle('active', di === idx));
      const tw = e.target.querySelector('.typewriter');
      if (tw) setTimeout(() => startTypewriter(tw), 800);
    } else {
      visibleChapters.delete(id);
    }
  });
}, { threshold: 0.3 });
chapters.forEach(c => observer.observe(c));

/* ===================== PROGRESS BAR ===================== */
const progressBar = document.getElementById('progress-bar');
const scrollInd = document.getElementById('scroll-indicator');
window.addEventListener('scroll', () => {
  const s = window.scrollY, h = document.documentElement.scrollHeight - window.innerHeight;
  progressBar.style.width = (s / h * 100) + '%';
  scrollInd.style.opacity = s > 200 ? '0' : '1';
});

/* ===================== HELPER: create scene+renderer for a container ===================== */
function createSceneKit(containerId, opts = {}) {
  const container = document.getElementById(containerId);
  if (!container) return null;
  const w = container.clientWidth || 700, h = container.clientHeight || 400;
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(opts.bg || 0x0a0512);
  const camera = new THREE.PerspectiveCamera(50, w / h, 0.1, 1000);
  camera.position.z = opts.camZ || 10;
  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
  renderer.setSize(w, h);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  container.appendChild(renderer.domElement);

  let composer = null;
  if (opts.bloom) {
    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloom = new UnrealBloomPass(new THREE.Vector2(w, h), opts.bloomStrength || 1.2, opts.bloomRadius || 0.4, opts.bloomThreshold || 0.2);
    composer.addPass(bloom);
  }

  return { scene, camera, renderer, composer, container, w, h };
}

/* ===================== CHAPTER 1: GRAVITY — Newton vs Einstein split ===================== */
function initChapter1() {
  const kit = createSceneKit('tc1', { bg: 0x0a0512, camZ: 12 });
  if (!kit) return;
  const { scene, camera, renderer } = kit;

  // Left side: Newton scene — apple + tree silhouette
  // Right side: Einstein curved grid
  const gridGeo = new THREE.PlaneGeometry(10, 10, 30, 30);
  const gridMat = new THREE.MeshBasicMaterial({ color: 0xf0c060, wireframe: true, transparent: true, opacity: 0.3 });
  const grid = new THREE.Mesh(gridGeo, gridMat);
  grid.position.set(3, 0, 0);
  scene.add(grid);

  // Mass causing dip
  const sphere = new THREE.Mesh(
    new THREE.SphereGeometry(0.6, 24, 24),
    new THREE.MeshBasicMaterial({ color: 0xf0c060 })
  );
  sphere.position.set(3, 0, 0.8);
  scene.add(sphere);

  // Apple (left side)
  const appleMat = new THREE.MeshBasicMaterial({ color: 0xcc3333 });
  const apple = new THREE.Mesh(new THREE.SphereGeometry(0.25, 16, 16), appleMat);
  apple.position.set(-3.5, 3, 0);
  scene.add(apple);

  // Tree trunk
  const trunk = new THREE.Mesh(
    new THREE.BoxGeometry(0.3, 4, 0.3),
    new THREE.MeshBasicMaterial({ color: 0x5a3a1a })
  );
  trunk.position.set(-3.5, 0, 0);
  scene.add(trunk);

  // Canopy
  const canopy = new THREE.Mesh(
    new THREE.SphereGeometry(1.5, 16, 16),
    new THREE.MeshBasicMaterial({ color: 0x4aa830 })
  );
  canopy.position.set(-3.5, 3, 0);
  scene.add(canopy);

  // Ground line (left)
  const groundGeo = new THREE.PlaneGeometry(6, 0.1);
  const ground = new THREE.Mesh(groundGeo, new THREE.MeshBasicMaterial({ color: 0x3a7020 }));
  ground.position.set(-3.5, -2, 0);
  scene.add(ground);

  // Divider
  const divGeo = new THREE.PlaneGeometry(0.02, 12);
  const divider = new THREE.Mesh(divGeo, new THREE.MeshBasicMaterial({ color: 0xf0c060, transparent: true, opacity: 0.3 }));
  scene.add(divider);

  // Labels
  const labelLeft = makeTextSprite('Newton', 0.6);
  labelLeft.position.set(-3.5, 4.5, 0);
  scene.add(labelLeft);
  const labelRight = makeTextSprite('Einstein', 0.6);
  labelRight.position.set(3, 4.5, 0);
  scene.add(labelRight);

  // Apple animation
  let appleTime = 0;
  const appleStartY = 3;

  function animate() {
    if (!visibleChapters.has('ch1')) return;
    appleTime += 0.016;

    // Apple cycle: hang 2s, fall 1s, bounce, reset
    const cycle = appleTime % 5;
    if (cycle < 2) {
      apple.position.y = appleStartY + Math.sin(appleTime * 3) * 0.05;
      apple.scale.set(1, 1, 1);
    } else if (cycle < 3) {
      const t = (cycle - 2);
      apple.position.y = appleStartY - t * t * 5;
      apple.scale.set(1, 1, 1);
    } else if (cycle < 3.3) {
      apple.position.y = -2;
      const bt = (cycle - 3) / 0.3;
      apple.scale.set(1 + 0.3 * (1 - bt), 1 - 0.3 * (1 - bt), 1);
    } else {
      apple.position.y = -2 + Math.sin((cycle - 3.3) * 8) * 0.3 * Math.exp(-(cycle - 3.3) * 3);
      apple.scale.set(1, 1, 1);
    }

    // Warp grid vertices
    const pos = gridGeo.attributes.position;
    for (let i = 0; i < pos.count; i++) {
      const x = pos.getX(i), y = pos.getY(i);
      const d = Math.sqrt(x * x + y * y);
      pos.setZ(i, -1.5 / (d + 0.8) + 0.3 * Math.sin(globalTime + d));
    }
    pos.needsUpdate = true;

    renderer.render(scene, camera);
  }

  chapterAnimators['ch1'] = animate;
}

/* ===================== CHAPTER 2: SPACETIME FABRIC ===================== */
function initChapter2() {
  const kit = createSceneKit('tc2', { bg: 0x0a0512, camZ: 14 });
  if (!kit) return;
  const { scene, camera, renderer, container } = kit;
  camera.position.set(0, -5, 12);
  camera.lookAt(0, 0, 0);

  const seg = 50;
  const geo = new THREE.PlaneGeometry(16, 12, seg, seg);
  const mat = new THREE.MeshBasicMaterial({ color: 0xf0c060, wireframe: true, transparent: true, opacity: 0.4 });
  const mesh = new THREE.Mesh(geo, mat);
  mesh.rotation.x = -0.4;
  scene.add(mesh);

  // Stars
  const starGeo = new THREE.BufferGeometry();
  const starPos = new Float32Array(300 * 3);
  for (let i = 0; i < 300; i++) {
    starPos[i * 3] = (Math.random() - 0.5) * 40;
    starPos[i * 3 + 1] = (Math.random() - 0.5) * 30;
    starPos[i * 3 + 2] = -5 - Math.random() * 10;
  }
  starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
  scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xf0c060, size: 0.08, transparent: true, opacity: 0.5 })));

  let touchX = 0, touchY = 0, curX = 0, curY = 0;
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();

  function onPointer(e) {
    const rect = container.getBoundingClientRect();
    const cx = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
    const cy = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
    mouse.x = (cx / rect.width) * 2 - 1;
    mouse.y = -(cy / rect.height) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObject(mesh);
    if (hits.length) {
      touchX = hits[0].point.x;
      touchY = hits[0].point.y;
    }
  }
  container.addEventListener('mousemove', onPointer);
  container.addEventListener('touchmove', e => { e.preventDefault(); onPointer(e.touches[0]); }, { passive: false });

  const restPositions = [];
  const pos = geo.attributes.position;
  for (let i = 0; i < pos.count; i++) {
    restPositions.push(pos.getX(i), pos.getY(i), pos.getZ(i));
  }

  function animate() {
    if (!visibleChapters.has('ch2')) return;
    curX += (touchX - curX) * 0.3;
    curY += (touchY - curY) * 0.3;

    for (let i = 0; i < pos.count; i++) {
      const rx = restPositions[i * 3], ry = restPositions[i * 3 + 1];
      const dx = rx - curX, dy = ry - curY;
      const d = Math.sqrt(dx * dx + dy * dy);
      const warp = -3 / (d + 1);
      pos.setZ(i, warp);
    }
    pos.needsUpdate = true;
    renderer.render(scene, camera);
  }
  chapterAnimators['ch2'] = animate;
}

/* ===================== CHAPTER 3: TIME DILATION ===================== */
function initChapter3() {
  const kit = createSceneKit('tc3', { bg: 0x0a0512, camZ: 10 });
  if (!kit) return;
  const { scene, camera, renderer } = kit;

  // Two clocks — represented as rings
  function makeClock(x, label, color) {
    const group = new THREE.Group();
    // Clock face
    const ring = new THREE.Mesh(
      new THREE.RingGeometry(1.4, 1.6, 48),
      new THREE.MeshBasicMaterial({ color, side: THREE.DoubleSide })
    );
    group.add(ring);
    // Tick marks
    for (let i = 0; i < 12; i++) {
      const a = (i / 12) * Math.PI * 2;
      const tick = new THREE.Mesh(
        new THREE.PlaneGeometry(0.05, 0.2),
        new THREE.MeshBasicMaterial({ color })
      );
      tick.position.set(Math.sin(a) * 1.3, Math.cos(a) * 1.3, 0);
      tick.rotation.z = -a;
      group.add(tick);
    }
    // Hand
    const hand = new THREE.Mesh(
      new THREE.PlaneGeometry(0.04, 1.2),
      new THREE.MeshBasicMaterial({ color: 0xf0c060 })
    );
    hand.position.y = 0.5;
    const handPivot = new THREE.Group();
    handPivot.add(hand);
    group.add(handPivot);
    // Label
    const spr = makeTextSprite(label, 0.5);
    spr.position.y = -2.2;
    group.add(spr);
    group.position.x = x;
    scene.add(group);
    return handPivot;
  }

  const handFar = makeClock(-3, 'Far from mass', 0x66aaff);
  const handNear = makeClock(3, 'Near mass', 0xff6644);

  // Massive object near right clock
  const mass = new THREE.Mesh(
    new THREE.SphereGeometry(0.8, 24, 24),
    new THREE.MeshBasicMaterial({ color: 0x884422, transparent: true, opacity: 0.6 })
  );
  mass.position.set(3, -3.5, 0);
  scene.add(mass);
  const massLabel = makeTextSprite('Massive Object', 0.4);
  massLabel.position.set(3, -4.8, 0);
  scene.add(massLabel);

  function animate() {
    if (!visibleChapters.has('ch3')) return;
    handFar.rotation.z -= 0.03; // normal speed
    handNear.rotation.z -= 0.01; // slower near mass
    renderer.render(scene, camera);
  }
  chapterAnimators['ch3'] = animate;
}

/* ===================== CHAPTER 4: LIGHT BENDING ===================== */
function initChapter4() {
  const kit = createSceneKit('tc4', { bg: 0x0a0512, camZ: 14, bloom: true, bloomStrength: 1.0, bloomRadius: 0.5, bloomThreshold: 0.3 });
  if (!kit) return;
  const { scene, camera, renderer, composer } = kit;
  camera.position.set(0, -4, 14);
  camera.lookAt(0, 0, 0);

  // Grid
  const gridGeo = new THREE.PlaneGeometry(18, 14, 40, 40);
  const gridMat = new THREE.MeshBasicMaterial({ color: 0x4a3070, wireframe: true, transparent: true, opacity: 0.25 });
  const grid = new THREE.Mesh(gridGeo, gridMat);
  grid.rotation.x = -0.5;
  scene.add(grid);

  // Sun
  const sun = new THREE.Mesh(
    new THREE.SphereGeometry(0.8, 24, 24),
    new THREE.MeshBasicMaterial({ color: 0xffcc44 })
  );
  sun.position.set(0, 0, 1);
  scene.add(sun);

  // Glow around sun
  const glow = new THREE.Mesh(
    new THREE.SphereGeometry(1.4, 24, 24),
    new THREE.MeshBasicMaterial({ color: 0xffaa22, transparent: true, opacity: 0.15 })
  );
  glow.position.copy(sun.position);
  scene.add(glow);

  // Photon path — curved around sun
  const GM = 10, dt = 0.01;
  const photonPoints = [];
  let px = -8, py = 1.5, pvx = 1, pvy = 0;
  for (let step = 0; step < 2000; step++) {
    photonPoints.push(new THREE.Vector3(px, py, 0.5));
    const ddx = -px, ddy = -py;
    const r = Math.sqrt(ddx * ddx + ddy * ddy);
    if (r < 0.9) break;
    const a = GM / (r * r * r);
    pvx += ddx * a * dt;
    pvy += ddy * a * dt;
    const spd = Math.sqrt(pvx * pvx + pvy * pvy);
    pvx /= spd; pvy /= spd;
    px += pvx * dt * 4;
    py += pvy * dt * 4;
    if (px > 9) break;
  }
  const curve = new THREE.CatmullRomCurve3(photonPoints);
  const tubGeo = new THREE.TubeGeometry(curve, 200, 0.04, 8, false);
  const tubMat = new THREE.MeshBasicMaterial({ color: 0xffee88, transparent: true, opacity: 0.8 });
  const tube = new THREE.Mesh(tubGeo, tubMat);
  scene.add(tube);

  // Animate photon dot
  const photon = new THREE.Mesh(
    new THREE.SphereGeometry(0.12, 12, 12),
    new THREE.MeshBasicMaterial({ color: 0xffffcc })
  );
  scene.add(photon);

  // Warp grid
  const gPos = gridGeo.attributes.position;
  for (let i = 0; i < gPos.count; i++) {
    const x = gPos.getX(i), y = gPos.getY(i);
    const d = Math.sqrt(x * x + y * y);
    gPos.setZ(i, -2 / (d + 0.8));
  }
  gPos.needsUpdate = true;

  let photonT = 0;
  function animate() {
    if (!visibleChapters.has('ch4')) return;
    photonT = (photonT + 0.003) % 1;
    const pt = curve.getPointAt(photonT);
    photon.position.copy(pt);
    glow.scale.setScalar(1 + 0.1 * Math.sin(globalTime * 3));
    composer.render();
  }
  chapterAnimators['ch4'] = animate;
}

/* ===================== CHAPTER 5: BLACK HOLES ===================== */
function initChapter5() {
  const kit = createSceneKit('tc5', { bg: 0x050208, camZ: 10, bloom: true, bloomStrength: 1.5, bloomRadius: 0.6, bloomThreshold: 0.15 });
  if (!kit) return;
  const { scene, camera, renderer, composer } = kit;

  // Event horizon
  const horizon = new THREE.Mesh(
    new THREE.SphereGeometry(1, 32, 32),
    new THREE.MeshBasicMaterial({ color: 0x000000 })
  );
  scene.add(horizon);

  // Photon ring (gold)
  const photonRing = new THREE.Mesh(
    new THREE.RingGeometry(1.4, 1.55, 64),
    new THREE.MeshBasicMaterial({ color: 0xf0c060, side: THREE.DoubleSide, transparent: true, opacity: 0.9 })
  );
  scene.add(photonRing);

  // Accretion disk — 14 rings
  for (let i = 0; i < 14; i++) {
    const inner = 1.8 + i * 0.35;
    const outer = inner + 0.25;
    const hue = 0.08 - i * 0.004;
    const c = new THREE.Color().setHSL(hue, 0.9, 0.5 + i * 0.02);
    const ring = new THREE.Mesh(
      new THREE.RingGeometry(inner, outer, 64),
      new THREE.MeshBasicMaterial({ color: c, side: THREE.DoubleSide, transparent: true, opacity: 0.6 - i * 0.03 })
    );
    ring.rotation.x = Math.PI * 0.42;
    scene.add(ring);
  }

  // Stars
  const starCount = 50;
  const stars = [];
  for (let i = 0; i < starCount; i++) {
    const s = new THREE.Mesh(
      new THREE.SphereGeometry(0.04, 6, 6),
      new THREE.MeshBasicMaterial({ color: 0xf0c060 })
    );
    const angle = Math.random() * Math.PI * 2;
    const radius = 4 + Math.random() * 4;
    s.userData = { angle, radius, speed: 0.002 + Math.random() * 0.005, z: (Math.random() - 0.5) * 3 };
    scene.add(s);
    stars.push(s);
  }

  function animate() {
    if (!visibleChapters.has('ch5')) return;
    // Rotate stars / spaghettify near horizon
    stars.forEach(s => {
      s.userData.angle += s.userData.speed;
      let r = s.userData.radius;
      // Slowly spiral in
      s.userData.radius -= 0.001;
      if (s.userData.radius < 1.2) { s.userData.radius = 4 + Math.random() * 4; s.userData.angle = Math.random() * Math.PI * 2; }
      s.position.x = Math.cos(s.userData.angle) * r;
      s.position.y = Math.sin(s.userData.angle) * r * 0.4;
      s.position.z = s.userData.z;
      // Spaghettify
      const dist = r;
      const stretch = dist < 2.5 ? 1 + (2.5 - dist) * 2 : 1;
      s.scale.set(1, stretch, 1);
    });
    photonRing.rotation.z += 0.005;
    composer.render();
  }
  chapterAnimators['ch5'] = animate;
}

/* ===================== CHAPTER 6: GRAVITATIONAL WAVES ===================== */
function initChapter6() {
  const kit = createSceneKit('tc6', { bg: 0x0a0512, camZ: 12, bloom: true, bloomStrength: 0.8, bloomRadius: 0.4, bloomThreshold: 0.3 });
  if (!kit) return;
  const { scene, camera, renderer, composer } = kit;

  // Two orbiting masses
  const m1 = new THREE.Mesh(new THREE.SphereGeometry(0.4, 16, 16), new THREE.MeshBasicMaterial({ color: 0xf0c060 }));
  const m2 = new THREE.Mesh(new THREE.SphereGeometry(0.35, 16, 16), new THREE.MeshBasicMaterial({ color: 0xe88840 }));
  scene.add(m1, m2);

  // Ripple rings
  const ripples = [];
  for (let i = 0; i < 8; i++) {
    const r = new THREE.Mesh(
      new THREE.RingGeometry(0.5 + i * 1.2, 0.6 + i * 1.2, 48),
      new THREE.MeshBasicMaterial({ color: 0xf0c060, side: THREE.DoubleSide, transparent: true, opacity: 0 })
    );
    scene.add(r);
    ripples.push(r);
  }

  let phase = 0; // 0=spiral, 1=flash, 2=rings
  let phaseTime = 0;
  let orbitRadius = 2.5;
  let orbitAngle = 0;

  function animate() {
    if (!visibleChapters.has('ch6')) return;
    phaseTime += 0.016;
    const totalCycle = 8;
    const cycleT = phaseTime % totalCycle;

    if (cycleT < 4) {
      // Spiral phase
      phase = 0;
      orbitRadius = 2.5 - cycleT * 0.5;
      if (orbitRadius < 0.3) orbitRadius = 0.3;
      orbitAngle += 0.05 + (4 - orbitRadius) * 0.03;
      m1.position.set(Math.cos(orbitAngle) * orbitRadius, Math.sin(orbitAngle) * orbitRadius, 0);
      m2.position.set(-Math.cos(orbitAngle) * orbitRadius, -Math.sin(orbitAngle) * orbitRadius, 0);
      m1.visible = m2.visible = true;
      ripples.forEach(r => r.material.opacity = 0);
    } else if (cycleT < 4.5) {
      // Flash
      m1.visible = m2.visible = false;
      ripples.forEach(r => r.material.opacity = 0);
    } else {
      // Rings expanding
      const rt = cycleT - 4.5;
      ripples.forEach((r, i) => {
        const delay = i * 0.15;
        const t = rt - delay;
        if (t > 0) {
          const s = 1 + t * 2;
          r.scale.setScalar(s);
          r.material.opacity = Math.max(0, 0.6 - t * 0.2);
        } else {
          r.material.opacity = 0;
        }
      });
    }

    composer.render();
  }
  chapterAnimators['ch6'] = animate;
}

/* ===================== CHAPTER 7: SPEED OF LIGHT ===================== */
function initChapter7() {
  const kit = createSceneKit('tc7', { bg: 0x0a0512, camZ: 10, bloom: true, bloomStrength: 1.0, bloomRadius: 0.3, bloomThreshold: 0.2 });
  if (!kit) return;
  const { scene, camera, renderer, composer } = kit;

  // Spaceship (simple triangle/cone shape)
  const shipGeo = new THREE.ConeGeometry(0.3, 1.2, 8);
  shipGeo.rotateZ(-Math.PI / 2);
  const ship = new THREE.Mesh(shipGeo, new THREE.MeshBasicMaterial({ color: 0xccccdd }));
  ship.position.set(-4, 0, 0);
  scene.add(ship);

  // Engine glow
  const engineGlow = new THREE.Mesh(
    new THREE.SphereGeometry(0.25, 12, 12),
    new THREE.MeshBasicMaterial({ color: 0x4488ff, transparent: true, opacity: 0.7 })
  );
  engineGlow.position.set(-4.6, 0, 0);
  scene.add(engineGlow);

  // Speed bar
  const barBg = new THREE.Mesh(
    new THREE.PlaneGeometry(8, 0.3),
    new THREE.MeshBasicMaterial({ color: 0x1a1030 })
  );
  barBg.position.set(0, -3, 0);
  scene.add(barBg);

  const barFill = new THREE.Mesh(
    new THREE.PlaneGeometry(0.1, 0.25),
    new THREE.MeshBasicMaterial({ color: 0xf0c060 })
  );
  barFill.position.set(-3.95, -3, 0.01);
  scene.add(barFill);

  // "c" limit marker
  const cLine = new THREE.Mesh(
    new THREE.PlaneGeometry(0.04, 0.5),
    new THREE.MeshBasicMaterial({ color: 0xff4444 })
  );
  cLine.position.set(3.8, -3, 0.01);
  scene.add(cLine);
  const cLabel = makeTextSprite('c', 0.4);
  cLabel.position.set(3.8, -3.6, 0);
  scene.add(cLabel);

  // Star streaks for speed effect
  const streaks = [];
  for (let i = 0; i < 40; i++) {
    const s = new THREE.Mesh(
      new THREE.PlaneGeometry(0.5, 0.02),
      new THREE.MeshBasicMaterial({ color: 0xf0c060, transparent: true, opacity: 0.3 })
    );
    s.position.set((Math.random() - 0.5) * 12, (Math.random() - 0.5) * 8, -1);
    s.userData.baseX = s.position.x;
    scene.add(s);
    streaks.push(s);
  }

  let speed = 0;
  let accel = 0.002;

  function animate() {
    if (!visibleChapters.has('ch7')) return;

    // Speed asymptotically approaches c
    speed += accel * (1 - speed);
    if (speed > 0.998) { speed = 0; } // reset

    const barWidth = speed * 7.8;
    barFill.scale.x = Math.max(barWidth / 0.1, 1);
    barFill.position.x = -3.95 + barWidth / 2;

    // Ship position
    ship.position.x = -4 + speed * 3;
    engineGlow.position.x = ship.position.x - 0.7;
    engineGlow.scale.setScalar(0.5 + speed * 2);
    engineGlow.material.opacity = 0.3 + speed * 0.7;

    // Star streaks
    streaks.forEach(s => {
      s.scale.x = 1 + speed * 10;
      s.material.opacity = 0.1 + speed * 0.5;
    });

    composer.render();
  }
  chapterAnimators['ch7'] = animate;
}

/* ===================== CHAPTER 8: E=mc² ===================== */
function initChapter8() {
  const kit = createSceneKit('tc8', { bg: 0x0a0512, camZ: 10, bloom: true, bloomStrength: 1.8, bloomRadius: 0.5, bloomThreshold: 0.1 });
  if (!kit) return;
  const { scene, camera, renderer, composer } = kit;

  // Mass sphere
  const mass = new THREE.Mesh(
    new THREE.SphereGeometry(0.5, 24, 24),
    new THREE.MeshBasicMaterial({ color: 0x888888 })
  );
  scene.add(mass);

  // E=mc² label
  const eqLabel = makeTextSprite('E = mc²', 0.8);
  eqLabel.position.set(0, 3.5, 0);
  scene.add(eqLabel);

  // Particles for explosion
  const particles = [];
  for (let i = 0; i < 80; i++) {
    const p = new THREE.Mesh(
      new THREE.SphereGeometry(0.06, 6, 6),
      new THREE.MeshBasicMaterial({ color: new THREE.Color().setHSL(0.08 + Math.random() * 0.1, 1, 0.6), transparent: true })
    );
    const angle = Math.random() * Math.PI * 2;
    const elev = (Math.random() - 0.5) * Math.PI;
    const speed = 1 + Math.random() * 3;
    p.userData = {
      vx: Math.cos(angle) * Math.cos(elev) * speed,
      vy: Math.sin(elev) * speed,
      vz: Math.sin(angle) * Math.cos(elev) * speed,
      life: 0
    };
    p.visible = false;
    scene.add(p);
    particles.push(p);
  }

  let phase = 0; // 0=mass visible, 1=exploding
  let phaseTime = 0;

  function animate() {
    if (!visibleChapters.has('ch8')) return;
    phaseTime += 0.016;
    const cycle = phaseTime % 6;

    if (cycle < 2) {
      // Show mass, pulsing
      mass.visible = true;
      mass.scale.setScalar(0.8 + 0.2 * Math.sin(phaseTime * 4));
      particles.forEach(p => { p.visible = false; p.position.set(0, 0, 0); p.userData.life = 0; });
    } else if (cycle >= 2 && cycle < 2.1) {
      // Trigger explosion
      mass.visible = false;
      particles.forEach(p => { p.visible = true; p.position.set(0, 0, 0); p.userData.life = 0; });
    } else {
      mass.visible = false;
      const et = cycle - 2;
      particles.forEach(p => {
        p.userData.life += 0.016;
        const t = p.userData.life;
        p.position.x += p.userData.vx * 0.016;
        p.position.y += p.userData.vy * 0.016;
        p.position.z += p.userData.vz * 0.016;
        p.material.opacity = Math.max(0, 1 - t * 0.4);
        p.scale.setScalar(1 + t * 0.5);
      });
    }

    composer.render();
  }
  chapterAnimators['ch8'] = animate;
}

/* ===================== CHAPTER 9: LENGTH CONTRACTION ===================== */
function initChapter9() {
  const kit = createSceneKit('tc9', { bg: 0x0a0512, camZ: 10 });
  if (!kit) return;
  const { scene, camera, renderer } = kit;

  // Spaceship at rest
  const shipGroup = new THREE.Group();
  const body = new THREE.Mesh(
    new THREE.BoxGeometry(3, 0.6, 0.6),
    new THREE.MeshBasicMaterial({ color: 0xccccdd })
  );
  shipGroup.add(body);
  const nose = new THREE.Mesh(
    new THREE.ConeGeometry(0.3, 0.8, 8),
    new THREE.MeshBasicMaterial({ color: 0xaaaacc })
  );
  nose.rotation.z = -Math.PI / 2;
  nose.position.x = 1.9;
  shipGroup.add(nose);
  scene.add(shipGroup);

  // Speed label
  const speedLabel = makeTextSprite('v = 0c', 0.5);
  speedLabel.position.set(0, -2.5, 0);
  scene.add(speedLabel);

  // Rest length reference
  const refLine = new THREE.Mesh(
    new THREE.PlaneGeometry(3, 0.02),
    new THREE.MeshBasicMaterial({ color: 0xf0c060, transparent: true, opacity: 0.3 })
  );
  refLine.position.set(0, -1.2, 0);
  scene.add(refLine);
  const refLabel = makeTextSprite('Rest length', 0.35);
  refLabel.position.set(0, -1.6, 0);
  scene.add(refLabel);

  let speed = 0;
  let dir = 1;

  function animate() {
    if (!visibleChapters.has('ch9')) return;
    speed += 0.003 * dir;
    if (speed > 0.95) dir = -1;
    if (speed < 0) { dir = 1; speed = 0; }

    const gamma = 1 / Math.sqrt(1 - speed * speed);
    const contraction = 1 / gamma;
    shipGroup.scale.x = contraction;

    // Update label — using sprite, can't change text easily, so just cycle color
    renderer.render(scene, camera);
  }
  chapterAnimators['ch9'] = animate;
}

/* ===================== CHAPTER 10: TWIN PARADOX ===================== */
function initChapter10() {
  const kit = createSceneKit('tc10', { bg: 0x0a0512, camZ: 12 });
  if (!kit) return;
  const { scene, camera, renderer } = kit;

  // Earth
  const earth = new THREE.Mesh(
    new THREE.SphereGeometry(0.8, 24, 24),
    new THREE.MeshBasicMaterial({ color: 0x3388cc })
  );
  earth.position.set(-3, -1, 0);
  scene.add(earth);
  const earthLabel = makeTextSprite('Earth', 0.4);
  earthLabel.position.set(-3, -2.5, 0);
  scene.add(earthLabel);

  // Star (destination)
  const star = new THREE.Mesh(
    new THREE.SphereGeometry(0.5, 16, 16),
    new THREE.MeshBasicMaterial({ color: 0xffcc44 })
  );
  star.position.set(4, 2, 0);
  scene.add(star);
  const starLabel = makeTextSprite('Distant Star', 0.35);
  starLabel.position.set(4, 0.8, 0);
  scene.add(starLabel);

  // Twin A (stays on earth) — simple icon
  const twinA = new THREE.Mesh(
    new THREE.SphereGeometry(0.2, 12, 12),
    new THREE.MeshBasicMaterial({ color: 0x88cc88 })
  );
  twinA.position.set(-3, 0.2, 0);
  scene.add(twinA);
  const twinALabel = makeTextSprite('Twin A', 0.3);
  twinALabel.position.set(-3, 1, 0);
  scene.add(twinALabel);

  // Twin B (travels)
  const twinB = new THREE.Mesh(
    new THREE.SphereGeometry(0.2, 12, 12),
    new THREE.MeshBasicMaterial({ color: 0xcc8888 })
  );
  twinB.position.set(-3, 0.2, 0);
  scene.add(twinB);

  // Travel path
  const pathPoints = [new THREE.Vector3(-3, 0.2, 0), new THREE.Vector3(0.5, 1.5, 0), new THREE.Vector3(4, 2, 0)];
  const travelCurve = new THREE.CatmullRomCurve3(pathPoints);
  const pathLine = new THREE.Line(
    new THREE.BufferGeometry().setFromPoints(travelCurve.getPoints(50)),
    new THREE.LineBasicMaterial({ color: 0xf0c060, transparent: true, opacity: 0.3 })
  );
  scene.add(pathLine);

  // Age counters as sprites
  const ageA = makeTextSprite('Age: 0', 0.3);
  ageA.position.set(-3, -3.5, 0);
  scene.add(ageA);
  const ageB = makeTextSprite('Age: 0', 0.3);
  ageB.position.set(-1, -3.5, 0);
  scene.add(ageB);

  let t = 0;
  function animate() {
    if (!visibleChapters.has('ch10')) return;
    t = (t + 0.002) % 1;

    // Twin B travels out and back
    const journeyT = t < 0.5 ? t * 2 : 2 - t * 2;
    const pos = travelCurve.getPointAt(journeyT);
    twinB.position.copy(pos);

    // Earth twin ages normally, traveling twin ages slowly
    twinA.scale.setScalar(1 + t * 0.5); // grows bigger = older

    renderer.render(scene, camera);
  }
  chapterAnimators['ch10'] = animate;
}

/* ===================== TEXT SPRITE HELPER ===================== */
function makeTextSprite(text, scale) {
  const canvas = document.createElement('canvas');
  const size = 512;
  canvas.width = size;
  canvas.height = 128;
  const ctx = canvas.getContext('2d');
  ctx.font = 'bold 48px Georgia';
  ctx.fillStyle = '#f0c060';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(text, size / 2, 64);
  const tex = new THREE.CanvasTexture(canvas);
  const mat = new THREE.SpriteMaterial({ map: tex, transparent: true });
  const sprite = new THREE.Sprite(mat);
  sprite.scale.set(scale * 4, scale, 1);
  return sprite;
}

/* ===================== INIT ALL ===================== */
initChapter1();
initChapter2();
initChapter3();
initChapter4();
initChapter5();
initChapter6();
initChapter7();
initChapter8();
initChapter9();
initChapter10();

/* ===================== ANIMATION LOOP ===================== */
function mainLoop() {
  requestAnimationFrame(mainLoop);
  globalTime += 0.016;
  for (const id of visibleChapters) {
    if (chapterAnimators[id]) chapterAnimators[id]();
  }
}
mainLoop();

/* ===================== LOADER ===================== */
const loaderBar = document.getElementById('loader-bar');
let loadProgress = 0;
const loadInterval = setInterval(() => {
  loadProgress += 5 + Math.random() * 10;
  if (loadProgress >= 100) {
    loadProgress = 100;
    clearInterval(loadInterval);
    setTimeout(() => document.getElementById('loader').classList.add('hidden'), 500);
  }
  loaderBar.style.width = loadProgress + '%';
}, 150);
</script>
</body>
</html>
