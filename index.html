<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<script type="importmap">{"imports":{"three":"https://unpkg.com/three@0.160.0/build/three.module.js","three/addons/":"https://unpkg.com/three@0.160.0/examples/jsm/"}}</script>
<title>Einstein's Relativity — A Pixar-Quality Interactive Journey</title>
<style>
/* ============================================================
   GLOBAL RESET & BASE
   ============================================================ */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth;overflow-x:hidden}
body{font-family:'Georgia','Times New Roman',serif;background:#12051f;color:#f0e8dc;overflow-x:hidden;line-height:1.7}

/* ============================================================
   LOADING SCREEN
   ============================================================ */
#loader{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#12051f 0%,#1a0a2e 50%,#12051f 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 1s ease,visibility 1s ease}
#loader.hidden{opacity:0;visibility:hidden;pointer-events:none}
#loader h2{color:#f0c060;font-size:1.6rem;margin-top:30px;letter-spacing:2px;animation:loaderPulse 1.5s ease-in-out infinite;text-shadow:0 0 20px rgba(240,180,80,.4)}
@keyframes loaderPulse{0%,100%{opacity:.6;transform:scale(1)}50%{opacity:1;transform:scale(1.05)}}
#loader-bar-wrap{width:260px;height:8px;background:rgba(255,255,255,.15);border-radius:4px;margin-top:20px;overflow:hidden}
#loader-bar{height:100%;width:0%;background:linear-gradient(90deg,#f0c060,#e88840,#c06030);border-radius:4px;transition:width .3s ease}

/* Bouncing Einstein loader */
.loader-einstein{width:100px;height:140px;position:relative;animation:loaderBounce 1s ease-in-out infinite}
@keyframes loaderBounce{0%,100%{transform:translateY(0) scaleX(1) scaleY(1)}30%{transform:translateY(-40px) scaleX(.95) scaleY(1.05)}50%{transform:translateY(-50px) scaleX(.95) scaleY(1.05)}80%{transform:translateY(0) scaleX(1.05) scaleY(.95)}90%{transform:translateY(0) scaleX(1) scaleY(1)}}
.loader-einstein svg{width:100%;height:100%}

/* ============================================================
   PROGRESS BAR (top)
   ============================================================ */
#progress-bar{position:fixed;top:0;left:0;height:4px;background:linear-gradient(90deg,#f0c060,#e88840,#d06838,#c05828);z-index:1000;transition:width .15s ease;border-radius:0 2px 2px 0;box-shadow:0 0 10px rgba(240,180,80,.5)}

/* ============================================================
   NAV DOTS
   ============================================================ */
#nav-dots{position:fixed;right:20px;top:50%;transform:translateY(-50%);z-index:900;display:flex;flex-direction:column;gap:14px}
.nav-dot{width:14px;height:14px;border-radius:50%;background:rgba(240,200,140,.25);cursor:pointer;transition:all .3s ease;position:relative;border:2px solid transparent}
.nav-dot:hover,.nav-dot.active{background:#f0c060;border-color:rgba(255,240,200,.8);transform:scale(1.3);box-shadow:0 0 12px rgba(240,180,80,.5)}
.nav-dot .tooltip{position:absolute;right:24px;top:50%;transform:translateY(-50%);background:rgba(20,10,30,.9);color:#f0c060;padding:4px 12px;border-radius:6px;font-size:.75rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s ease;backdrop-filter:blur(4px)}
.nav-dot:hover .tooltip{opacity:1}

/* ============================================================
   SCROLL INDICATOR
   ============================================================ */
#scroll-indicator{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);z-index:800;display:flex;flex-direction:column;align-items:center;gap:6px;opacity:1;transition:opacity .5s ease;pointer-events:none}
#scroll-indicator span{color:rgba(240,200,140,.6);font-size:.8rem;letter-spacing:1px}
#scroll-indicator .arrow{width:24px;height:24px;border-right:2px solid rgba(240,200,140,.6);border-bottom:2px solid rgba(240,200,140,.6);transform:rotate(45deg);animation:scrollBounce 2s ease-in-out infinite}
@keyframes scrollBounce{0%,100%{transform:rotate(45deg) translateY(0);opacity:.4}50%{transform:rotate(45deg) translateY(8px);opacity:1}}

/* ============================================================
   CHAPTER SECTIONS
   ============================================================ */
.chapter{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px 80px;position:relative;overflow:hidden}
.chapter .chapter-inner{opacity:0;transform:translateY(30px);transition:opacity 1s cubic-bezier(.25,.46,.45,.94),transform 1s cubic-bezier(.25,.46,.45,.94)}
.chapter.in-view .chapter-inner{opacity:1;transform:translateY(0)}
.chapter-inner{max-width:800px;width:100%;text-align:center;position:relative;z-index:2}
.chapter-number{font-size:.85rem;color:rgba(240,180,80,.7);letter-spacing:4px;text-transform:uppercase;margin-bottom:8px}
.chapter h2{font-size:2.4rem;color:#f0c060;margin-bottom:6px;text-shadow:0 0 30px rgba(240,180,80,.35),0 2px 4px rgba(0,0,0,.3);line-height:1.2}
.chapter h3{font-size:1.1rem;color:rgba(240,220,180,.45);font-weight:normal;font-style:italic;margin-bottom:30px}

/* Parallax background layer */
.chapter .bg-layer{position:absolute;inset:0;z-index:0;opacity:.3}

/* Chapter backgrounds — warm Ratatouille palette */
.ch-1{background:linear-gradient(180deg,#12051f 0%,#1a0a2e 30%,#22103a 50%,#1a0a2e 70%,#12051f 100%)}
.ch-2{background:linear-gradient(180deg,#0f0818 0%,#18102a 30%,#201638 50%,#18102a 70%,#0f0818 100%)}
.ch-3{background:linear-gradient(180deg,#100a1a 0%,#1c1230 30%,#261a3e 50%,#1c1230 70%,#100a1a 100%)}
.ch-4{background:#12051f}
.ch-5{background:linear-gradient(180deg,#0a0510 0%,#120a1e 30%,#180e28 50%,#120a1e 70%,#0a0510 100%)}
.ch-6{background:linear-gradient(180deg,#0e0a18 0%,#1a1430 30%,#221a3e 50%,#1a1430 70%,#0e0a18 100%)}
.ch-7{background:linear-gradient(180deg,#130a1c 0%,#221235 30%,#2e1a45 50%,#221235 70%,#130a1c 100%)}
.ch-8{background:linear-gradient(180deg,#180822 0%,#2a1040 30%,#381650 50%,#2a1040 70%,#180822 100%)}
.ch-9{background:linear-gradient(180deg,#0d0818 0%,#181028 30%,#201636 50%,#181028 70%,#0d0818 100%)}
.ch-10{background:linear-gradient(180deg,#150a22 0%,#24123a 30%,#301a4a 50%,#24123a 70%,#150a22 100%)}

/* ============================================================
   SPEECH BUBBLE
   ============================================================ */
.speech-bubble{background:rgba(40,20,55,.5);border:1px solid rgba(240,200,140,.15);border-radius:20px;padding:24px 30px;margin:20px auto;max-width:600px;position:relative;backdrop-filter:blur(8px);font-size:1.05rem;line-height:1.8;color:rgba(255,240,220,.85);text-align:left;box-shadow:0 4px 20px rgba(0,0,0,.3),inset 0 1px 0 rgba(240,200,140,.08)}
.speech-bubble::after{content:'';position:absolute;top:-12px;left:50%;transform:translateX(-50%);border:12px solid transparent;border-bottom-color:rgba(40,20,55,.5)}
.speech-bubble .typewriter{overflow:hidden;border-right:2px solid rgba(240,180,80,.6)}
.speech-bubble .typewriter.done{border-right-color:transparent}

/* ============================================================
   CANVAS
   ============================================================ */
.anim-canvas{width:100%;max-width:700px;height:400px;border-radius:16px;margin:20px auto;display:block;background:rgba(10,5,18,.5);box-shadow:0 8px 32px rgba(0,0,0,.5),inset 0 1px 0 rgba(240,200,140,.06),0 0 60px rgba(180,120,40,.06)}

/* ============================================================
   EINSTEIN SVG CHARACTER
   ============================================================ */
.einstein-wrap{width:200px;height:240px;margin:0 auto 10px;position:relative}
.einstein-svg{width:100%;height:100%;animation:einsteinBreathe 4s ease-in-out infinite}
@keyframes einsteinBreathe{0%,100%{transform:scaleY(1) scaleX(1)}50%{transform:scaleY(1.02) scaleX(.99)}}
.einstein-wrap .hair-strand{animation:hairSway 3s ease-in-out infinite alternate}
@keyframes hairSway{0%{transform:rotate(-3deg)}100%{transform:rotate(3deg)}}
.einstein-wrap .blink{animation:einsteinBlink 4s ease-in-out infinite}
@keyframes einsteinBlink{0%,42%,46%,100%{transform:scaleY(1)}44%{transform:scaleY(.1)}}

/* Pose transitions */
.einstein-wrap.squash{animation:squashStretch .5s ease}
@keyframes squashStretch{0%{transform:scaleY(1) scaleX(1)}30%{transform:scaleY(.8) scaleX(1.15)}60%{transform:scaleY(1.1) scaleX(.92)}100%{transform:scaleY(1) scaleX(1)}}

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media(max-width:768px){
  .chapter h2{font-size:1.8rem}
  .anim-canvas{height:280px}
  #nav-dots{right:8px;gap:10px}
  .nav-dot{width:10px;height:10px}
  .einstein-wrap{width:160px;height:190px}
  .speech-bubble{padding:16px 20px;font-size:.95rem}
}
</style>
</head>
<body>

<!-- ============================================================
     LOADING SCREEN
     ============================================================ -->
<div id="loader">
  <div class="loader-einstein">
    <svg viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
      <!-- Simplified loader Einstein — warm Pixar style -->
      <defs>
        <radialGradient id="loaderSkinGrad" cx="38%" cy="32%">
          <stop offset="0%" stop-color="#fde8cc"/>
          <stop offset="100%" stop-color="#dda868"/>
        </radialGradient>
      </defs>
      <circle cx="50" cy="65" r="50" fill="rgba(240,180,80,.05)"/>
      <ellipse cx="50" cy="50" rx="28" ry="32" fill="url(#loaderSkinGrad)"/>
      <!-- Hair -->
      <path d="M22 38 Q10 15 30 20 Q25 5 50 10 Q75 5 70 20 Q90 15 78 38" fill="#e8ddd0" stroke="rgba(180,170,150,.3)" stroke-width=".5"/>
      <path d="M20 42 Q8 30 18 25" fill="none" stroke="#e0d5c5" stroke-width="5" stroke-linecap="round"/>
      <path d="M80 42 Q92 30 82 25" fill="none" stroke="#e0d5c5" stroke-width="5" stroke-linecap="round"/>
      <!-- Eyes — big, warm -->
      <ellipse cx="38" cy="48" rx="9" ry="10" fill="white"/>
      <ellipse cx="62" cy="48" rx="9" ry="10" fill="white"/>
      <circle cx="39" cy="49" r="5" fill="#6b4420"/>
      <circle cx="63" cy="49" r="5" fill="#6b4420"/>
      <circle cx="39" cy="49" r="2.5" fill="#1a0e05"/>
      <circle cx="63" cy="49" r="2.5" fill="#1a0e05"/>
      <circle cx="41" cy="46" r="2" fill="white" opacity=".9"/>
      <circle cx="65" cy="46" r="2" fill="white" opacity=".9"/>
      <circle cx="37" cy="51" r="1" fill="white" opacity=".5"/>
      <circle cx="61" cy="51" r="1" fill="white" opacity=".5"/>
      <!-- Eyebrows -->
      <path d="M28 38 Q38 32 48 37" fill="none" stroke="rgba(140,110,70,.7)" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M52 37 Q62 32 72 38" fill="none" stroke="rgba(140,110,70,.7)" stroke-width="2.5" stroke-linecap="round"/>
      <!-- Nose & mouth -->
      <path d="M46 57 Q50 63 54 57" fill="none" stroke="rgba(180,120,70,.5)" stroke-width="1.5" stroke-linecap="round"/>
      <path d="M38 68 Q50 76 62 68" fill="none" stroke="rgba(180,110,70,.6)" stroke-width="2" stroke-linecap="round"/>
      <!-- Rosy cheeks -->
      <circle cx="26" cy="58" r="7" fill="#ff9988" opacity=".3"/>
      <circle cx="74" cy="58" r="7" fill="#ff9988" opacity=".3"/>
      <!-- Mustache -->
      <path d="M36 63 Q43 60 50 65 Q57 60 64 63" fill="rgba(180,170,155,.8)" stroke="rgba(150,140,125,.4)" stroke-width=".5"/>
      <!-- Body -->
      <rect x="30" y="82" width="40" height="50" rx="8" fill="#f0e4d0" stroke="rgba(180,150,110,.3)" stroke-width=".5"/>
      <!-- Bowtie -->
      <polygon points="44,86 50,90 56,86 56,94 50,90 44,94" fill="#8b2020"/>
      <circle cx="50" cy="90" r="2.5" fill="#c83838"/>
    </svg>
  </div>
  <h2>Warming Up the Universe...</h2>
  <div id="loader-bar-wrap"><div id="loader-bar"></div></div>
</div>

<!-- ============================================================
     PROGRESS BAR
     ============================================================ -->
<div id="progress-bar"></div>

<!-- ============================================================
     NAV DOTS
     ============================================================ -->
<div id="nav-dots"></div>

<!-- ============================================================
     SCROLL INDICATOR
     ============================================================ -->
<div id="scroll-indicator">
  <span>SCROLL DOWN</span>
  <div class="arrow"></div>
</div>

<!-- ============================================================
     CHAPTER 1: WHAT IS GRAVITY?
     ============================================================ -->
<section class="chapter ch-1" id="ch1" data-title="What is Gravity?">
  <div class="chapter-inner">
    <div class="einstein-wrap" id="einstein-1"></div>
    <span class="chapter-number">Chapter I</span>
    <h2>What is Gravity?</h2>
    <h3>Newton's apple meets Einstein's curved spacetime</h3>
    <canvas class="anim-canvas" id="canvas1"></canvas>
    <div class="speech-bubble">
      <div class="typewriter" data-text="Gravity isn't a force pulling you down — it's the curvature of spacetime itself! Imagine a bowling ball on a trampoline. Everything nearby rolls toward it, not because of a mysterious pull, but because the fabric of space is bent."></div>
    </div>
  </div>
</section>

<!-- ============================================================
     CHAPTER 2: THE FABRIC OF SPACE-TIME
     ============================================================ -->
<section class="chapter ch-2" id="ch2" data-title="The Fabric of Space-Time">
  <div class="chapter-inner">
    <div class="einstein-wrap" id="einstein-2"></div>
    <span class="chapter-number">Chapter II</span>
    <h2>The Fabric of Space-Time</h2>
    <h3>Move your mouse to warp the universe</h3>
    <canvas class="anim-canvas" id="canvas2"></canvas>
    <div class="speech-bubble">
      <div class="typewriter" data-text="Space and time aren't separate — they're woven together into a single fabric. Massive objects like stars and planets create dips in this fabric. Touch the grid gently and watch spacetime curve beneath your finger — like pressing on a soft rubber sheet."></div>
    </div>
  </div>
</section>

<!-- ============================================================
     CHAPTER 3: TIME SLOWS DOWN
     ============================================================ -->
<section class="chapter ch-3" id="ch3" data-title="Time Slows Down">
  <div class="chapter-inner">
    <div class="einstein-wrap" id="einstein-3"></div>
    <span class="chapter-number">Chapter III</span>
    <h2>Time Slows Down</h2>
    <h3>Gravitational time dilation in action</h3>
    <canvas class="anim-canvas" id="canvas3"></canvas>
    <div class="speech-bubble">
      <div class="typewriter" data-text="Near a massive object, time literally runs slower! A clock near a black hole ticks much more slowly than one floating in deep space. This isn't science fiction — GPS satellites must account for this effect every single day."></div>
    </div>
  </div>
</section>

<!-- ============================================================
     CHAPTER 4: LIGHT BENDS
     ============================================================ -->
<section class="chapter ch-4" id="ch4" data-title="Light Bends">
  <div class="chapter-inner">
    <div class="einstein-wrap" id="einstein-4"></div>
    <span class="chapter-number">Chapter IV</span>
    <h2>Light Bends</h2>
    <h3>Gravitational lensing & Einstein rings</h3>
    <div class="anim-canvas" id="tc4" style="position:relative;overflow:hidden"></div>
    <div class="speech-bubble">
      <div class="typewriter" data-text="Even light follows the curves of spacetime! When light from a distant star passes near a massive object, it bends — creating beautiful rings and arcs. This effect, called gravitational lensing, was the first proof of General Relativity!"></div>
    </div>
  </div>
</section>

<!-- ============================================================
     CHAPTER 5: BLACK HOLES
     ============================================================ -->
<section class="chapter ch-5" id="ch5" data-title="Black Holes">
  <div class="chapter-inner">
    <div class="einstein-wrap" id="einstein-5"></div>
    <span class="chapter-number">Chapter V</span>
    <h2>Black Holes</h2>
    <h3>Where spacetime curves to infinity</h3>
    <div class="anim-canvas" id="tc5" style="position:relative;overflow:hidden"></div>
    <div class="speech-bubble">
      <div class="typewriter" data-text="When a massive star collapses, it creates a region where gravity is so strong that nothing — not even light — can escape. The boundary is called the event horizon. Beyond it, the known laws of physics break down entirely!"></div>
    </div>
  </div>
</section>

<!-- ============================================================
     CHAPTER 6: GRAVITATIONAL WAVES
     ============================================================ -->
<section class="chapter ch-6" id="ch6" data-title="Gravitational Waves">
  <div class="chapter-inner">
    <div class="einstein-wrap" id="einstein-6"></div>
    <span class="chapter-number">Chapter VI</span>
    <h2>Gravitational Waves</h2>
    <h3>Ripples in the fabric of spacetime</h3>
    <canvas class="anim-canvas" id="canvas6"></canvas>
    <div class="speech-bubble">
      <div class="typewriter" data-text="When massive objects accelerate — like two black holes spiraling together — they send ripples through spacetime itself. Einstein predicted these waves in 1916, and we finally detected them in 2015. The universe literally rings like a bell!"></div>
    </div>
  </div>
</section>

<!-- ============================================================
     CHAPTER 7: SPEED OF LIGHT
     ============================================================ -->
<section class="chapter ch-7" id="ch7" data-title="Speed of Light">
  <div class="chapter-inner">
    <div class="einstein-wrap" id="einstein-7"></div>
    <span class="chapter-number">Chapter VII</span>
    <h2>Speed of Light</h2>
    <h3>The cosmic speed limit: 299,792,458 m/s</h3>
    <canvas class="anim-canvas" id="canvas7"></canvas>
    <div class="speech-bubble">
      <div class="typewriter" data-text="Nothing can travel faster than light — it's the ultimate speed limit of the universe! As you approach light speed, bizarre things happen: time slows, length contracts, and your mass effectively increases toward infinity. The faster you go, the harder it gets!"></div>
    </div>
  </div>
</section>

<!-- ============================================================
     CHAPTER 8: E = mc²
     ============================================================ -->
<section class="chapter ch-8" id="ch8" data-title="E = mc²">
  <div class="chapter-inner">
    <div class="einstein-wrap" id="einstein-8"></div>
    <span class="chapter-number">Chapter VIII</span>
    <h2>E = mc²</h2>
    <h3>The most famous equation in history</h3>
    <canvas class="anim-canvas" id="canvas8"></canvas>
    <div class="speech-bubble">
      <div class="typewriter" data-text="Mass and energy are the same thing! A tiny amount of mass contains an enormous amount of energy — because you multiply by the speed of light squared. This is what powers the Sun, nuclear reactors, and yes... nuclear weapons."></div>
    </div>
  </div>
</section>

<!-- ============================================================
     CHAPTER 9: LENGTH CONTRACTION
     ============================================================ -->
<section class="chapter ch-9" id="ch9" data-title="Length Contraction">
  <div class="chapter-inner">
    <div class="einstein-wrap" id="einstein-9"></div>
    <span class="chapter-number">Chapter IX</span>
    <h2>Length Contraction</h2>
    <h3>Objects shrink at relativistic speeds</h3>
    <canvas class="anim-canvas" id="canvas9"></canvas>
    <div class="speech-bubble">
      <div class="typewriter" data-text="As an object moves faster, it actually gets shorter in the direction of motion! At 90% the speed of light, a spaceship would appear squished to less than half its resting length. Space itself contracts — the destination gets closer!"></div>
    </div>
  </div>
</section>

<!-- ============================================================
     CHAPTER 10: THE TWIN PARADOX
     ============================================================ -->
<section class="chapter ch-10" id="ch10" data-title="The Twin Paradox">
  <div class="chapter-inner">
    <div class="einstein-wrap" id="einstein-10"></div>
    <span class="chapter-number">Chapter X</span>
    <h2>The Twin Paradox</h2>
    <h3>One twin ages while the other stays young</h3>
    <canvas class="anim-canvas" id="canvas10"></canvas>
    <div class="speech-bubble">
      <div class="typewriter" data-text="Imagine twins: one stays on Earth, the other travels near light speed to a distant star and back. When the traveler returns, they've barely aged — while their twin is now old and gray. This isn't a paradox at all — it's real physics, confirmed by experiments!"></div>
    </div>
  </div>
</section>

<script>
/* ============================================================
   UTILITY FUNCTIONS
   ============================================================ */
const ease = {
  inOut: t => t < .5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2,
  out: t => 1 - Math.pow(1-t,3),
  in: t => t*t*t,
  elastic: t => t===0?0:t===1?1:Math.pow(2,-10*t)*Math.sin((t-0.1)*5*Math.PI)+1,
  bounce: t => {const n=7.5625,d=2.75;if(t<1/d)return n*t*t;if(t<2/d)return n*(t-=1.5/d)*t+.75;if(t<2.5/d)return n*(t-=2.25/d)*t+.9375;return n*(t-=2.625/d)*t+.984375}
};
function lerp(a,b,t){return a+(b-a)*t}
function clamp(v,min,max){return Math.max(min,Math.min(max,v))}
function dist(x1,y1,x2,y2){return Math.hypot(x2-x1,y2-y1)}
function rand(a,b){return a+Math.random()*(b-a)}
function randInt(a,b){return Math.floor(rand(a,b+1))}

/* ============================================================
   EINSTEIN SVG GENERATOR
   ============================================================ */
function createEinstein(containerId, pose='wave') {
  const c = document.getElementById(containerId);
  if(!c) return;
  /* Each pose defines: shoulder positions, elbow positions, wrist positions,
     hand type (wave/point/open/chin/fist), eyebrow shapes, mouth shape */
  const poses = {
    wave: {
      lShoulder:[22,92], lElbow:[12,78], lWrist:[16,66], lHandType:'open',
      rShoulder:[78,92], rElbow:[92,72], rWrist:[88,54], rHandType:'wave',
      brow1:'M26,36 Q37,28 48,35', brow2:'M52,35 Q63,28 74,36',
      mouth:'M36,69 Q50,79 64,69', mouthFill:true
    },
    point: {
      lShoulder:[22,92], lElbow:[16,100], lWrist:[12,96], lHandType:'open',
      rShoulder:[78,92], rElbow:[94,80], rWrist:[104,68], rHandType:'point',
      brow1:'M26,37 Q37,31 48,36', brow2:'M52,36 Q63,28 74,34',
      mouth:'M40,68 Q50,74 60,68', mouthFill:false
    },
    think: {
      lShoulder:[22,92], lElbow:[28,78], lWrist:[38,68], lHandType:'chin',
      rShoulder:[78,92], rElbow:[84,100], rWrist:[80,96], rHandType:'fist',
      brow1:'M26,39 Q37,31 48,37', brow2:'M52,34 Q63,26 74,35',
      mouth:'M42,68 Q50,71 58,68', mouthFill:false
    },
    excited: {
      lShoulder:[22,92], lElbow:[8,72], lWrist:[16,54], lHandType:'open',
      rShoulder:[78,92], rElbow:[92,72], rWrist:[84,54], rHandType:'open',
      brow1:'M26,33 Q37,24 48,33', brow2:'M52,33 Q63,24 74,33',
      mouth:'M34,67 Q50,82 66,67', mouthFill:true
    },
    mindblown: {
      lShoulder:[22,92], lElbow:[6,66], lWrist:[18,48], lHandType:'open',
      rShoulder:[78,92], rElbow:[94,66], rWrist:[82,48], rHandType:'open',
      brow1:'M26,30 Q37,20 48,30', brow2:'M52,30 Q63,20 74,30',
      mouth:'M38,67 Q50,80 62,67', mouthFill:true
    },
    curious: {
      lShoulder:[22,92], lElbow:[14,94], lWrist:[18,86], lHandType:'fist',
      rShoulder:[78,92], rElbow:[90,84], rWrist:[84,76], rHandType:'open',
      brow1:'M26,35 Q37,26 48,34', brow2:'M52,37 Q63,32 74,39',
      mouth:'M42,68 Q50,73 58,69', mouthFill:false
    },
    explain: {
      lShoulder:[22,92], lElbow:[10,84], lWrist:[14,74], lHandType:'open',
      rShoulder:[78,92], rElbow:[94,80], rWrist:[92,70], rHandType:'open',
      brow1:'M26,36 Q37,30 48,35', brow2:'M52,35 Q63,30 74,36',
      mouth:'M36,68 Q50,77 64,68', mouthFill:true
    },
    wonder: {
      lShoulder:[22,92], lElbow:[16,88], lWrist:[20,80], lHandType:'open',
      rShoulder:[78,92], rElbow:[84,88], rWrist:[80,80], rHandType:'open',
      brow1:'M26,33 Q37,25 48,33', brow2:'M52,33 Q63,25 74,33',
      mouth:'M42,67 Q50,75 58,67', mouthFill:false
    },
    proud: {
      lShoulder:[22,92], lElbow:[10,96], lWrist:[14,88], lHandType:'fist',
      rShoulder:[78,92], rElbow:[90,96], rWrist:[86,88], rHandType:'fist',
      brow1:'M26,36 Q37,30 48,36', brow2:'M52,36 Q63,30 74,36',
      mouth:'M34,67 Q50,80 66,67', mouthFill:true
    },
    present: {
      lShoulder:[22,92], lElbow:[10,82], lWrist:[12,72], lHandType:'open',
      rShoulder:[78,92], rElbow:[96,78], rWrist:[98,66], rHandType:'open',
      brow1:'M26,35 Q37,28 48,35', brow2:'M52,35 Q63,28 74,35',
      mouth:'M36,68 Q50,78 64,68', mouthFill:true
    }
  };
  const p = poses[pose]||poses.wave;
  const [lsx,lsy]=p.lShoulder,[lex,ley]=p.lElbow,[lwx,lwy]=p.lWrist;
  const [rsx,rsy]=p.rShoulder,[rex,rey]=p.rElbow,[rwx,rwy]=p.rWrist;

  /* Generate hand SVG based on type */
  function handSVG(wx,wy,ex,ey,type,id,isLeft){
    // Hand direction = wrist - elbow normalized
    const dx=wx-ex, dy=wy-ey;
    const len=Math.sqrt(dx*dx+dy*dy)||1;
    const nx=dx/len, ny=dy/len;
    // Perpendicular
    const px=-ny, py=nx;
    const s=isLeft?1:-1;
    if(type==='wave'){
      // Open hand with spread fingers, waving
      return `<g filter="url(#softShadow${id})">
        <ellipse cx="${wx}" cy="${wy}" rx="5.5" ry="6.5" fill="#f5d0a0" stroke="#ddb070" stroke-width=".4"
          transform="rotate(${Math.atan2(dy,dx)*180/Math.PI+90},${wx},${wy})"/>
        <path d="M${wx+px*3},${wy+py*3} Q${wx+px*4+nx*7},${wy+py*4+ny*7} ${wx+px*2+nx*11},${wy+py*2+ny*11}"
          fill="none" stroke="#f0c890" stroke-width="2.2" stroke-linecap="round"/>
        <path d="M${wx+px*1},${wy+py*1} Q${wx+px*1.5+nx*8},${wy+py*1.5+ny*8} ${wx+px*.5+nx*13},${wy+py*.5+ny*13}"
          fill="none" stroke="#f0c890" stroke-width="2" stroke-linecap="round"/>
        <path d="M${wx-px*1},${wy-py*1} Q${wx-px*1+nx*8},${wy-py*1+ny*8} ${wx-px*1.5+nx*12},${wy-py*1.5+ny*12}"
          fill="none" stroke="#f0c890" stroke-width="2" stroke-linecap="round"/>
        <path d="M${wx-px*3},${wy-py*3} Q${wx-px*3.5+nx*6},${wy-py*3.5+ny*6} ${wx-px*4+nx*9},${wy-py*4+ny*9}"
          fill="none" stroke="#f0c890" stroke-width="1.8" stroke-linecap="round"/>
      </g>`;
    } else if(type==='point'){
      return `<g filter="url(#softShadow${id})">
        <ellipse cx="${wx}" cy="${wy}" rx="5" ry="6" fill="#f5d0a0" stroke="#ddb070" stroke-width=".4"
          transform="rotate(${Math.atan2(dy,dx)*180/Math.PI+90},${wx},${wy})"/>
        <path d="M${wx+px*.5},${wy+py*.5} L${wx+px*.5+nx*14},${wy+py*.5+ny*14}"
          fill="none" stroke="#f0c890" stroke-width="2.5" stroke-linecap="round"/>
        <path d="M${wx+px*2.5},${wy+py*2.5} Q${wx+px*3+nx*3},${wy+py*3+ny*3} ${wx+px*2+nx*4},${wy+py*2+ny*4}"
          fill="none" stroke="#f0c890" stroke-width="2" stroke-linecap="round"/>
        <path d="M${wx-px*2},${wy-py*2} Q${wx-px*2.5+nx*3},${wy-py*2.5+ny*3} ${wx-px*2+nx*4},${wy-py*2+ny*4}"
          fill="none" stroke="#f0c890" stroke-width="2" stroke-linecap="round"/>
      </g>`;
    } else if(type==='chin'){
      return `<g filter="url(#softShadow${id})">
        <ellipse cx="${wx}" cy="${wy}" rx="6" ry="5" fill="#f5d0a0" stroke="#ddb070" stroke-width=".4"/>
        <path d="M${wx-4},${wy-3} Q${wx-3},${wy-7} ${wx},${wy-5}" fill="none" stroke="#eac080" stroke-width="1.8" stroke-linecap="round"/>
        <path d="M${wx+1},${wy-5} Q${wx+4},${wy-7} ${wx+4},${wy-3}" fill="none" stroke="#eac080" stroke-width="1.8" stroke-linecap="round"/>
      </g>`;
    } else if(type==='fist'){
      return `<g filter="url(#softShadow${id})">
        <ellipse cx="${wx}" cy="${wy}" rx="5.5" ry="5" fill="#f5d0a0" stroke="#ddb070" stroke-width=".4"/>
        <path d="M${wx-3},${wy-2} Q${wx},${wy-5} ${wx+3},${wy-2}" fill="none" stroke="#eac080" stroke-width="1" stroke-linecap="round"/>
        <ellipse cx="${wx}" cy="${wy}" rx="3" ry="2.5" fill="rgba(255,220,180,.2)"/>
      </g>`;
    } else { // 'open' - relaxed open palm with finger detail
      return `<g filter="url(#softShadow${id})">
        <ellipse cx="${wx}" cy="${wy}" rx="5.5" ry="6" fill="#f5d0a0" stroke="#ddb070" stroke-width=".4"
          transform="rotate(${Math.atan2(dy,dx)*180/Math.PI+90},${wx},${wy})"/>
        <!-- Individual fingers with joints -->
        <path d="M${wx+px*3},${wy+py*3} Q${wx+px*3.5+nx*5},${wy+py*3.5+ny*5} ${wx+px*2.5+nx*9},${wy+py*2.5+ny*9}"
          fill="none" stroke="#f0c890" stroke-width="1.6" stroke-linecap="round"/>
        <path d="M${wx+px*1.5},${wy+py*1.5} Q${wx+px*1.8+nx*6},${wy+py*1.8+ny*6} ${wx+px*1+nx*10.5},${wy+py*1+ny*10.5}"
          fill="none" stroke="#f0c890" stroke-width="1.8" stroke-linecap="round"/>
        <path d="M${wx-px*.5},${wy-py*.5} Q${wx-px*.3+nx*6.5},${wy-py*.3+ny*6.5} ${wx-px*.8+nx*10},${wy-py*.8+ny*10}"
          fill="none" stroke="#f0c890" stroke-width="1.8" stroke-linecap="round"/>
        <path d="M${wx-px*2.5},${wy-py*2.5} Q${wx-px*2.8+nx*5},${wy-py*2.8+ny*5} ${wx-px*2.5+nx*8},${wy-py*2.5+ny*8}"
          fill="none" stroke="#f0c890" stroke-width="1.5" stroke-linecap="round"/>
        <!-- Thumb -->
        <path d="M${wx+px*4},${wy+py*4} Q${wx+px*5.5+nx*2},${wy+py*5.5+ny*2} ${wx+px*5+nx*5},${wy+py*5+ny*5}"
          fill="none" stroke="#f0c890" stroke-width="1.8" stroke-linecap="round"/>
        <!-- Knuckle creases -->
        <path d="M${wx+px*2.5+nx*3},${wy+py*2.5+ny*3} L${wx-px*2+nx*3},${wy-py*2+ny*3}"
          fill="none" stroke="rgba(180,130,70,.12)" stroke-width=".4"/>
        <!-- Vein hints on back of hand -->
        <path d="M${wx+px*1},${wy+py*1} Q${wx+px*.5+nx*2},${wy+py*.5+ny*2} ${wx+nx*4},${wy+ny*4}"
          fill="none" stroke="rgba(120,140,180,.06)" stroke-width=".5"/>
        <path d="M${wx-px*1},${wy-py*1} Q${wx-px*1.5+nx*2},${wy-py*1.5+ny*2} ${wx-px*.5+nx*4},${wy-py*.5+ny*4}"
          fill="none" stroke="rgba(120,140,180,.05)" stroke-width=".4"/>
        <ellipse cx="${wx}" cy="${wy}" rx="3" ry="3.5" fill="rgba(255,220,180,.15)"
          transform="rotate(${Math.atan2(dy,dx)*180/Math.PI+90},${wx},${wy})"/>
      </g>`;
    }
  }

  /* Generate arm with sleeve (upper arm + forearm as filled bezier shapes) */
  function armSVG(sx,sy,ex,ey,wx,wy,id){
    // Upper arm: shoulder to elbow — tapered sleeve
    const ua_dx=ex-sx, ua_dy=ey-sy, ua_len=Math.sqrt(ua_dx*ua_dx+ua_dy*ua_dy)||1;
    const ua_px=-ua_dy/ua_len, ua_py=ua_dx/ua_len;
    const fa_dx=wx-ex, fa_dy=wy-ey, fa_len=Math.sqrt(fa_dx*fa_dx+fa_dy*fa_dy)||1;
    const fa_px=-fa_dy/fa_len, fa_py=fa_dx/fa_len;
    const sw1=6.5, sw2=5.5, sw3=4.5; // taper widths
    return `
      <!-- Upper arm sleeve -->
      <path d="M${sx+ua_px*sw1},${sy+ua_py*sw1}
               C${sx+ua_px*sw1+ua_dx*.3},${sy+ua_py*sw1+ua_dy*.3}
                ${ex+ua_px*sw2-ua_dx*.1},${ey+ua_py*sw2-ua_dy*.1}
                ${ex+ua_px*sw2},${ey+ua_py*sw2}
               L${ex-ua_px*sw2},${ey-ua_py*sw2}
               C${ex-ua_px*sw2-ua_dx*.1},${ey-ua_py*sw2-ua_dy*.1}
                ${sx-ua_px*sw1+ua_dx*.3},${sy-ua_py*sw1+ua_dy*.3}
                ${sx-ua_px*sw1},${sy-ua_py*sw1}Z"
            fill="url(#coatGrad${id})" stroke="rgba(180,150,110,.25)" stroke-width=".4"/>
      <!-- Sleeve shadow crease -->
      <path d="M${sx},${sy} Q${(sx+ex)/2+ua_px*1.5},${(sy+ey)/2+ua_py*1.5} ${ex},${ey}"
            fill="none" stroke="rgba(160,120,70,.12)" stroke-width="1.5"/>
      <!-- Forearm sleeve (slightly narrower, cuff at end) -->
      <path d="M${ex+fa_px*sw2},${ey+fa_py*sw2}
               C${ex+fa_px*sw2+fa_dx*.3},${ey+fa_py*sw2+fa_dy*.3}
                ${wx+fa_px*sw3-fa_dx*.1},${wy+fa_py*sw3-fa_dy*.1}
                ${wx+fa_px*sw3},${wy+fa_py*sw3}
               L${wx-fa_px*sw3},${wy-fa_py*sw3}
               C${wx-fa_px*sw3-fa_dx*.1},${wy-fa_py*sw3-fa_dy*.1}
                ${ex-fa_px*sw2+fa_dx*.3},${ey-fa_py*sw2+fa_dy*.3}
                ${ex-fa_px*sw2},${ey-fa_py*sw2}Z"
            fill="url(#coatGrad${id})" stroke="rgba(180,150,110,.2)" stroke-width=".3"/>
      <!-- Cuff line -->
      <line x1="${wx+fa_px*sw3}" y1="${wy+fa_py*sw3}" x2="${wx-fa_px*sw3}" y2="${wy-fa_py*sw3}"
            stroke="rgba(180,150,110,.3)" stroke-width=".8"/>
      <!-- Elbow joint shadow (subtle circle) -->
      <circle cx="${ex}" cy="${ey}" r="3" fill="rgba(180,150,110,.08)"/>`;
  }

  const lArmSVG = armSVG(lsx,lsy,lex,ley,lwx,lwy,containerId);
  const rArmSVG = armSVG(rsx,rsy,rex,rey,rwx,rwy,containerId);
  const lHandSVG = handSVG(lwx,lwy,lex,ley,p.lHandType,containerId,true);
  const rHandSVG = handSVG(rwx,rwy,rex,rey,p.rHandType,containerId,false);
  const mouthPath = p.mouthFill
    ? `<path d="${p.mouth}" fill="rgba(120,50,30,.15)" stroke="rgba(180,110,70,.6)" stroke-width="1.8" stroke-linecap="round"/>`
    : `<path d="${p.mouth}" fill="none" stroke="rgba(180,110,70,.6)" stroke-width="1.8" stroke-linecap="round"/>`;

  c.innerHTML = `<svg class="einstein-svg" viewBox="-15 -15 130 160" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="skinGrad${containerId}" cx="38%" cy="32%">
        <stop offset="0%" stop-color="#fde8cc"/><stop offset="20%" stop-color="#f8dab8"/>
        <stop offset="50%" stop-color="#f0c898"/><stop offset="80%" stop-color="#dba56a"/>
        <stop offset="100%" stop-color="#c48a48"/>
      </radialGradient>
      <radialGradient id="skinShadow${containerId}" cx="58%" cy="68%">
        <stop offset="0%" stop-color="transparent"/><stop offset="50%" stop-color="transparent"/>
        <stop offset="100%" stop-color="rgba(140,75,30,.18)"/>
      </radialGradient>
      <radialGradient id="cheekGrad${containerId}" cx="50%" cy="40%">
        <stop offset="0%" stop-color="#ff8877" stop-opacity=".55"/><stop offset="100%" stop-color="#ff8877" stop-opacity="0"/>
      </radialGradient>
      <linearGradient id="coatGrad${containerId}" x1="0" y1="0" x2=".15" y2="1">
        <stop offset="0%" stop-color="#fffcf5"/><stop offset="30%" stop-color="#f5ece0"/>
        <stop offset="70%" stop-color="#e8dcc8"/><stop offset="100%" stop-color="#d0c0a8"/>
      </linearGradient>
      <radialGradient id="hairGrad${containerId}" cx="50%" cy="35%">
        <stop offset="0%" stop-color="#faf6f0"/><stop offset="30%" stop-color="#e8e0d4"/>
        <stop offset="70%" stop-color="#d0c8b8"/><stop offset="100%" stop-color="#b8ac98"/>
      </radialGradient>
      <radialGradient id="eyeWhite${containerId}" cx="42%" cy="38%">
        <stop offset="0%" stop-color="#ffffff"/><stop offset="80%" stop-color="#f5ede5"/><stop offset="100%" stop-color="#e8ddd0"/>
      </radialGradient>
      <!-- Multi-layer iris gradient (6 stops for photorealism) -->
      <radialGradient id="irisGrad${containerId}" cx="40%" cy="36%">
        <stop offset="0%" stop-color="#c8a050"/><stop offset="15%" stop-color="#a08040"/>
        <stop offset="35%" stop-color="#7b5828"/><stop offset="55%" stop-color="#5a3818"/>
        <stop offset="80%" stop-color="#3a2010"/><stop offset="100%" stop-color="#2a1808"/>
      </radialGradient>
      <!-- Secondary iris ring gradient -->
      <radialGradient id="irisInner${containerId}" cx="45%" cy="40%">
        <stop offset="0%" stop-color="#d4a848" stop-opacity=".4"/><stop offset="50%" stop-color="#8a6030" stop-opacity=".2"/>
        <stop offset="100%" stop-color="#5a3818" stop-opacity="0"/>
      </radialGradient>
      <filter id="softShadow${containerId}"><feDropShadow dx="0" dy="1.5" stdDeviation="2.5" flood-color="rgba(60,30,5,.22)"/></filter>
      <filter id="charShadow${containerId}"><feDropShadow dx="1" dy="3" stdDeviation="4" flood-color="rgba(40,20,0,.18)"/></filter>
      <!-- Skin texture noise filter -->
      <filter id="skinTexture${containerId}" x="-5%" y="-5%" width="110%" height="110%">
        <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" seed="2" result="noise"/>
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="0.8" xChannelSelector="R" yChannelSelector="G"/>
      </filter>
      <!-- Fabric weave texture filter -->
      <filter id="fabricTexture${containerId}" x="-2%" y="-2%" width="104%" height="104%">
        <feTurbulence type="turbulence" baseFrequency="1.2 0.8" numOctaves="2" seed="5" result="weave"/>
        <feDisplacementMap in="SourceGraphic" in2="weave" scale="0.4" xChannelSelector="R" yChannelSelector="G"/>
      </filter>
      <!-- Pore texture pattern for skin micro-detail -->
      <pattern id="porePattern${containerId}" width="4" height="4" patternUnits="userSpaceOnUse">
        <circle cx="1" cy="1" r=".3" fill="rgba(140,90,40,.04)"/>
        <circle cx="3" cy="3" r=".25" fill="rgba(140,90,40,.03)"/>
        <circle cx="2.5" cy="0.8" r=".2" fill="rgba(140,90,40,.025)"/>
        <circle cx="0.5" cy="2.5" r=".22" fill="rgba(140,90,40,.03)"/>
      </pattern>
      <!-- Stubble dot pattern for facial hair -->
      <pattern id="stubblePattern${containerId}" width="3" height="3" patternUnits="userSpaceOnUse">
        <circle cx="1" cy="1" r=".18" fill="rgba(100,70,35,.08)"/>
        <circle cx="2.5" cy="2" r=".15" fill="rgba(100,70,35,.06)"/>
        <circle cx="0.5" cy="2.8" r=".12" fill="rgba(100,70,35,.05)"/>
      </pattern>
      <!-- Fabric weave pattern for coat detail -->
      <pattern id="fabricWeave${containerId}" width="3" height="3" patternUnits="userSpaceOnUse">
        <line x1="0" y1="0" x2="3" y2="0" stroke="rgba(160,130,90,.04)" stroke-width=".3"/>
        <line x1="0" y1="1.5" x2="3" y2="1.5" stroke="rgba(160,130,90,.03)" stroke-width=".2"/>
        <line x1="0" y1="0" x2="0" y2="3" stroke="rgba(140,110,70,.03)" stroke-width=".2"/>
        <line x1="1.5" y1="0" x2="1.5" y2="3" stroke="rgba(140,110,70,.025)" stroke-width=".15"/>
      </pattern>
      <!-- Subsurface scattering glow -->
      <radialGradient id="sssEarL${containerId}" cx="80%" cy="50%">
        <stop offset="0%" stop-color="#ff9060" stop-opacity=".25"/><stop offset="100%" stop-color="#ff9060" stop-opacity="0"/>
      </radialGradient>
      <radialGradient id="sssEarR${containerId}" cx="20%" cy="50%">
        <stop offset="0%" stop-color="#ff9060" stop-opacity=".25"/><stop offset="100%" stop-color="#ff9060" stop-opacity="0"/>
      </radialGradient>
      <radialGradient id="sssNose${containerId}" cx="50%" cy="60%">
        <stop offset="0%" stop-color="#ffa070" stop-opacity=".18"/><stop offset="100%" stop-color="#ffa070" stop-opacity="0"/>
      </radialGradient>
      <radialGradient id="sssCheekL${containerId}" cx="50%" cy="50%">
        <stop offset="0%" stop-color="#ff8860" stop-opacity=".12"/><stop offset="100%" stop-color="#ff8860" stop-opacity="0"/>
      </radialGradient>
      <!-- Eyebag shadow gradient -->
      <radialGradient id="eyebagL${containerId}" cx="50%" cy="30%">
        <stop offset="0%" stop-color="rgba(120,70,40,.12)"/><stop offset="100%" stop-color="rgba(120,70,40,0)"/>
      </radialGradient>
      <radialGradient id="eyebagR${containerId}" cx="50%" cy="30%">
        <stop offset="0%" stop-color="rgba(120,70,40,.12)"/><stop offset="100%" stop-color="rgba(120,70,40,0)"/>
      </radialGradient>
      <!-- Double chin shadow -->
      <radialGradient id="doubleChin${containerId}" cx="50%" cy="20%">
        <stop offset="0%" stop-color="rgba(140,80,30,.1)"/><stop offset="100%" stop-color="rgba(140,80,30,0)"/>
      </radialGradient>
      <!-- Skin highlight gradients -->
      <radialGradient id="cheekHighL${containerId}" cx="40%" cy="35%">
        <stop offset="0%" stop-color="rgba(255,245,225,.2)"/><stop offset="100%" stop-color="rgba(255,245,225,0)"/>
      </radialGradient>
      <radialGradient id="cheekHighR${containerId}" cx="60%" cy="35%">
        <stop offset="0%" stop-color="rgba(255,245,225,.18)"/><stop offset="100%" stop-color="rgba(255,245,225,0)"/>
      </radialGradient>
      <radialGradient id="chinHigh${containerId}" cx="50%" cy="40%">
        <stop offset="0%" stop-color="rgba(255,240,220,.15)"/><stop offset="100%" stop-color="rgba(255,240,220,0)"/>
      </radialGradient>
      <filter id="charOutline${containerId}">
        <feMorphology in="SourceAlpha" result="expanded" operator="dilate" radius="1.2"/>
        <feFlood flood-color="rgba(40,25,10,.55)" result="color"/>
        <feComposite in="color" in2="expanded" operator="in" result="outline"/>
        <feMerge><feMergeNode in="outline"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <!-- Warm ambient glow -->
    <ellipse cx="50" cy="72" rx="60" ry="70" fill="rgba(240,180,80,.04)"/>

    <g filter="url(#charOutline${containerId})">
    <!-- === BODY — shaped torso with tapered waist === -->
    <g filter="url(#charShadow${containerId})">
      <path d="M24,88 C20,92 18,108 20,125 Q22,135 30,138 L70,138 Q78,135 80,125 C82,108 80,92 76,88
               Q68,83 50,81 Q32,83 24,88Z"
            fill="url(#coatGrad${containerId})" stroke="rgba(170,140,100,.35)" stroke-width=".5"/>
      <!-- Coat side shadows for 3D shape -->
      <path d="M24,88 C20,92 18,108 20,125 Q22,135 30,138 L35,138 Q30,120 28,100 Q26,90 30,86Z"
            fill="rgba(160,130,90,.1)"/>
      <path d="M76,88 C80,92 82,108 80,125 Q78,135 70,138 L65,138 Q70,120 72,100 Q74,90 70,86Z"
            fill="rgba(160,130,90,.1)"/>
      <!-- Collar / Lapels — V-shaped -->
      <path d="M34,86 Q42,82 50,84 L46,100 L38,94Z" fill="#f8f2e8" stroke="rgba(180,150,110,.3)" stroke-width=".4"/>
      <path d="M66,86 Q58,82 50,84 L54,100 L62,94Z" fill="#f8f2e8" stroke="rgba(180,150,110,.3)" stroke-width=".4"/>
      <!-- Lapel fold shadow -->
      <path d="M46,100 L50,84" fill="none" stroke="rgba(160,120,70,.12)" stroke-width=".8"/>
      <path d="M54,100 L50,84" fill="none" stroke="rgba(160,120,70,.12)" stroke-width=".8"/>
      <!-- Center seam -->
      <path d="M50,100 L50,136" fill="none" stroke="rgba(160,120,70,.12)" stroke-width=".8"/>
      <!-- Coat fold creases -->
      <path d="M30,96 Q34,110 32,125" fill="none" stroke="rgba(160,120,70,.1)" stroke-width=".7"/>
      <path d="M70,96 Q66,110 68,125" fill="none" stroke="rgba(160,120,70,.1)" stroke-width=".7"/>
      <path d="M36,92 Q38,104 36,118" fill="none" stroke="rgba(160,120,70,.07)" stroke-width=".5"/>
      <path d="M64,92 Q62,104 64,118" fill="none" stroke="rgba(160,120,70,.07)" stroke-width=".5"/>
      <!-- Coat hem shadow -->
      <path d="M28,136 Q50,140 72,136" fill="none" stroke="rgba(140,100,50,.12)" stroke-width="1"/>
      <!-- Fabric weave texture overlay -->
      <path d="M24,88 C20,92 18,108 20,125 Q22,135 30,138 L70,138 Q78,135 80,125 C82,108 80,92 76,88
               Q68,83 50,81 Q32,83 24,88Z" fill="url(#fabricWeave${containerId})"/>
      <!-- Lint/dust particles on coat -->
      <circle cx="35" cy="98" r=".4" fill="rgba(200,195,185,.15)"/>
      <circle cx="62" cy="105" r=".35" fill="rgba(200,195,185,.12)"/>
      <circle cx="40" cy="120" r=".3" fill="rgba(200,195,185,.1)"/>
      <circle cx="58" cy="130" r=".38" fill="rgba(200,195,185,.13)"/>
      <circle cx="45" cy="110" r=".25" fill="rgba(200,195,185,.08)"/>
      <!-- Wear pattern (shinier at elbows/shoulders) -->
      <ellipse cx="28" cy="95" rx="4" ry="6" fill="rgba(255,250,240,.04)"/>
      <ellipse cx="72" cy="95" rx="4" ry="6" fill="rgba(255,250,240,.04)"/>
      <!-- Thread detail on buttons -->
      <line x1="49" y1="102" x2="51" y2="104" stroke="rgba(120,90,50,.15)" stroke-width=".2"/>
      <line x1="51" y1="102" x2="49" y2="104" stroke="rgba(120,90,50,.15)" stroke-width=".2"/>
      <line x1="49" y1="112" x2="51" y2="114" stroke="rgba(120,90,50,.15)" stroke-width=".2"/>
      <line x1="51" y1="112" x2="49" y2="114" stroke="rgba(120,90,50,.15)" stroke-width=".2"/>
      <!-- Button holes -->
      <ellipse cx="47" cy="103" rx="1.5" ry=".8" fill="none" stroke="rgba(140,110,70,.12)" stroke-width=".3"/>
      <ellipse cx="47" cy="113" rx="1.5" ry=".8" fill="none" stroke="rgba(140,110,70,.12)" stroke-width=".3"/>
      <ellipse cx="47" cy="123" rx="1.5" ry=".8" fill="none" stroke="rgba(140,110,70,.12)" stroke-width=".3"/>
      <!-- Stitch marks along seams -->
      <path d="M24,90 L24,92 M24,95 L24,97 M24,100 L24,102 M24,105 L24,107 M24,110 L24,112" fill="none" stroke="rgba(160,130,90,.1)" stroke-width=".4" stroke-linecap="round"/>
      <path d="M76,90 L76,92 M76,95 L76,97 M76,100 L76,102 M76,105 L76,107 M76,110 L76,112" fill="none" stroke="rgba(160,130,90,.1)" stroke-width=".4" stroke-linecap="round"/>
      <!-- Elbow wrinkle shadows -->
      <path d="M26,96 Q28,98 26,100" fill="none" stroke="rgba(140,100,50,.06)" stroke-width=".6"/>
      <path d="M27,98 Q29,100 27,102" fill="none" stroke="rgba(140,100,50,.05)" stroke-width=".5"/>
      <path d="M74,96 Q72,98 74,100" fill="none" stroke="rgba(140,100,50,.06)" stroke-width=".6"/>
      <path d="M73,98 Q71,100 73,102" fill="none" stroke="rgba(140,100,50,.05)" stroke-width=".5"/>
      <!-- Waist crease -->
      <path d="M34,118 Q50,121 66,118" fill="none" stroke="rgba(140,100,50,.08)" stroke-width=".6"/>
      <!-- Pockets with flap -->
      <path d="M30,114 L30,108 Q30,106 32,106 L42,106 Q44,106 44,108 L44,114 Q44,116 42,116 L32,116 Q30,116 30,114Z"
            fill="none" stroke="rgba(170,140,100,.22)" stroke-width=".6"/>
      <line x1="30" y1="108" x2="44" y2="108" stroke="rgba(170,140,100,.18)" stroke-width=".5"/>
      <path d="M56,114 L56,108 Q56,106 58,106 L68,106 Q70,106 70,108 L70,114 Q70,116 68,116 L58,116 Q56,116 56,114Z"
            fill="none" stroke="rgba(170,140,100,.22)" stroke-width=".6"/>
      <line x1="56" y1="108" x2="70" y2="108" stroke="rgba(170,140,100,.18)" stroke-width=".5"/>
      <!-- Buttons -->
      <circle cx="50" cy="103" r="2" fill="#9a7858"/><circle cx="50" cy="103" r=".9" fill="#c0a078"/>
      <circle cx="50" cy="113" r="2" fill="#9a7858"/><circle cx="50" cy="113" r=".9" fill="#c0a078"/>
      <circle cx="50" cy="123" r="2" fill="#9a7858"/><circle cx="50" cy="123" r=".9" fill="#c0a078"/>
    </g>

    <!-- === BOWTIE — layered, 3D === -->
    <g filter="url(#softShadow${containerId})">
      <path d="M40,86 Q45,84 50,91 Q55,84 60,86 Q55,92 60,98 Q55,100 50,93 Q45,100 40,98 Q45,92 40,86Z"
            fill="#8b2020"/>
      <path d="M41,87 Q46,85 50,91 Q54,85 59,87 Q54,92 59,97 Q54,99 50,93 Q46,99 41,97 Q46,92 41,87Z"
            fill="#b03030"/>
      <path d="M42,88 Q46,87 49,91" fill="none" stroke="rgba(255,200,200,.2)" stroke-width="1.2"/>
      <circle cx="50" cy="92" r="3.2" fill="#c83838"/>
      <circle cx="50" cy="92" r="1.6" fill="#8b2020"/>
      <circle cx="49" cy="91" r=".9" fill="rgba(255,210,210,.35)"/>
    </g>

    <!-- === ARMS with proper sleeves === -->
    ${lArmSVG}
    ${lHandSVG}
    ${rArmSVG}
    ${rHandSVG}

    <!-- === EARS (behind head layer) === -->
    <ellipse cx="20" cy="52" rx="6.5" ry="9" fill="#e4b474" stroke="rgba(170,110,50,.3)" stroke-width=".5"/>
    <ellipse cx="20" cy="52" rx="3.5" ry="5.5" fill="rgba(190,130,70,.2)"/>
    <path d="M19,48 Q17,52 19,56" fill="none" stroke="rgba(170,110,50,.2)" stroke-width=".6"/>
    <ellipse cx="80" cy="52" rx="6.5" ry="9" fill="#e4b474" stroke="rgba(170,110,50,.3)" stroke-width=".5"/>
    <ellipse cx="80" cy="52" rx="3.5" ry="5.5" fill="rgba(190,130,70,.2)"/>
    <path d="M81,48 Q83,52 81,56" fill="none" stroke="rgba(170,110,50,.2)" stroke-width=".6"/>
    <!-- SSS ear glow -->
    <ellipse cx="20" cy="52" rx="7" ry="9.5" fill="url(#sssEarL${containerId})"/>
    <ellipse cx="80" cy="52" rx="7" ry="9.5" fill="url(#sssEarR${containerId})"/>

    <!-- === HEAD — large, Pixar-proportioned === -->
    <ellipse cx="50" cy="48" rx="31" ry="36" fill="url(#skinGrad${containerId})" filter="url(#softShadow${containerId})"
      stroke="rgba(140,90,40,.3)" stroke-width="1"/>
    <ellipse cx="50" cy="48" rx="31" ry="36" fill="url(#skinShadow${containerId})"/>
    <!-- Pore texture overlay on face -->
    <ellipse cx="50" cy="48" rx="29" ry="34" fill="url(#porePattern${containerId})"/>
    <!-- Forehead warmth -->
    <ellipse cx="50" cy="36" rx="20" ry="12" fill="rgba(255,225,190,.15)"/>
    <!-- Forehead wrinkle lines (5 creases for more realism) -->
    <path d="M30,27 Q40,24.5 50,27 Q60,24.5 70,27" fill="none" stroke="rgba(160,110,60,.06)" stroke-width=".5" stroke-linecap="round"/>
    <path d="M32,30 Q41,28 50,30 Q59,28 68,30" fill="none" stroke="rgba(160,110,60,.09)" stroke-width=".7" stroke-linecap="round"/>
    <path d="M34,34 Q42,32.5 50,34 Q58,32.5 66,34" fill="none" stroke="rgba(160,110,60,.07)" stroke-width=".6" stroke-linecap="round"/>
    <path d="M36,38 Q43,36.5 50,38 Q57,36.5 64,38" fill="none" stroke="rgba(160,110,60,.06)" stroke-width=".5" stroke-linecap="round"/>
    <path d="M38,41 Q44,40 50,41 Q56,40 62,41" fill="none" stroke="rgba(160,110,60,.04)" stroke-width=".4" stroke-linecap="round"/>
    <!-- Forehead veins (faint blue-green) -->
    <path d="M34,26 Q36,30 35,34 Q34,37 36,40" fill="none" stroke="rgba(80,120,110,.06)" stroke-width=".5" stroke-linecap="round"/>
    <path d="M36,28 Q38,31 37,35" fill="none" stroke="rgba(80,120,110,.04)" stroke-width=".35" stroke-linecap="round"/>
    <path d="M64,27 Q62,31 63,35 Q64,38 62,41" fill="none" stroke="rgba(80,120,110,.05)" stroke-width=".45" stroke-linecap="round"/>
    <!-- Temple veins -->
    <path d="M24,38 Q22,34 23,30" fill="none" stroke="rgba(80,120,110,.05)" stroke-width=".4" stroke-linecap="round"/>
    <path d="M76,38 Q78,34 77,30" fill="none" stroke="rgba(80,120,110,.04)" stroke-width=".35" stroke-linecap="round"/>
    <!-- Age spots / liver spots / freckles -->
    <circle cx="38" cy="32" r="2" fill="rgba(160,110,50,.06)"/>
    <circle cx="62" cy="34" r="1.5" fill="rgba(160,110,50,.05)"/>
    <circle cx="28" cy="55" r="1.8" fill="rgba(160,110,50,.05)"/>
    <circle cx="44" cy="28" r="1.2" fill="rgba(160,110,50,.04)"/>
    <circle cx="56" cy="30" r="1" fill="rgba(155,105,48,.04)"/>
    <circle cx="33" cy="60" r="1.3" fill="rgba(160,110,50,.05)"/>
    <circle cx="67" cy="58" r="1.1" fill="rgba(155,105,48,.04)"/>
    <!-- Moles -->
    <circle cx="70" cy="55" r=".8" fill="rgba(100,60,25,.12)"/>
    <circle cx="35" cy="68" r=".6" fill="rgba(100,60,25,.1)"/>
    <!-- Skin highlight on cheekbones -->
    <ellipse cx="28" cy="52" rx="7" ry="4" fill="url(#cheekHighL${containerId})"/>
    <ellipse cx="72" cy="52" rx="7" ry="4" fill="url(#cheekHighR${containerId})"/>
    <!-- Nose bridge highlight -->
    <ellipse cx="50" cy="46" rx="3" ry="8" fill="rgba(255,245,230,.1)"/>
    <!-- Chin highlight -->
    <ellipse cx="50" cy="74" rx="5" ry="3" fill="url(#chinHigh${containerId})"/>
    <!-- Eyebag shadows -->
    <ellipse cx="37" cy="56" rx="8" ry="3.5" fill="url(#eyebagL${containerId})"/>
    <ellipse cx="63" cy="56" rx="8" ry="3.5" fill="url(#eyebagR${containerId})"/>
    <!-- Under-eye wrinkle lines -->
    <path d="M30,55 Q37,58 44,55" fill="none" stroke="rgba(150,100,50,.06)" stroke-width=".4" stroke-linecap="round"/>
    <path d="M56,55 Q63,58 70,55" fill="none" stroke="rgba(150,100,50,.06)" stroke-width=".4" stroke-linecap="round"/>
    <!-- Chin dimple -->
    <ellipse cx="50" cy="76" rx="2" ry="1.5" fill="rgba(140,80,30,.08)"/>
    <path d="M49,75 Q50,77.5 51,75" fill="none" stroke="rgba(140,80,30,.1)" stroke-width=".5"/>
    <!-- Jawline shadow — stronger -->
    <path d="M25,60 Q35,78 50,82 Q65,78 75,60" fill="rgba(160,100,40,.12)" stroke="none"/>
    <!-- Chin shadow -->
    <ellipse cx="50" cy="76" rx="12" ry="5" fill="rgba(140,80,30,.08)"/>
    <!-- Double chin shadow -->
    <ellipse cx="50" cy="80" rx="16" ry="4" fill="url(#doubleChin${containerId})"/>
    <path d="M36,78 Q50,83 64,78" fill="none" stroke="rgba(140,80,30,.07)" stroke-width=".6" stroke-linecap="round"/>
    <!-- Stubble on chin and cheeks -->
    <ellipse cx="50" cy="72" rx="14" ry="8" fill="url(#stubblePattern${containerId})"/>
    <ellipse cx="30" cy="62" rx="6" ry="8" fill="url(#stubblePattern${containerId})"/>
    <ellipse cx="70" cy="62" rx="6" ry="8" fill="url(#stubblePattern${containerId})"/>

    <!-- === HAIR — volumetric, many overlapping strands === -->
    <g class="hair-strand" style="transform-origin:50px 18px">
      <!-- Base volume -->
      <path d="M18 44 Q2 26 14 14 Q8 -2 28 4 Q22 -10 46 -6 Q40 -14 56 -10 Q52 -14 68 -6 Q62 -10 80 0
               Q74 -4 88 8 Q96 2 88 22 Q102 16 84 42"
            fill="url(#hairGrad${containerId})" stroke="rgba(140,128,108,.4)" stroke-width=".8"/>
      <!-- Secondary volume layer (slight offset for depth) -->
      <path d="M22 40 Q8 24 18 14 Q14 2 32 6 Q28 -6 48 -4 Q44 -10 60 -6 Q56 -10 74 -2 Q68 -4 84 6
               Q90 2 84 20 Q96 16 80 38"
            fill="rgba(245,240,232,.3)" stroke="none"/>
      <!-- Individual strand separations — dark lines between clumps -->
      <path d="M24 36 Q10 20 16 8" fill="none" stroke="rgba(160,145,120,.35)" stroke-width="1" stroke-linecap="round"/>
      <path d="M30 28 Q18 12 24 2" fill="none" stroke="rgba(160,145,120,.3)" stroke-width=".8" stroke-linecap="round"/>
      <path d="M40 20 Q34 4 40 -4" fill="none" stroke="rgba(160,145,120,.3)" stroke-width=".8" stroke-linecap="round"/>
      <path d="M50 18 Q48 2 52 -8" fill="none" stroke="rgba(160,145,120,.3)" stroke-width=".8" stroke-linecap="round"/>
      <path d="M60 20 Q64 4 60 -4" fill="none" stroke="rgba(160,145,120,.3)" stroke-width=".8" stroke-linecap="round"/>
      <path d="M70 28 Q82 12 76 2" fill="none" stroke="rgba(160,145,120,.3)" stroke-width=".8" stroke-linecap="round"/>
      <path d="M76 36 Q90 20 84 8" fill="none" stroke="rgba(160,145,120,.35)" stroke-width="1" stroke-linecap="round"/>
      <!-- Wispy side strands — thicker, more defined -->
      <path d="M14 42 Q-2 30 6 14" fill="none" stroke="rgba(210,200,182,.8)" stroke-width="5.5" stroke-linecap="round"/>
      <path d="M86 42 Q102 30 94 14" fill="none" stroke="rgba(210,200,182,.8)" stroke-width="5.5" stroke-linecap="round"/>
      <path d="M14 42 Q-2 30 6 14" fill="none" stroke="rgba(170,158,138,.3)" stroke-width="1" stroke-linecap="round"/>
      <path d="M86 42 Q102 30 94 14" fill="none" stroke="rgba(170,158,138,.3)" stroke-width="1" stroke-linecap="round"/>
      <path d="M12 48 Q-4 38 4 18" fill="none" stroke="rgba(200,190,172,.55)" stroke-width="4" stroke-linecap="round"/>
      <path d="M88 48 Q104 38 96 18" fill="none" stroke="rgba(200,190,172,.55)" stroke-width="4" stroke-linecap="round"/>
      <path d="M10 52 Q-2 44 2 28" fill="none" stroke="rgba(195,185,168,.35)" stroke-width="3" stroke-linecap="round"/>
      <path d="M90 52 Q102 44 98 28" fill="none" stroke="rgba(195,185,168,.35)" stroke-width="3" stroke-linecap="round"/>
      <!-- Top flyaways — more prominent -->
      <path d="M28 6 Q22 -8 32 -6" fill="none" stroke="rgba(220,212,198,.55)" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M42 -4 Q38 -16 48 -12" fill="none" stroke="rgba(220,212,198,.5)" stroke-width="2.2" stroke-linecap="round"/>
      <path d="M58 -6 Q62 -18 56 -14" fill="none" stroke="rgba(220,212,198,.45)" stroke-width="2.2" stroke-linecap="round"/>
      <path d="M72 4 Q78 -8 68 -4" fill="none" stroke="rgba(220,212,198,.5)" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M35 -2 Q30 -12 38 -10" fill="none" stroke="rgba(215,208,195,.4)" stroke-width="1.8" stroke-linecap="round"/>
      <path d="M65 -2 Q70 -12 62 -10" fill="none" stroke="rgba(215,208,195,.4)" stroke-width="1.8" stroke-linecap="round"/>
      <!-- Scalp visibility through thinning areas (darker skin showing) -->
      <ellipse cx="38" cy="4" rx="5" ry="3" fill="rgba(200,160,110,.08)"/>
      <ellipse cx="60" cy="2" rx="4" ry="2.5" fill="rgba(200,160,110,.07)"/>
      <ellipse cx="50" cy="-2" rx="4" ry="2" fill="rgba(200,160,110,.06)"/>
      <!-- Individual thin strands over scalp (root-to-tip: darker roots, lighter tips) -->
      <path d="M36 8 Q34 -2 38 -8" fill="none" stroke="rgba(180,170,150,.3)" stroke-width=".6" stroke-linecap="round"/>
      <path d="M62 6 Q64 -4 60 -10" fill="none" stroke="rgba(190,182,168,.25)" stroke-width=".5" stroke-linecap="round"/>
      <path d="M44 4 Q42 -6 46 -12" fill="none" stroke="rgba(175,165,148,.25)" stroke-width=".5" stroke-linecap="round"/>
      <path d="M56 4 Q58 -6 54 -12" fill="none" stroke="rgba(178,168,152,.22)" stroke-width=".45" stroke-linecap="round"/>
      <!-- Highlight wisps at crown -->
      <path d="M35 2 Q40 -6 50 -8 Q60 -6 65 2" fill="rgba(255,255,248,.18)" stroke="none"/>
      <!-- Hair sheen/specular band across crown -->
      <path d="M25 10 Q35 -2 50 -6 Q65 -2 75 10" fill="rgba(255,252,245,.12)" stroke="none"/>
      <path d="M28 8 Q38 -4 50 -8 Q62 -4 72 8" fill="rgba(255,255,250,.08)" stroke="none"/>
      <!-- Extra flyaway strands with varying opacity -->
      <path d="M18 38 Q4 22 10 6" fill="none" stroke="rgba(225,218,205,.3)" stroke-width="1.5" stroke-linecap="round"/>
      <path d="M16 50 Q0 40 6 22" fill="none" stroke="rgba(210,202,188,.2)" stroke-width="1.2" stroke-linecap="round"/>
      <path d="M84 38 Q98 22 92 6" fill="none" stroke="rgba(225,218,205,.3)" stroke-width="1.5" stroke-linecap="round"/>
      <path d="M86 50 Q100 40 94 22" fill="none" stroke="rgba(210,202,188,.2)" stroke-width="1.2" stroke-linecap="round"/>
      <!-- Dramatic wild side wisps -->
      <path d="M8 54 Q-6 46 0 30" fill="none" stroke="rgba(215,208,195,.25)" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M92 54 Q106 46 100 30" fill="none" stroke="rgba(215,208,195,.25)" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M6 58 Q-8 52 -2 36" fill="none" stroke="rgba(205,198,185,.15)" stroke-width="2" stroke-linecap="round"/>
      <path d="M94 58 Q108 52 102 36" fill="none" stroke="rgba(205,198,185,.15)" stroke-width="2" stroke-linecap="round"/>
      <!-- Top wispy flyaways -->
      <path d="M46 -8 Q42 -20 48 -18" fill="none" stroke="rgba(225,220,210,.3)" stroke-width="1.5" stroke-linecap="round"/>
      <path d="M54 -8 Q58 -20 52 -18" fill="none" stroke="rgba(225,220,210,.25)" stroke-width="1.3" stroke-linecap="round"/>
      <path d="M32 0 Q26 -14 34 -12" fill="none" stroke="rgba(220,214,202,.2)" stroke-width="1.2" stroke-linecap="round"/>
      <!-- Static electricity strands (standing straight up) -->
      <path d="M42 -6 Q42 -22 44 -24" fill="none" stroke="rgba(230,225,215,.2)" stroke-width=".8" stroke-linecap="round"/>
      <path d="M50 -10 Q50 -26 51 -28" fill="none" stroke="rgba(230,225,215,.18)" stroke-width=".7" stroke-linecap="round"/>
      <path d="M58 -6 Q58 -22 56 -24" fill="none" stroke="rgba(230,225,215,.17)" stroke-width=".7" stroke-linecap="round"/>
      <path d="M36 0 Q34 -16 36 -20" fill="none" stroke="rgba(225,220,210,.15)" stroke-width=".6" stroke-linecap="round"/>
      <path d="M66 -2 Q68 -18 66 -22" fill="none" stroke="rgba(225,220,210,.14)" stroke-width=".6" stroke-linecap="round"/>
      <!-- More random-angle flyaways (chaotic Einstein look) -->
      <path d="M20 30 Q0 18 -4 8" fill="none" stroke="rgba(215,208,195,.2)" stroke-width="1.8" stroke-linecap="round"/>
      <path d="M80 30 Q100 18 104 8" fill="none" stroke="rgba(215,208,195,.2)" stroke-width="1.8" stroke-linecap="round"/>
      <path d="M4 60 Q-10 55 -6 42" fill="none" stroke="rgba(200,192,178,.12)" stroke-width="1.5" stroke-linecap="round"/>
      <path d="M96 60 Q110 55 106 42" fill="none" stroke="rgba(200,192,178,.12)" stroke-width="1.5" stroke-linecap="round"/>
      <!-- Hair density variation: thicker individual strand clusters at crown -->
      <path d="M40 -4 Q38 -12 42 -14" fill="none" stroke="rgba(210,202,188,.35)" stroke-width="2.2" stroke-linecap="round"/>
      <path d="M48 -6 Q46 -14 50 -16" fill="none" stroke="rgba(210,202,188,.3)" stroke-width="2" stroke-linecap="round"/>
      <path d="M52 -6 Q54 -14 50 -16" fill="none" stroke="rgba(210,202,188,.3)" stroke-width="2" stroke-linecap="round"/>
      <path d="M60 -4 Q62 -12 58 -14" fill="none" stroke="rgba(210,202,188,.35)" stroke-width="2.2" stroke-linecap="round"/>
      <!-- Thinner strands at temples -->
      <path d="M22 34 Q14 24 16 14" fill="none" stroke="rgba(215,208,195,.12)" stroke-width=".8" stroke-linecap="round"/>
      <path d="M78 34 Q86 24 84 14" fill="none" stroke="rgba(215,208,195,.12)" stroke-width=".8" stroke-linecap="round"/>
    </g>

    <!-- === EYES — Photorealistic with individual lashes, tear ducts, multi-layer iris === -->
    <g class="blink" style="transform-origin:50px 46px">
      <!-- Individual top eyelashes — LEFT EYE (varying lengths and angles) -->
      <line x1="28" y1="43" x2="26" y2="39" stroke="rgba(80,50,25,.25)" stroke-width=".5" stroke-linecap="round"/>
      <line x1="30" y1="41.5" x2="28.5" y2="37.5" stroke="rgba(80,50,25,.3)" stroke-width=".5" stroke-linecap="round"/>
      <line x1="32" y1="40.5" x2="31" y2="36" stroke="rgba(80,50,25,.35)" stroke-width=".55" stroke-linecap="round"/>
      <line x1="34" y1="39.5" x2="33.5" y2="35" stroke="rgba(80,50,25,.35)" stroke-width=".6" stroke-linecap="round"/>
      <line x1="36" y1="39" x2="36" y2="34.5" stroke="rgba(80,50,25,.3)" stroke-width=".55" stroke-linecap="round"/>
      <line x1="38" y1="38.8" x2="38.5" y2="34.5" stroke="rgba(80,50,25,.3)" stroke-width=".5" stroke-linecap="round"/>
      <line x1="40" y1="39" x2="41" y2="35" stroke="rgba(80,50,25,.3)" stroke-width=".5" stroke-linecap="round"/>
      <line x1="42" y1="39.5" x2="43.5" y2="36" stroke="rgba(80,50,25,.25)" stroke-width=".45" stroke-linecap="round"/>
      <line x1="44" y1="40.5" x2="46" y2="37.5" stroke="rgba(80,50,25,.2)" stroke-width=".4" stroke-linecap="round"/>
      <line x1="46" y1="42" x2="48" y2="39.5" stroke="rgba(80,50,25,.15)" stroke-width=".35" stroke-linecap="round"/>
      <!-- Individual top eyelashes — RIGHT EYE -->
      <line x1="54" y1="42" x2="52" y2="39.5" stroke="rgba(80,50,25,.15)" stroke-width=".35" stroke-linecap="round"/>
      <line x1="56" y1="40.5" x2="54" y2="37.5" stroke="rgba(80,50,25,.2)" stroke-width=".4" stroke-linecap="round"/>
      <line x1="58" y1="39.5" x2="56.5" y2="36" stroke="rgba(80,50,25,.25)" stroke-width=".45" stroke-linecap="round"/>
      <line x1="60" y1="39" x2="59" y2="35" stroke="rgba(80,50,25,.3)" stroke-width=".5" stroke-linecap="round"/>
      <line x1="62" y1="38.8" x2="61.5" y2="34.5" stroke="rgba(80,50,25,.3)" stroke-width=".55" stroke-linecap="round"/>
      <line x1="64" y1="39" x2="64" y2="34.5" stroke="rgba(80,50,25,.3)" stroke-width=".55" stroke-linecap="round"/>
      <line x1="66" y1="39.5" x2="66.5" y2="35" stroke="rgba(80,50,25,.35)" stroke-width=".6" stroke-linecap="round"/>
      <line x1="68" y1="40.5" x2="69" y2="36" stroke="rgba(80,50,25,.35)" stroke-width=".55" stroke-linecap="round"/>
      <line x1="70" y1="41.5" x2="71.5" y2="37.5" stroke="rgba(80,50,25,.3)" stroke-width=".5" stroke-linecap="round"/>
      <line x1="72" y1="43" x2="74" y2="39" stroke="rgba(80,50,25,.25)" stroke-width=".5" stroke-linecap="round"/>
      <!-- Bottom eyelashes (shorter, sparser) — LEFT -->
      <line x1="30" y1="54" x2="29" y2="56" stroke="rgba(80,50,25,.1)" stroke-width=".3" stroke-linecap="round"/>
      <line x1="33" y1="55.5" x2="32.5" y2="57.5" stroke="rgba(80,50,25,.12)" stroke-width=".3" stroke-linecap="round"/>
      <line x1="36" y1="56" x2="36" y2="58" stroke="rgba(80,50,25,.1)" stroke-width=".25" stroke-linecap="round"/>
      <line x1="39" y1="56" x2="39.5" y2="58" stroke="rgba(80,50,25,.1)" stroke-width=".25" stroke-linecap="round"/>
      <line x1="42" y1="55.5" x2="43" y2="57.5" stroke="rgba(80,50,25,.08)" stroke-width=".25" stroke-linecap="round"/>
      <!-- Bottom eyelashes — RIGHT -->
      <line x1="58" y1="55.5" x2="57" y2="57.5" stroke="rgba(80,50,25,.08)" stroke-width=".25" stroke-linecap="round"/>
      <line x1="61" y1="56" x2="60.5" y2="58" stroke="rgba(80,50,25,.1)" stroke-width=".25" stroke-linecap="round"/>
      <line x1="64" y1="56" x2="64" y2="58" stroke="rgba(80,50,25,.1)" stroke-width=".25" stroke-linecap="round"/>
      <line x1="67" y1="55.5" x2="67.5" y2="57.5" stroke="rgba(80,50,25,.12)" stroke-width=".3" stroke-linecap="round"/>
      <line x1="70" y1="54" x2="71" y2="56" stroke="rgba(80,50,25,.1)" stroke-width=".3" stroke-linecap="round"/>
      <!-- Thick upper lash line -->
      <path d="M26,44 Q37,38 48,44" fill="none" stroke="rgba(80,50,25,.25)" stroke-width="1.5" stroke-linecap="round"/>
      <path d="M52,44 Q63,38 74,44" fill="none" stroke="rgba(80,50,25,.25)" stroke-width="1.5" stroke-linecap="round"/>
      <!-- Eye whites -->
      <ellipse cx="37" cy="47" rx="10.5" ry="12" fill="url(#eyeWhite${containerId})" stroke="rgba(140,100,60,.12)" stroke-width=".6"/>
      <ellipse cx="63" cy="47" rx="10.5" ry="12" fill="url(#eyeWhite${containerId})" stroke="rgba(140,100,60,.12)" stroke-width=".6"/>
      <!-- Bloodshot capillaries in sclera — LEFT -->
      <path d="M28,45 Q30,46 32,45.5" fill="none" stroke="rgba(200,50,50,.1)" stroke-width=".35"/>
      <path d="M28.5,47 Q30.5,46.5 32,47.5" fill="none" stroke="rgba(190,55,55,.08)" stroke-width=".3"/>
      <path d="M29,49 Q31,48.5 33,49.5" fill="none" stroke="rgba(185,60,60,.07)" stroke-width=".25"/>
      <path d="M28,51 Q30,50.5 31.5,51.2" fill="none" stroke="rgba(195,50,50,.06)" stroke-width=".2"/>
      <path d="M44,46 Q42.5,46.5 41,46" fill="none" stroke="rgba(200,50,50,.09)" stroke-width=".3"/>
      <path d="M45,48 Q43,47.5 41.5,48.5" fill="none" stroke="rgba(190,55,55,.07)" stroke-width=".25"/>
      <path d="M44,50 Q42.5,50.5 41,50" fill="none" stroke="rgba(185,60,60,.06)" stroke-width=".2"/>
      <!-- Bloodshot capillaries — RIGHT -->
      <path d="M68,45 Q70,46 72,45.5" fill="none" stroke="rgba(200,50,50,.1)" stroke-width=".35"/>
      <path d="M68.5,47 Q70.5,46.5 72,47.5" fill="none" stroke="rgba(190,55,55,.08)" stroke-width=".3"/>
      <path d="M69,49 Q71,48.5 73,49.5" fill="none" stroke="rgba(185,60,60,.07)" stroke-width=".25"/>
      <path d="M55,46 Q57,46.5 59,46" fill="none" stroke="rgba(200,50,50,.09)" stroke-width=".3"/>
      <path d="M56,48 Q57.5,48.5 59,48" fill="none" stroke="rgba(190,55,55,.07)" stroke-width=".25"/>
      <!-- Tear duct detail (pink inner corner) — LEFT -->
      <ellipse cx="27.5" cy="48" rx="2" ry="2.5" fill="rgba(220,150,140,.2)"/>
      <ellipse cx="27.5" cy="48" rx="1.2" ry="1.5" fill="rgba(240,160,150,.15)"/>
      <!-- Tear duct — RIGHT -->
      <ellipse cx="72.5" cy="48" rx="2" ry="2.5" fill="rgba(220,150,140,.2)"/>
      <ellipse cx="72.5" cy="48" rx="1.2" ry="1.5" fill="rgba(240,160,150,.15)"/>
      <!-- Upper lid shadow -->
      <ellipse cx="37" cy="42" rx="9.5" ry="5.5" fill="rgba(170,130,85,.07)"/>
      <ellipse cx="63" cy="42" rx="9.5" ry="5.5" fill="rgba(170,130,85,.07)"/>
      <!-- Upper lid crease line -->
      <path d="M27,40 Q37,35 47,40" fill="none" stroke="rgba(150,100,50,.08)" stroke-width=".6" stroke-linecap="round"/>
      <path d="M53,40 Q63,35 73,40" fill="none" stroke="rgba(150,100,50,.08)" stroke-width=".6" stroke-linecap="round"/>
      <!-- Iris with multi-layer gradient -->
      <circle cx="38" cy="48" r="6.5" fill="url(#irisGrad${containerId})"/>
      <circle cx="64" cy="48" r="6.5" fill="url(#irisGrad${containerId})"/>
      <!-- Inner iris glow layer -->
      <circle cx="38" cy="48" r="5" fill="url(#irisInner${containerId})"/>
      <circle cx="64" cy="48" r="5" fill="url(#irisInner${containerId})"/>
      <!-- Limbal ring (dark ring around iris edge) -->
      <circle cx="38" cy="48" r="6.5" fill="none" stroke="rgba(40,20,5,.35)" stroke-width="1"/>
      <circle cx="64" cy="48" r="6.5" fill="none" stroke="rgba(40,20,5,.35)" stroke-width="1"/>
      <!-- Iris detail rings (multiple) -->
      <circle cx="38" cy="48" r="5.5" fill="none" stroke="rgba(140,100,40,.2)" stroke-width=".4"/>
      <circle cx="64" cy="48" r="5.5" fill="none" stroke="rgba(140,100,40,.2)" stroke-width=".4"/>
      <circle cx="38" cy="48" r="4.5" fill="none" stroke="rgba(160,120,50,.12)" stroke-width=".3"/>
      <circle cx="64" cy="48" r="4.5" fill="none" stroke="rgba(160,120,50,.12)" stroke-width=".3"/>
      <!-- Iris radial spokes (denser, 12 angles) -->
      ${[0,30,60,90,120,150,180,210,240,270,300,330].map(a=>`<line x1="${38+Math.cos(a*Math.PI/180)*2}" y1="${48+Math.sin(a*Math.PI/180)*2}" x2="${38+Math.cos(a*Math.PI/180)*6}" y2="${48+Math.sin(a*Math.PI/180)*6}" stroke="rgba(130,90,35,.08)" stroke-width=".35"/>
      <line x1="${64+Math.cos(a*Math.PI/180)*2}" y1="${48+Math.sin(a*Math.PI/180)*2}" x2="${64+Math.cos(a*Math.PI/180)*6}" y2="${48+Math.sin(a*Math.PI/180)*6}" stroke="rgba(130,90,35,.08)" stroke-width=".35"/>`).join('')}
      <!-- Iris collarette (jagged inner ring) -->
      <circle cx="38" cy="48" r="3.8" fill="none" stroke="rgba(180,140,60,.15)" stroke-width=".3" stroke-dasharray=".8,.5"/>
      <circle cx="64" cy="48" r="3.8" fill="none" stroke="rgba(180,140,60,.15)" stroke-width=".3" stroke-dasharray=".8,.5"/>
      <!-- Pupils — slight asymmetry for realism -->
      <circle cx="38" cy="48" r="3.2" fill="#0e0802"/>
      <circle cx="64" cy="48" r="3.0" fill="#0e0802"/>
      <!-- Pupil environment reflection (not just white dots — window shape) -->
      <ellipse cx="41" cy="45" rx="2" ry="3.2" fill="white" opacity=".85" transform="rotate(-10,41,45)"/>
      <ellipse cx="67" cy="45" rx="2" ry="3.2" fill="white" opacity=".85" transform="rotate(-10,67,45)"/>
      <!-- Window frame crossbar in reflection -->
      <line x1="40" y1="45" x2="42" y2="45" stroke="rgba(200,200,200,.3)" stroke-width=".4"/>
      <line x1="41" y1="43.5" x2="41" y2="46.5" stroke="rgba(200,200,200,.25)" stroke-width=".3"/>
      <line x1="66" y1="45" x2="68" y2="45" stroke="rgba(200,200,200,.3)" stroke-width=".4"/>
      <line x1="67" y1="43.5" x2="67" y2="46.5" stroke="rgba(200,200,200,.25)" stroke-width=".3"/>
      <!-- SECONDARY highlight (small, lower-left) -->
      <circle cx="36" cy="51" r="1.3" fill="white" opacity=".55"/>
      <circle cx="62" cy="51" r="1.3" fill="white" opacity=".55"/>
      <!-- Warm lamplight reflection -->
      <circle cx="40" cy="49" r=".9" fill="#ffd080" opacity=".4"/>
      <circle cx="66" cy="49" r=".9" fill="#ffd080" opacity=".4"/>
      <!-- Lower eyelid definition with margin detail -->
      <path d="M28,52 Q37,57 48,52" fill="none" stroke="rgba(160,110,70,.12)" stroke-width=".9" stroke-linecap="round"/>
      <path d="M52,52 Q63,57 74,52" fill="none" stroke="rgba(160,110,70,.12)" stroke-width=".9" stroke-linecap="round"/>
      <!-- Lower lid margin (waterline — pink/red) -->
      <path d="M29,52.5 Q37,56.5 47,52.5" fill="none" stroke="rgba(200,140,130,.08)" stroke-width=".5" stroke-linecap="round"/>
      <path d="M53,52.5 Q63,56.5 71,52.5" fill="none" stroke="rgba(200,140,130,.08)" stroke-width=".5" stroke-linecap="round"/>
    </g>

    <!-- Eyebrows — thick, expressive, crisp -->
    <path d="${p.brow1}" fill="none" stroke="rgba(100,70,35,.8)" stroke-width="3.2" stroke-linecap="round"/>
    <path d="${p.brow2}" fill="none" stroke="rgba(100,70,35,.8)" stroke-width="3.2" stroke-linecap="round"/>
    <!-- Brow highlight edge -->
    <path d="${p.brow1}" fill="none" stroke="rgba(180,160,130,.2)" stroke-width="1.2" stroke-linecap="round" transform="translate(0,-1.2)"/>
    <path d="${p.brow2}" fill="none" stroke="rgba(180,160,130,.2)" stroke-width="1.2" stroke-linecap="round" transform="translate(0,-1.2)"/>

    <!-- Wire-rim round glasses -->
    <g opacity=".85">
      <!-- Left lens frame -->
      <circle cx="37" cy="48" r="12" fill="none" stroke="#c8a050" stroke-width=".8"/>
      <circle cx="37" cy="48" r="11.5" fill="none" stroke="rgba(200,170,100,.3)" stroke-width=".3"/>
      <!-- Right lens frame -->
      <circle cx="63" cy="48" r="12" fill="none" stroke="#c8a050" stroke-width=".8"/>
      <circle cx="63" cy="48" r="11.5" fill="none" stroke="rgba(200,170,100,.3)" stroke-width=".3"/>
      <!-- Bridge -->
      <path d="M49,48 Q50,45 51,48" fill="none" stroke="#c8a050" stroke-width=".7"/>
      <!-- Temples (arms going to ears) -->
      <path d="M25,47 L20,49" fill="none" stroke="#c8a050" stroke-width=".6" stroke-linecap="round"/>
      <path d="M75,47 L80,49" fill="none" stroke="#c8a050" stroke-width=".6" stroke-linecap="round"/>
      <!-- Subtle lens reflection -->
      <path d="M30,42 Q35,40 40,43" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="1.2" stroke-linecap="round"/>
      <path d="M56,42 Q61,40 66,43" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="1.2" stroke-linecap="round"/>
      <!-- Lens tint -->
      <circle cx="37" cy="48" r="11" fill="rgba(200,220,255,.03)"/>
      <circle cx="63" cy="48" r="11" fill="rgba(200,220,255,.03)"/>
    </g>

    <!-- Cheeks — rosy, warm -->
    <circle cx="22" cy="58" r="9" fill="url(#cheekGrad${containerId})"/>
    <circle cx="78" cy="58" r="9" fill="url(#cheekGrad${containerId})"/>
    <!-- SSS cheek glow -->
    <circle cx="24" cy="56" r="10" fill="url(#sssCheekL${containerId})"/>
    <circle cx="76" cy="56" r="10" fill="url(#sssCheekL${containerId})"/>
    <!-- Crow's feet wrinkles -->
    <path d="M17,44 L13,42" fill="none" stroke="rgba(160,110,60,.08)" stroke-width=".5" stroke-linecap="round"/>
    <path d="M17,46 L12,46" fill="none" stroke="rgba(160,110,60,.07)" stroke-width=".4" stroke-linecap="round"/>
    <path d="M17,48 L13,50" fill="none" stroke="rgba(160,110,60,.06)" stroke-width=".4" stroke-linecap="round"/>
    <path d="M83,44 L87,42" fill="none" stroke="rgba(160,110,60,.08)" stroke-width=".5" stroke-linecap="round"/>
    <path d="M83,46 L88,46" fill="none" stroke="rgba(160,110,60,.07)" stroke-width=".4" stroke-linecap="round"/>
    <path d="M83,48 L87,50" fill="none" stroke="rgba(160,110,60,.06)" stroke-width=".4" stroke-linecap="round"/>

    <!-- === NOSE — defined shape with bridge, nostrils, tip === -->
    <path d="M50,38 Q51.5,46 50,54" fill="none" stroke="rgba(180,120,60,.18)" stroke-width="1.4"/>
    <path d="M44,58 Q47,62.5 50,63 Q53,62.5 56,58" fill="rgba(210,160,100,.25)" stroke="rgba(160,100,50,.45)" stroke-width="1.2" stroke-linecap="round"/>
    <ellipse cx="50" cy="58" rx="5.5" ry="4" fill="rgba(220,170,110,.2)"/>
    <!-- Nose tip highlight -->
    <ellipse cx="50" cy="56.5" rx="2.8" ry="2" fill="rgba(255,235,210,.22)"/>
    <!-- SSS nose tip glow -->
    <ellipse cx="50" cy="58" rx="6" ry="5" fill="url(#sssNose${containerId})"/>
    <!-- Nose bridge shadow -->
    <path d="M48,42 Q49,48 48.5,54" fill="none" stroke="rgba(170,110,50,.08)" stroke-width="1.5"/>
    <!-- Nostrils — darker, more defined -->
    <ellipse cx="46.5" cy="60" rx="2" ry="1.2" fill="rgba(140,80,30,.22)"/>
    <ellipse cx="53.5" cy="60" rx="2" ry="1.2" fill="rgba(140,80,30,.22)"/>

    <!-- Laugh/nasolabial lines — more pronounced, doubled for depth -->
    <path d="M29,54 Q26,60 28,68 Q29,72 32,74" fill="none" stroke="rgba(170,115,60,.15)" stroke-width="1.1" stroke-linecap="round"/>
    <path d="M71,54 Q74,60 72,68 Q71,72 68,74" fill="none" stroke="rgba(170,115,60,.15)" stroke-width="1.1" stroke-linecap="round"/>
    <!-- Shadow side of nasolabial fold -->
    <path d="M30,55 Q27.5,61 29.5,68" fill="none" stroke="rgba(150,95,40,.06)" stroke-width="1.5" stroke-linecap="round"/>
    <path d="M70,55 Q72.5,61 70.5,68" fill="none" stroke="rgba(150,95,40,.06)" stroke-width="1.5" stroke-linecap="round"/>
    <!-- Marionette lines (mouth to chin) -->
    <path d="M36,72 Q34,76 35,80" fill="none" stroke="rgba(160,105,50,.06)" stroke-width=".5" stroke-linecap="round"/>
    <path d="M64,72 Q66,76 65,80" fill="none" stroke="rgba(160,105,50,.06)" stroke-width=".5" stroke-linecap="round"/>

    <!-- === MUSTACHE — full, volumetric, crisp === -->
    <path d="M32,66 Q40,62 50,68 Q60,62 68,66 Q60,70 50,65 Q40,70 32,66Z" fill="rgba(170,160,142,.9)" stroke="rgba(120,108,88,.5)" stroke-width=".7"/>
    <path d="M34,66 Q40,63 46,67" fill="none" stroke="rgba(200,192,178,.25)" stroke-width=".9"/>
    <path d="M54,67 Q60,63 66,66" fill="none" stroke="rgba(200,192,178,.25)" stroke-width=".9"/>
    <!-- Mustache shadow underneath -->
    <path d="M35,67 Q50,72 65,67" fill="rgba(140,100,50,.06)" stroke="none"/>

    <!-- Philtrum (groove above upper lip) -->
    <path d="M48.5,62 Q50,60.5 51.5,62" fill="none" stroke="rgba(170,115,60,.1)" stroke-width=".6"/>
    <path d="M49,63 L49,60.5" fill="none" stroke="rgba(160,110,55,.06)" stroke-width=".4"/>
    <path d="M51,63 L51,60.5" fill="none" stroke="rgba(160,110,55,.06)" stroke-width=".4"/>
    <!-- Upper lip shadow (darker) -->
    <path d="M36,66 Q43,64 50,66 Q57,64 64,66" fill="rgba(150,80,50,.06)" stroke="none"/>
    <!-- Mouth -->
    ${mouthPath}
    <!-- Lip vertical texture lines (7 lines for realistic lip texture) -->
    <path d="M38,67 L38,69.5" fill="none" stroke="rgba(160,90,55,.05)" stroke-width=".25"/>
    <path d="M40,66.8 L40,69.8" fill="none" stroke="rgba(160,90,55,.06)" stroke-width=".25"/>
    <path d="M42,66.5 L42,70" fill="none" stroke="rgba(160,90,55,.06)" stroke-width=".3"/>
    <path d="M44,66.5 L44.2,70" fill="none" stroke="rgba(160,90,55,.05)" stroke-width=".25"/>
    <path d="M46,66.8 L46,69.8" fill="none" stroke="rgba(160,90,55,.06)" stroke-width=".25"/>
    <path d="M48,67 L48,69.5" fill="none" stroke="rgba(160,90,55,.05)" stroke-width=".25"/>
    <path d="M50,67 L50,69" fill="none" stroke="rgba(160,90,55,.04)" stroke-width=".2"/>
    <path d="M52,67 L52,69.5" fill="none" stroke="rgba(160,90,55,.05)" stroke-width=".25"/>
    <path d="M54,66.8 L54,69.8" fill="none" stroke="rgba(160,90,55,.06)" stroke-width=".25"/>
    <path d="M56,66.5 L56,70" fill="none" stroke="rgba(160,90,55,.06)" stroke-width=".3"/>
    <path d="M58,66.5 L58.2,70" fill="none" stroke="rgba(160,90,55,.05)" stroke-width=".25"/>
    <path d="M60,66.8 L60,69.8" fill="none" stroke="rgba(160,90,55,.06)" stroke-width=".25"/>
    <path d="M62,67 L62,69.5" fill="none" stroke="rgba(160,90,55,.05)" stroke-width=".25"/>
    <!-- Saliva shine on lower lip -->
    <ellipse cx="48" cy="69" rx="4" ry="1" fill="rgba(255,255,255,.1)"/>
    <ellipse cx="52" cy="68.5" rx="3" ry=".8" fill="rgba(255,255,255,.08)"/>
    <!-- Corner-of-mouth shadows -->
    <circle cx="34" cy="68" r="2" fill="rgba(140,80,30,.06)"/>
    <circle cx="66" cy="68" r="2" fill="rgba(140,80,30,.06)"/>
    <!-- Teeth hint (subtle gum and tooth shapes when mouth open) -->
    ${p.mouthFill ? `
    <path d="M42,67 L42,69.5 L44.5,69.5 L44.5,67" fill="rgba(255,252,245,.12)" stroke="rgba(200,195,185,.06)" stroke-width=".2"/>
    <path d="M45,67 L45,69.5 L47.5,69.5 L47.5,67" fill="rgba(255,252,245,.11)" stroke="rgba(200,195,185,.06)" stroke-width=".2"/>
    <path d="M48,67 L48,69.5 L50,69.5 L50,67" fill="rgba(255,252,245,.12)" stroke="rgba(200,195,185,.06)" stroke-width=".2"/>
    <path d="M50.5,67 L50.5,69.5 L53,69.5 L53,67" fill="rgba(255,252,245,.11)" stroke="rgba(200,195,185,.06)" stroke-width=".2"/>
    <path d="M53.5,67 L53.5,69.5 L56,69.5 L56,67" fill="rgba(255,252,245,.12)" stroke="rgba(200,195,185,.06)" stroke-width=".2"/>
    <path d="M56.5,67 L56.5,69.5 L58.5,69.5 L58.5,67" fill="rgba(255,252,245,.1)" stroke="rgba(200,195,185,.06)" stroke-width=".2"/>
    <!-- Gum line -->
    <path d="M41,67 Q50,65.5 59,67" fill="none" stroke="rgba(200,120,120,.08)" stroke-width=".4"/>
    ` : ''}
    </g><!-- end charOutline group -->
  </svg>`;
}

/* ============================================================
   STARFIELD BACKGROUND HELPER
   ============================================================ */
function drawStars(ctx, w, h, count, time) {
  for(let i=0;i<count;i++){
    const x=(Math.sin(i*127.1+i*311.7)*.5+.5)*w;
    const y=(Math.sin(i*269.5+i*183.3)*.5+.5)*h;
    const twinkle=.4+.6*Math.sin(time*2+i*1.7);
    const r=.5+1.5*(i%3===0?1:.5);
    // Stars with a subtle purple-tinted sky
    const warmth=((i*73)%100)/100;
    const sr=220+Math.floor(warmth*35);
    const sg=200+Math.floor((1-warmth)*40);
    const sb=160+Math.floor(warmth*20);
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fillStyle=`rgba(${sr},${sg},${sb},${twinkle*.5})`;
    ctx.fill();
    // Subtle warm bloom on brighter stars
    if(i%5===0&&twinkle>.7){
      ctx.beginPath();ctx.arc(x,y,r*3,0,Math.PI*2);
      ctx.fillStyle=`rgba(240,200,140,${(twinkle-.7)*.15})`;
      ctx.fill();
    }
  }
}

/* Warm ambient vignette overlay — Ratatouille lamplight feel */
function drawWarmVignette(ctx, w, h) {
  // Stronger cinematic vignette
  const vg=ctx.createRadialGradient(w*.5,h*.4,w*.12,w*.5,h*.5,w*.72);
  vg.addColorStop(0,'rgba(240,180,80,.05)');
  vg.addColorStop(.4,'rgba(0,0,0,0)');
  vg.addColorStop(.75,'rgba(5,2,0,.15)');
  vg.addColorStop(1,'rgba(0,0,0,.35)');
  ctx.fillStyle=vg;ctx.fillRect(0,0,w,h);
}

/* Film grain overlay for cinematic feel */
function drawFilmGrain(ctx, w, h, time, intensity) {
  const id=ctx.getImageData(0,0,Math.min(w,400),Math.min(h,300));
  // Sparse noise for performance — only modify every 4th pixel
  const d=id.data;
  const seed=Math.floor(time*30);
  for(let i=0;i<d.length;i+=16){
    const noise=((seed*1103515245+12345+i)&0x7fffffff)%256-128;
    const n=noise*intensity;
    d[i]+=n;d[i+1]+=n;d[i+2]+=n;
  }
  ctx.putImageData(id,0,0);
}

/* Chromatic aberration at canvas edges (very subtle RGB split) */
function drawChromaticAberration(ctx, w, h) {
  // Subtle color fringing at edges — just draw thin colored borders
  ctx.save();
  ctx.globalAlpha=.03;
  ctx.globalCompositeOperation='screen';
  // Red shift left
  ctx.fillStyle='#ff0000';
  ctx.fillRect(0,0,3,h);
  // Cyan shift right
  ctx.fillStyle='#00ffff';
  ctx.fillRect(w-3,0,3,h);
  // Blue shift top
  ctx.fillStyle='#0000ff';
  ctx.fillRect(0,0,w,2);
  // Yellow shift bottom
  ctx.fillStyle='#ffff00';
  ctx.fillRect(0,h-2,w,2);
  ctx.globalCompositeOperation='source-over';
  ctx.globalAlpha=1;
  ctx.restore();
}

/* Lens flare for bright objects */
function drawLensFlare(ctx, x, y, brightness, color) {
  const r=20+brightness*40;
  ctx.save();
  ctx.globalCompositeOperation='screen';
  // Main flare
  const fg=ctx.createRadialGradient(x,y,0,x,y,r);
  fg.addColorStop(0,color||'rgba(255,240,200,.3)');
  fg.addColorStop(.3,'rgba(255,220,150,.1)');
  fg.addColorStop(1,'rgba(255,200,100,0)');
  ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=fg;ctx.fill();
  // Secondary flare elements
  const dx=x-ctx.canvas.width/2, dy=y-ctx.canvas.height/2;
  for(let i=1;i<=3;i++){
    const fx=x-dx*i*.3, fy=y-dy*i*.3;
    const fr=r*(1-i*.2)*.3;
    ctx.beginPath();ctx.arc(fx,fy,fr,0,Math.PI*2);
    ctx.fillStyle=`rgba(200,180,255,${.04/i})`;ctx.fill();
  }
  ctx.globalCompositeOperation='source-over';
  ctx.restore();
}

/* ============================================================
   CHAPTER 1: GRAVITY — Apple + Grid Warp
   ============================================================ */
function initCanvas1(){
  const canvas=document.getElementById('canvas1');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  let W,H;
    let groundY,treeX,treeTrunkTop,canopyY,appleStartY;
  let time=0;
  const apple={x:0,y:0,vy:0,phase:'hanging',timer:0,squashX:1,squashY:1};
  let newtonExpr=0;

  // Hyper-realistic additions
  const clouds=Array.from({length:4},(_,i)=>({x:i*80+Math.random()*60,y:20+Math.random()*40,w:50+Math.random()*40,speed:.08+Math.random()*.06}));
  const leaves=[];
  const grassTufts=Array.from({length:30},(_,i)=>({x:((i*31+7)%200),phase:Math.random()*Math.PI*2,h:8+Math.random()*6}));

  function resetApple(){
    apple.x=treeX+12;apple.y=appleStartY;apple.vy=0;apple.phase='hanging';apple.timer=0;apple.squashX=1;apple.squashY=1;newtonExpr=0;
  }

  function resize(){
    W=canvas.offsetWidth||700;H=canvas.offsetHeight||400;
    canvas.width=W;canvas.height=H;
    groundY=H*.78;treeX=W*.25;treeTrunkTop=groundY-180;canopyY=treeTrunkTop-40;appleStartY=canopyY+18;resetApple();
  }
  resize();window.addEventListener('resize',resize);

  // ========== LEFT SIDE: Newton's View ==========

  function drawSkyGradient(){
    const half=W/2;
    const g=ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#87ceeb');g.addColorStop(.4,'#a8d8f0');g.addColorStop(.7,'#c8e8c0');g.addColorStop(1,'#8ab858');
    ctx.fillStyle=g;ctx.fillRect(0,0,half,H);
  }

  function drawClouds(){
    const half=W/2;
    ctx.save();ctx.beginPath();ctx.rect(0,0,half,groundY);ctx.clip();
    clouds.forEach(c=>{
      c.x+=c.speed;if(c.x>half+60)c.x=-c.w-20;
      ctx.globalAlpha=.18;ctx.fillStyle='#ffffff';
      ctx.beginPath();ctx.ellipse(c.x,c.y,c.w*.5,8,0,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.ellipse(c.x+c.w*.25,c.y-5,c.w*.35,7,0,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.ellipse(c.x-c.w*.2,c.y+2,c.w*.3,6,0,0,Math.PI*2);ctx.fill();
    });
    ctx.globalAlpha=1;ctx.restore();
  }

  function spawnLeaf(){
    if(leaves.length<8&&Math.random()<.02){
      leaves.push({x:treeX+rand(-25,25),y:canopyY+rand(-15,5),vx:rand(-.3,.5),vy:rand(.2,.6),rot:0,rotV:rand(-.05,.05),life:1,size:rand(2,4)});
    }
  }

  function drawLeaves(){
    for(let i=leaves.length-1;i>=0;i--){
      const l=leaves[i];
      l.x+=l.vx+Math.sin(time*2+i)*.3;l.y+=l.vy;l.rot+=l.rotV;l.life-=.003;
      if(l.life<=0||l.y>groundY){leaves.splice(i,1);continue}
      ctx.save();ctx.translate(l.x,l.y);ctx.rotate(l.rot);
      ctx.fillStyle=`rgba(80,160,40,${l.life*.7})`;
      ctx.beginPath();ctx.ellipse(0,0,l.size,l.size*.5,0,0,Math.PI*2);ctx.fill();
      ctx.restore();
    }
  }

  function drawGrass(){
    const half=W/2;
    // Main grass base
    const g=ctx.createLinearGradient(0,groundY,0,H);
    g.addColorStop(0,'#5a9e3a');g.addColorStop(.3,'#4a8a2e');g.addColorStop(1,'#3a7020');
    ctx.fillStyle=g;ctx.fillRect(0,groundY,half,H-groundY);
    // Ground texture: dirt, pebbles, debris
    for(let i=0;i<15;i++){
      const px=((i*67+11)%Math.floor(half));const py=groundY+6+((i*41)%20);
      ctx.beginPath();ctx.ellipse(px,py,1.5+i%2,1+i%2*.5,(i*.3),0,Math.PI*2);
      ctx.fillStyle=`rgba(90,70,40,${.06+i%3*.02})`;ctx.fill();
    }
    // Scattered debris (tiny twigs)
    ctx.strokeStyle='rgba(80,50,20,.08)';ctx.lineWidth=.8;
    ctx.beginPath();ctx.moveTo(half*.3,groundY+4);ctx.lineTo(half*.3+8,groundY+5);ctx.stroke();
    ctx.beginPath();ctx.moveTo(half*.6,groundY+8);ctx.lineTo(half*.6+6,groundY+7);ctx.stroke();
    // Individual grass blades (denser, more detailed)
    for(let i=0;i<50;i++){
      const gx=((i*29+7)%Math.floor(half));const gy=groundY;
      const sway=Math.sin(time*1.8+i*.7)*3;
      const h=(grassTufts[i%30]?grassTufts[i%30].h:10)*(0.7+i%5*0.15);
      const shade=i%4;
      const colors=['rgba(90,170,55,.6)','rgba(110,190,72,.7)','rgba(80,160,45,.5)','rgba(100,180,65,.65)'];
      ctx.strokeStyle=colors[shade];ctx.lineWidth=shade<2?1.2:1.6;
      ctx.beginPath();ctx.moveTo(gx,gy);ctx.quadraticCurveTo(gx-3+sway,gy-h*.6,gx-2+sway*1.2,gy-h);ctx.stroke();
      if(i<30){
        ctx.strokeStyle=colors[(shade+1)%4];ctx.lineWidth=1;
        ctx.beginPath();ctx.moveTo(gx+1,gy);ctx.quadraticCurveTo(gx+4+sway,gy-h*.5,gx+3+sway*1.2,gy-h*.9);ctx.stroke();
      }
    }
    // Dandelion/wildflower
    ctx.fillStyle='rgba(255,255,200,.4)';
    const flowerX=half*.4,flowerY=groundY-12;
    ctx.beginPath();ctx.arc(flowerX,flowerY,2,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(80,150,40,.4)';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(flowerX,flowerY+2);ctx.lineTo(flowerX+1,groundY);ctx.stroke();
  }

  function drawTree(){
    // Trunk — tapered
    ctx.beginPath();
    ctx.moveTo(treeX-10,groundY);ctx.lineTo(treeX-7,treeTrunkTop);
    ctx.lineTo(treeX+7,treeTrunkTop);ctx.lineTo(treeX+10,groundY);ctx.closePath();
    const tg=ctx.createLinearGradient(treeX-10,0,treeX+10,0);
    tg.addColorStop(0,'#5a3a1a');tg.addColorStop(.3,'#7a5230');tg.addColorStop(.7,'#6a4425');tg.addColorStop(1,'#4a2e12');
    ctx.fillStyle=tg;ctx.fill();
    // Deep bark texture with grooves
    ctx.strokeStyle='rgba(40,20,5,.25)';ctx.lineWidth=1.2;
    for(let i=0;i<7;i++){
      const bx=treeX-7+i*2;
      ctx.beginPath();ctx.moveTo(bx,groundY);ctx.quadraticCurveTo(bx+(i%2?1.5:-1.5),treeTrunkTop+(groundY-treeTrunkTop)*.5,bx+.5,treeTrunkTop+5);ctx.stroke();
    }
    // Horizontal bark cracks
    ctx.strokeStyle='rgba(40,20,5,.12)';ctx.lineWidth=.6;
    for(let i=0;i<4;i++){
      const by=treeTrunkTop+10+i*18;
      ctx.beginPath();ctx.moveTo(treeX-8,by);ctx.quadraticCurveTo(treeX,by+2+i%2*2,treeX+8,by-1);ctx.stroke();
    }
    // Knot
    ctx.beginPath();ctx.ellipse(treeX+3,treeTrunkTop+25,3,4,0,0,Math.PI*2);
    ctx.strokeStyle='rgba(40,20,5,.15)';ctx.lineWidth=.8;ctx.stroke();
    // Moss patches on bark
    ctx.fillStyle='rgba(80,140,60,.15)';
    ctx.beginPath();ctx.ellipse(treeX-6,treeTrunkTop+35,4,2.5,.2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(treeX+5,treeTrunkTop+50,3,2,-.1,0,Math.PI*2);ctx.fill();
    // Lichen spots
    ctx.fillStyle='rgba(180,190,140,.1)';
    ctx.beginPath();ctx.arc(treeX-4,treeTrunkTop+15,2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(treeX+6,treeTrunkTop+40,1.5,0,Math.PI*2);ctx.fill();
    // Insect holes
    ctx.fillStyle='rgba(20,10,0,.2)';
    ctx.beginPath();ctx.arc(treeX+2,treeTrunkTop+18,.8,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(treeX-3,treeTrunkTop+42,.6,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(treeX+4,treeTrunkTop+55,.7,0,Math.PI*2);ctx.fill();
    // Branch stubs
    ctx.strokeStyle='#5a3a1a';ctx.lineWidth=4;
    ctx.beginPath();ctx.moveTo(treeX-4,treeTrunkTop+15);ctx.quadraticCurveTo(treeX-25,treeTrunkTop+5,treeX-30,treeTrunkTop-5);ctx.stroke();
    ctx.beginPath();ctx.moveTo(treeX+4,treeTrunkTop+10);ctx.quadraticCurveTo(treeX+22,treeTrunkTop,treeX+28,treeTrunkTop-10);ctx.stroke();

    // Canopy — overlapping circles with gradient
    const leaves=[
      {x:treeX,y:canopyY,r:38},{x:treeX-22,y:canopyY+8,r:30},{x:treeX+22,y:canopyY+8,r:30},
      {x:treeX-12,y:canopyY-18,r:28},{x:treeX+12,y:canopyY-18,r:28},
      {x:treeX,y:canopyY-28,r:24},{x:treeX-28,y:canopyY-5,r:22},{x:treeX+28,y:canopyY-5,r:22},
    ];
    // Shadow under canopy
    ctx.beginPath();ctx.ellipse(treeX,canopyY+15,44,12,0,0,Math.PI*2);ctx.fillStyle='rgba(20,60,10,.15)';ctx.fill();
    // Leaves
    leaves.forEach(l=>{
      const lg=ctx.createRadialGradient(l.x-l.r*.2,l.y-l.r*.3,l.r*.1,l.x,l.y,l.r);
      lg.addColorStop(0,'#6cc848');lg.addColorStop(.4,'#4aa830');lg.addColorStop(.7,'#3a8a22');lg.addColorStop(1,'#2a6a18');
      ctx.beginPath();ctx.arc(l.x,l.y,l.r,0,Math.PI*2);ctx.fillStyle=lg;ctx.fill();
    });
    // Leaf highlights
    leaves.slice(0,4).forEach(l=>{
      ctx.beginPath();ctx.arc(l.x-l.r*.15,l.y-l.r*.2,l.r*.45,0,Math.PI*2);
      ctx.fillStyle='rgba(140,230,100,.12)';ctx.fill();
    });
  }

  function drawApple(x,y,sx,sy){
    ctx.save();ctx.translate(x,y);ctx.scale(sx,sy);
    ctx.beginPath();ctx.arc(0,0,10,0,Math.PI*2);
    const g=ctx.createRadialGradient(-3,-3,1,0,0,10);
    g.addColorStop(0,'#ff6655');g.addColorStop(.3,'#ee3322');g.addColorStop(.7,'#cc1111');g.addColorStop(1,'#880000');
    ctx.fillStyle=g;ctx.fill();
    // Apple skin texture — tiny speckles
    for(let i=0;i<20;i++){
      const ax=(Math.sin(i*73.1)*.8)*8,ay=(Math.cos(i*137.3)*.8)*8;
      if(ax*ax+ay*ay<81){ctx.beginPath();ctx.arc(ax,ay,.4+Math.random()*.3,0,Math.PI*2);ctx.fillStyle=`rgba(180,20,0,${.05+Math.random()*.08})`;ctx.fill();}
    }
    // Bruise imperfection
    ctx.beginPath();ctx.ellipse(4,3,2.5,1.8,.3,0,Math.PI*2);ctx.fillStyle='rgba(100,30,10,.08)';ctx.fill();
    // Primary highlight (large)
    ctx.beginPath();ctx.arc(-3,-3,4,0,Math.PI*2);ctx.fillStyle='rgba(255,210,210,.4)';ctx.fill();
    // Secondary highlight (small, lower)
    ctx.beginPath();ctx.arc(2,2,2,0,Math.PI*2);ctx.fillStyle='rgba(255,180,180,.2)';ctx.fill();
    // Rim light
    ctx.beginPath();ctx.arc(0,0,10,0,Math.PI*2);
    ctx.strokeStyle='rgba(255,120,120,.15)';ctx.lineWidth=1;ctx.stroke();
    // Stem with wood grain
    ctx.beginPath();ctx.moveTo(0,-10);ctx.quadraticCurveTo(2,-16,3,-14);ctx.strokeStyle='#5a3a1a';ctx.lineWidth=1.8;ctx.stroke();
    ctx.beginPath();ctx.moveTo(.5,-10);ctx.quadraticCurveTo(1.5,-14,2,-13);ctx.strokeStyle='rgba(80,50,20,.3)';ctx.lineWidth=.3;ctx.stroke();
    ctx.beginPath();ctx.moveTo(-.3,-10);ctx.quadraticCurveTo(1,-15,2.5,-14.5);ctx.strokeStyle='rgba(70,40,15,.2)';ctx.lineWidth=.25;ctx.stroke();
    // Leaf on stem with vein + serrated edge
    ctx.beginPath();ctx.moveTo(1,-12);ctx.quadraticCurveTo(3,-14,5,-13);ctx.quadraticCurveTo(6.5,-13.5,7,-10);ctx.quadraticCurveTo(5,-10.5,3,-11);ctx.closePath();
    ctx.fillStyle='#3a8a22';ctx.fill();
    ctx.beginPath();ctx.moveTo(2,-12);ctx.quadraticCurveTo(4.5,-12.5,6,-10.5);ctx.strokeStyle='rgba(30,70,15,.3)';ctx.lineWidth=.4;ctx.stroke();
    // Leaf veins (secondary)
    ctx.beginPath();ctx.moveTo(3,-11.8);ctx.lineTo(4.5,-11);ctx.strokeStyle='rgba(30,70,15,.15)';ctx.lineWidth=.2;ctx.stroke();
    ctx.beginPath();ctx.moveTo(4,-12);ctx.lineTo(5.5,-11.2);ctx.stroke();
    // Calyx (bottom indent)
    ctx.beginPath();ctx.moveTo(-1.5,9);ctx.quadraticCurveTo(0,8,1.5,9);ctx.strokeStyle='rgba(60,30,10,.15)';ctx.lineWidth=.5;ctx.stroke();
    ctx.restore();
  }

  function drawNewton(){
    const nx=treeX+2, ny=groundY;
    ctx.save();ctx.translate(nx,ny);

    // Legs stretched out
    ctx.fillStyle='#3a3a5a';
    ctx.beginPath();ctx.ellipse(18,-6,22,6,-.1,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(14,-8,20,5,.1,0,Math.PI*2);ctx.fill();
    // Shoes with buckle detail
    ctx.fillStyle='#2a1a0a';
    ctx.beginPath();ctx.ellipse(38,-5,8,5,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(32,-7,7,4,.15,0,Math.PI*2);ctx.fill();
    // Shoe buckles
    ctx.strokeStyle='#c8a840';ctx.lineWidth=.8;
    ctx.beginPath();ctx.rect(36,-7,4,3);ctx.stroke();
    ctx.beginPath();ctx.rect(30,-9,3.5,2.5);ctx.stroke();
    // Buckle shine
    ctx.fillStyle='rgba(255,220,100,.2)';
    ctx.fillRect(36.5,-6.5,1.5,1);ctx.fillRect(30.5,-8.5,1.2,.8);

    // Body — long coat with fabric texture
    ctx.fillStyle='#4a6a8a';
    ctx.beginPath();
    ctx.moveTo(-8,-10);ctx.quadraticCurveTo(-12,-30,-10,-48);
    ctx.lineTo(12,-48);ctx.quadraticCurveTo(14,-30,10,-10);ctx.closePath();ctx.fill();
    // Fabric texture (subtle highlights)
    ctx.beginPath();ctx.moveTo(-6,-10);ctx.quadraticCurveTo(-8,-30,-6,-48);
    ctx.strokeStyle='rgba(100,140,170,.08)';ctx.lineWidth=1.2;ctx.stroke();
    ctx.beginPath();ctx.moveTo(6,-10);ctx.quadraticCurveTo(8,-30,6,-48);ctx.stroke();
    // Fabric wrinkle near waist
    ctx.beginPath();ctx.moveTo(-8,-14);ctx.quadraticCurveTo(0,-12,10,-14);
    ctx.strokeStyle='rgba(30,50,70,.15)';ctx.lineWidth=.6;ctx.stroke();
    // Coat details
    ctx.strokeStyle='rgba(30,50,70,.3)';ctx.lineWidth=.8;
    ctx.beginPath();ctx.moveTo(1,-48);ctx.lineTo(1,-10);ctx.stroke();
    // Buttons
    ctx.fillStyle='#c8b060';
    [  -42,-36,-30,-24].forEach(by=>{ctx.beginPath();ctx.arc(1,by,1.5,0,Math.PI*2);ctx.fill();});

    // Arms
    ctx.strokeStyle='#4a6a8a';ctx.lineWidth=7;ctx.lineCap='round';
    // Left arm resting on lap
    ctx.beginPath();ctx.moveTo(-8,-40);ctx.quadraticCurveTo(-14,-28,4,-14);ctx.stroke();
    // Right arm resting
    ctx.beginPath();ctx.moveTo(10,-40);ctx.quadraticCurveTo(16,-28,12,-14);ctx.stroke();
    // Hands
    ctx.fillStyle='#f0c898';
    ctx.beginPath();ctx.arc(4,-13,4,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(12,-13,4,0,Math.PI*2);ctx.fill();

    // Wig — white curls with texture
    const headY=-60;
    ctx.fillStyle='#e8e0d4';
    // Side curls
    [{x:-14,y:headY+6,r:7},{x:16,y:headY+6,r:7},{x:-12,y:headY-2,r:6},{x:14,y:headY-2,r:6}].forEach(c=>{
      ctx.beginPath();ctx.arc(c.x,c.y,c.r,0,Math.PI*2);ctx.fill();
      // Curl wrinkle detail
      ctx.beginPath();ctx.arc(c.x,c.y,c.r*.7,0,Math.PI*2);
      ctx.strokeStyle='rgba(180,170,150,.2)';ctx.lineWidth=.5;ctx.stroke();
      ctx.beginPath();ctx.arc(c.x+1,c.y+1,c.r*.4,0,Math.PI*2);
      ctx.strokeStyle='rgba(170,160,140,.15)';ctx.lineWidth=.4;ctx.stroke();
    });
    // Top curls
    [{x:-6,y:headY-12,r:7},{x:4,y:headY-14,r:7},{x:10,y:headY-10,r:6},{x:-2,y:headY-10,r:8}].forEach(c=>{
      ctx.beginPath();ctx.arc(c.x,c.y,c.r,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(c.x,c.y,c.r*.65,0,Math.PI*2);
      ctx.strokeStyle='rgba(180,170,150,.18)';ctx.lineWidth=.5;ctx.stroke();
    });
    // Wig highlight sheen
    ctx.beginPath();ctx.ellipse(-2,headY-12,12,5,0,Math.PI+.3,-.3);
    ctx.fillStyle='rgba(255,255,250,.1)';ctx.fill();

    // Head
    const hg=ctx.createRadialGradient(-2,headY-2,3,1,headY,16);
    hg.addColorStop(0,'#fde8cc');hg.addColorStop(.7,'#f0c898');hg.addColorStop(1,'#dba56a');
    ctx.beginPath();ctx.arc(1,headY,15,0,Math.PI*2);ctx.fillStyle=hg;ctx.fill();

    // Rosy cheeks
    ctx.fillStyle='rgba(255,120,100,.2)';
    ctx.beginPath();ctx.arc(-9,headY+4,5,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(11,headY+4,5,0,Math.PI*2);ctx.fill();

    // Eyes — expression changes
    if(newtonExpr<.5){
      // Relaxed, looking up
      ctx.fillStyle='white';
      ctx.beginPath();ctx.ellipse(-5,headY-2,5,5.5,0,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.ellipse(7,headY-2,5,5.5,0,0,Math.PI*2);ctx.fill();
      // Pupils looking up
      ctx.fillStyle='#2a1808';
      ctx.beginPath();ctx.arc(-5,headY-4,2.5,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(7,headY-4,2.5,0,Math.PI*2);ctx.fill();
      // Highlights
      ctx.fillStyle='white';
      ctx.beginPath();ctx.arc(-4,headY-5,1.2,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(8,headY-5,1.2,0,Math.PI*2);ctx.fill();
      // Relaxed mouth — slight smile
      ctx.beginPath();ctx.moveTo(-4,headY+8);ctx.quadraticCurveTo(1,headY+12,6,headY+8);
      ctx.strokeStyle='rgba(140,80,40,.5)';ctx.lineWidth=1.5;ctx.stroke();
    } else {
      // Surprised/hurt — big round eyes, open mouth
      ctx.fillStyle='white';
      ctx.beginPath();ctx.ellipse(-5,headY-2,6,7,0,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.ellipse(7,headY-2,6,7,0,0,Math.PI*2);ctx.fill();
      // Tiny pupils (shock)
      ctx.fillStyle='#2a1808';
      ctx.beginPath();ctx.arc(-5,headY-2,2,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(7,headY-2,2,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='white';
      ctx.beginPath();ctx.arc(-4,headY-3,1,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(8,headY-3,1,0,Math.PI*2);ctx.fill();
      // Open surprised mouth
      ctx.beginPath();ctx.ellipse(1,headY+9,5,4,0,0,Math.PI*2);
      ctx.fillStyle='rgba(80,30,20,.6)';ctx.fill();
      // Stars around head
      const starT=time*3;
      ctx.fillStyle='#ffd700';
      for(let s=0;s<3;s++){
        const sa=starT+s*Math.PI*2/3;
        const sx=1+Math.cos(sa)*22, sy=headY-14+Math.sin(sa)*8;
        ctx.font='10px serif';ctx.fillText('✦',sx-4,sy+4);
      }
    }

    // Nose
    ctx.beginPath();ctx.moveTo(1,headY);ctx.quadraticCurveTo(4,headY+5,1,headY+5);
    ctx.strokeStyle='rgba(180,120,60,.4)';ctx.lineWidth=1.2;ctx.stroke();

    // Eyebrows
    if(newtonExpr<.5){
      ctx.strokeStyle='rgba(100,70,35,.6)';ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(-10,headY-8);ctx.quadraticCurveTo(-5,headY-11,0,headY-8);ctx.stroke();
      ctx.beginPath();ctx.moveTo(2,headY-8);ctx.quadraticCurveTo(7,headY-11,12,headY-8);ctx.stroke();
    } else {
      // Raised eyebrows (surprise)
      ctx.strokeStyle='rgba(100,70,35,.7)';ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(-10,headY-11);ctx.quadraticCurveTo(-5,headY-15,0,headY-11);ctx.stroke();
      ctx.beginPath();ctx.moveTo(2,headY-11);ctx.quadraticCurveTo(7,headY-15,12,headY-11);ctx.stroke();
    }

    ctx.restore();
  }

  // ========== RIGHT SIDE: Einstein's curved spacetime ==========

  // Orbiting dots
  const orbiters=[];
  for(let i=0;i<5;i++){
    orbiters.push({angle:i*Math.PI*2/5, radius:50+i*18, speed:.3+i*.08, size:2+Math.random()*2});
  }

  function drawRightSide(){
    const half=W/2;
    const rW=W-half;
    // Dark space background
    const bg=ctx.createLinearGradient(half,0,W,H);
    bg.addColorStop(0,'#12051f');bg.addColorStop(.5,'#1a0a2e');bg.addColorStop(1,'#0a0312');
    ctx.fillStyle=bg;ctx.fillRect(half,0,rW,H);

    // Stars with varying sizes and slow twinkle
    ctx.save();ctx.beginPath();ctx.rect(half,0,rW,H);ctx.clip();
    for(let i=0;i<80;i++){
      const sx=half+(Math.sin(i*127.1+i*311.7)*.5+.5)*rW;
      const sy=(Math.sin(i*269.5+i*183.3)*.5+.5)*H;
      const twinkle=.3+.7*Math.sin(time*.8+i*2.3);
      const sr=.4+1.8*(i%7===0?1:i%3===0?.6:.3);
      ctx.beginPath();ctx.arc(sx,sy,sr*(.7+twinkle*.3),0,Math.PI*2);
      ctx.fillStyle=`rgba(200,210,255,${twinkle*.5})`;ctx.fill();
      // Glow on brighter stars
      if(i%5===0&&twinkle>.6){
        ctx.beginPath();ctx.arc(sx,sy,sr*3,0,Math.PI*2);
        ctx.fillStyle=`rgba(180,200,255,${(twinkle-.6)*.12})`;ctx.fill();
      }
    }
    ctx.restore();

    // Curved spacetime grid
    const gridCx=half+rW*.5, gridCy=H*.55;
    const spacing=28;
    const gridW=Math.ceil(rW/spacing)+2, gridH=Math.ceil(H/spacing)+2;
    const mass=1.2+.2*Math.sin(time*.8);
    const warpR=160;

    ctx.save();ctx.beginPath();ctx.rect(half,0,rW,H);ctx.clip();
    ctx.strokeStyle='rgba(100,140,220,.22)';ctx.lineWidth=.8;

    // Horizontal grid lines
    for(let r=0;r<=gridH;r++){
      ctx.beginPath();
      for(let c=0;c<=gridW;c++){
        let gx=half+c*spacing-spacing;
        let gy=r*spacing+H*.2;
        const d=dist(gx,gy,gridCx,gridCy);
        if(d<warpR){
          const pull=mass*50/(d+25);
          const angle=Math.atan2(gridCy-gy,gridCx-gx);
          gx+=Math.cos(angle)*pull;gy+=Math.sin(angle)*pull;
        }
        c===0?ctx.moveTo(gx,gy):ctx.lineTo(gx,gy);
      }
      ctx.stroke();
    }
    // Vertical grid lines
    for(let c=0;c<=gridW;c++){
      ctx.beginPath();
      for(let r=0;r<=gridH;r++){
        let gx=half+c*spacing-spacing;
        let gy=r*spacing+H*.2;
        const d=dist(gx,gy,gridCx,gridCy);
        if(d<warpR){
          const pull=mass*50/(d+25);
          const angle=Math.atan2(gridCy-gy,gridCx-gx);
          gx+=Math.cos(angle)*pull;gy+=Math.sin(angle)*pull;
        }
        r===0?ctx.moveTo(gx,gy):ctx.lineTo(gx,gy);
      }
      ctx.stroke();
    }

    // Central mass / planet
    const pR=18+2*Math.sin(time*1.5);
    const pg=ctx.createRadialGradient(gridCx-4,gridCy-4,3,gridCx,gridCy,pR+8);
    pg.addColorStop(0,'#aaccff');pg.addColorStop(.3,'#6688cc');pg.addColorStop(.7,'#3355aa');pg.addColorStop(1,'rgba(30,40,80,0)');
    ctx.beginPath();ctx.arc(gridCx,gridCy,pR+8,0,Math.PI*2);ctx.fillStyle=pg;ctx.fill();
    // Ambient glow around mass
    const ambG=ctx.createRadialGradient(gridCx,gridCy,pR,gridCx,gridCy,pR+45);
    ambG.addColorStop(0,'rgba(120,160,255,.12)');ambG.addColorStop(.5,`rgba(100,140,240,${.04+.03*Math.sin(time*1.2)})`);ambG.addColorStop(1,'rgba(60,80,180,0)');
    ctx.beginPath();ctx.arc(gridCx,gridCy,pR+45,0,Math.PI*2);ctx.fillStyle=ambG;ctx.fill();

    ctx.beginPath();ctx.arc(gridCx,gridCy,pR,0,Math.PI*2);
    const pg2=ctx.createRadialGradient(gridCx-5,gridCy-5,2,gridCx,gridCy,pR);
    pg2.addColorStop(0,'#ddeeff');pg2.addColorStop(.5,'#8899cc');pg2.addColorStop(1,'#445588');
    ctx.fillStyle=pg2;ctx.fill();

    // Orbiting dots rolling along curved grid
    orbiters.forEach(o=>{
      o.angle+=o.speed*.016;
      const ox=gridCx+Math.cos(o.angle)*o.radius;
      const oy=gridCy+Math.sin(o.angle)*o.radius*.5; // elliptical
      // Warp pull toward center
      const d=dist(ox,oy,gridCx,gridCy);
      const pull=mass*15/(d+30);
      const a2=Math.atan2(gridCy-oy,gridCx-ox);
      const fx=ox+Math.cos(a2)*pull;
      const fy=oy+Math.sin(a2)*pull;
      // Trail
      ctx.beginPath();ctx.arc(fx,fy,o.size+1,0,Math.PI*2);ctx.fillStyle='rgba(140,180,255,.1)';ctx.fill();
      ctx.beginPath();ctx.arc(fx,fy,o.size,0,Math.PI*2);
      ctx.fillStyle='rgba(180,210,255,.7)';ctx.fill();
    });

    ctx.restore();

    // "Einstein's View — 1915" label
    ctx.font='bold 13px Georgia, serif';ctx.textAlign='center';
    ctx.fillStyle='rgba(140,160,220,.7)';
    ctx.fillText("Einstein's View — 1915",half+rW*.5,24);
  }

  // ========== DIVIDER ==========
  function drawDivider(){
    const half=W/2;
    const dg=ctx.createLinearGradient(half-8,0,half+8,0);
    dg.addColorStop(0,'rgba(90,140,70,.0)');dg.addColorStop(.3,'rgba(60,70,90,.4)');
    dg.addColorStop(.5,'rgba(100,120,160,.6)');dg.addColorStop(.7,'rgba(60,70,90,.4)');
    dg.addColorStop(1,'rgba(30,20,60,.0)');
    ctx.fillStyle=dg;ctx.fillRect(half-8,0,16,H);
  }

  // Newton's head Y for apple targeting
  function newtonHeadY(){return groundY-60;}

  function animate(){
  try{
    time+=.016;ctx.clearRect(0,0,W,H);

    // === LEFT SIDE ===
    ctx.save();ctx.beginPath();ctx.rect(0,0,W/2,H);ctx.clip();
    drawSkyGradient();
    drawGrass();
    drawTree();

    // Apple animation
    const headHitY=newtonHeadY()-15;
    if(apple.phase==='hanging'){
      apple.timer+=.016;
      // Gentle sway while hanging
      apple.x=treeX+12+Math.sin(time*2)*1.5;
      apple.y=appleStartY+Math.sin(time*3)*.5;
      if(apple.timer>2.0){apple.phase='fall';apple.timer=0;apple.vy=0;}
    } else if(apple.phase==='fall'){
      apple.vy+=.08; // gravity acceleration (slow dramatic fall)
      apple.y+=apple.vy;
      if(apple.y>=headHitY){
        apple.y=headHitY;
        apple.phase='impact';apple.timer=0;
        apple.squashX=1.5;apple.squashY=.6;
        newtonExpr=1;
      }
    } else if(apple.phase==='impact'){
      apple.timer+=.016;
      apple.squashX=lerp(apple.squashX,1,.06);
      apple.squashY=lerp(apple.squashY,1,.06);
      // Apple sits on Newton's head briefly
      apple.x=treeX+2;apple.y=headHitY;
      if(apple.timer>2.5){
        apple.phase='hanging';apple.timer=0;
        apple.squashX=1;apple.squashY=1;
        apple.x=treeX+12;apple.y=appleStartY;
        newtonExpr=0;
      }
    }

    // Soft ambient shadow under Newton
    ctx.beginPath();ctx.ellipse(treeX+20,groundY+2,35,5,0,0,Math.PI*2);
    ctx.fillStyle='rgba(0,0,0,.1)';ctx.fill();

    drawClouds();
    spawnLeaf();
    drawLeaves();
    drawApple(apple.x,apple.y,apple.squashX,apple.squashY);
    drawNewton();

    // "Newton's View — 1687" label
    ctx.font='bold 13px Georgia, serif';ctx.textAlign='center';
    ctx.fillStyle='rgba(60,40,20,.6)';
    ctx.fillText("Newton's View — 1687",W*.25,24);
    ctx.restore();

    // === RIGHT SIDE ===
    drawRightSide();

    // === DIVIDER ===
    drawDivider();

    // Volumetric atmosphere — warm golden hour haze on left side
    ctx.save();ctx.globalAlpha=.03;
    const haze=ctx.createLinearGradient(0,0,W/2,0);
    haze.addColorStop(0,'rgba(255,220,150,.0)');haze.addColorStop(.5,'rgba(255,200,120,.15)');
    haze.addColorStop(1,'rgba(255,180,100,0)');
    ctx.fillStyle=haze;ctx.fillRect(0,0,W/2,H);
    ctx.restore();

    // Depth-of-field: subtle blur at edges (vignette-like soft focus)
    ctx.save();ctx.globalAlpha=.06;
    const dofG=ctx.createRadialGradient(W*.35,H*.5,W*.15,W*.35,H*.5,W*.5);
    dofG.addColorStop(0,'rgba(0,0,0,0)');dofG.addColorStop(.7,'rgba(0,0,0,0)');
    dofG.addColorStop(1,'rgba(0,0,0,.3)');
    ctx.fillStyle=dofG;ctx.fillRect(0,0,W/2,H);
    ctx.restore();

    // Ambient occlusion shadow at ground/tree junction
    ctx.save();ctx.globalAlpha=.08;
    ctx.beginPath();ctx.ellipse(treeX,groundY,20,4,0,0,Math.PI*2);
    ctx.fillStyle='rgba(20,40,10,.5)';ctx.fill();
    ctx.restore();

  }catch(err){console.error('Ch1:',err);return;}
    requestAnimationFrame(animate);
  }
  animate();
}

/* ============================================================
   CHAPTER 2: SPACE-TIME FABRIC — Lightweight Pre-projected Grid
   ============================================================ */
function initCanvas2(){
  const canvas=document.getElementById('canvas2');if(!canvas)return;
  const dpr=Math.min(window.devicePixelRatio||1, 2);
  const ctx=canvas.getContext('2d');
  let W,H;

  // Grid config
  const LINES=15;
  // Pre-computed grid points (filled on resize)
  let grid=null; // grid[row][col] = {x, y} in screen coords

  function buildGrid(){
    // Simple 2D symmetrical rectangular grid filling the full canvas
    grid=[];
    for(let r=0;r<LINES;r++){
      const row=[];
      const rowY=r/(LINES-1)*H;
      for(let c=0;c<LINES;c++){
        const px=c/(LINES-1)*W;
        row.push({x:px, y:rowY});
      }
      grid.push(row);
    }
  }

  function resize(){
    W=canvas.offsetWidth; H=canvas.offsetHeight;
    canvas.width=W*dpr; canvas.height=H*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
    buildGrid();
  }
  resize();window.addEventListener('resize',()=>{resize()});

  // Smooth warp position (lerp toward touch)
  let warpX=-9999, warpY=-9999;
  let touching=false;
  let warpStrength=0;
  let rawTouchX=-9999, rawTouchY=-9999;

  const WARP_RADIUS=120; // pixels
  const R2=WARP_RADIUS*WARP_RADIUS;

  canvas.addEventListener('mousemove',e=>{
    const r=canvas.getBoundingClientRect();
    rawTouchX=e.clientX-r.left; rawTouchY=e.clientY-r.top; touching=true;
  });
  canvas.addEventListener('mouseleave',()=>{touching=false});
  canvas.addEventListener('touchstart',e=>{
    e.preventDefault();const r=canvas.getBoundingClientRect();const t=e.touches[0];
    rawTouchX=t.clientX-r.left; rawTouchY=t.clientY-r.top; touching=true;
    warpX=rawTouchX; warpY=rawTouchY; // snap on first touch
  },{passive:false});
  canvas.addEventListener('touchmove',e=>{
    e.preventDefault();const r=canvas.getBoundingClientRect();const t=e.touches[0];
    rawTouchX=t.clientX-r.left; rawTouchY=t.clientY-r.top;
  },{passive:false});
  canvas.addEventListener('touchend',()=>{touching=false});

  // IntersectionObserver: only animate when visible
  let ch2Visible=false;
  let animId=null;
  const ch2Observer=new IntersectionObserver(entries=>{
    ch2Visible=entries[0].isIntersecting;
    if(ch2Visible&&!animId) animId=requestAnimationFrame(animate);
  },{threshold:0.05});
  ch2Observer.observe(canvas);

  // Floating dust particles
  const ch2Dust=Array.from({length:30},()=>({x:Math.random(),y:Math.random(),vx:(Math.random()-.5)*.001,vy:(Math.random()-.5)*.001,r:Math.random()*1.5+.5,a:Math.random()*.4+.1}));
  // Ripple rings
  const ch2Ripples=[];
  let ch2Time=0;
  let lastRippleTime=0;

  function animate(){
    animId=null;
    if(!grid) {if(ch2Visible) animId=requestAnimationFrame(animate); return;}
    ctx.clearRect(0,0,W,H);
    ch2Time+=.016;

    // Lerp smoothing on warp position (0.3 = fast but smooth)
    if(touching){
      warpX+=(rawTouchX-warpX)*0.3;
      warpY+=(rawTouchY-warpY)*0.3;
      warpStrength+=(1-warpStrength)*0.3;
      // Spawn ripple on touch
      if(ch2Time-lastRippleTime>.3){
        ch2Ripples.push({x:warpX,y:warpY,r:0,a:1});
        lastRippleTime=ch2Time;
      }
    } else {
      warpStrength*=0.92;
    }

    const doWarp=warpStrength>0.005;
    const str=warpStrength;
    const wx=warpX, wy=warpY;

    // Compute warped Y offsets into a flat array for speed
    const N=LINES*LINES;
    const offY=new Float32Array(N);
    const warpIntensity=new Float32Array(N);// for gradient coloring
    if(doWarp){
      for(let r=0;r<LINES;r++){
        const row=grid[r];
        const base=r*LINES;
        for(let c=0;c<LINES;c++){
          const dx=row[c].x-wx, dy=row[c].y-wy;
          const d2=dx*dx+dy*dy;
          if(d2<R2){
            const f=1-d2/R2;
            offY[base+c]=str*f*f*40;
            warpIntensity[base+c]=f*str;
          }
        }
      }
    }

    // Draw grid lines with gradient coloring (gold → purple based on warp)
    ctx.lineWidth=1;
    // Horizontal lines
    for(let r=0;r<LINES;r++){
      const row=grid[r], base=r*LINES;
      for(let c=0;c<LINES-1;c++){
        const wi=(warpIntensity[base+c]+warpIntensity[base+c+1])*.5;
        const rr=Math.floor(140+100*wi);
        const gg=Math.floor(150-10*wi);
        const bb=Math.floor(220-120*wi);
        ctx.strokeStyle=`rgba(${rr},${gg},${bb},${.2+wi*.3})`;
        ctx.beginPath();
        ctx.moveTo(row[c].x, row[c].y+offY[base+c]);
        ctx.lineTo(row[c+1].x, row[c+1].y+offY[base+c+1]);
        ctx.stroke();
      }
    }
    // Vertical lines
    for(let c=0;c<LINES;c++){
      for(let r=0;r<LINES-1;r++){
        const wi=(warpIntensity[r*LINES+c]+warpIntensity[(r+1)*LINES+c])*.5;
        const rr=Math.floor(140+100*wi);
        const gg=Math.floor(150-10*wi);
        const bb=Math.floor(220-120*wi);
        ctx.strokeStyle=`rgba(${rr},${gg},${bb},${.2+wi*.3})`;
        ctx.beginPath();
        ctx.moveTo(grid[r][c].x, grid[r][c].y+offY[r*LINES+c]);
        ctx.lineTo(grid[r+1][c].x, grid[r+1][c].y+offY[(r+1)*LINES+c]);
        ctx.stroke();
      }
    }

    // Glow/pulse at warp center
    if(doWarp&&str>.05){
      const glowR=20+15*Math.sin(ch2Time*4);
      const gg=ctx.createRadialGradient(wx,wy,2,wx,wy+offY[0],glowR);
      gg.addColorStop(0,`rgba(240,192,96,${str*.5})`);
      gg.addColorStop(.5,`rgba(200,160,220,${str*.2})`);
      gg.addColorStop(1,'rgba(140,100,200,0)');
      ctx.beginPath();ctx.arc(wx,wy,glowR,0,Math.PI*2);ctx.fillStyle=gg;ctx.fill();
    }

    // Floating dust particles warped by touch
    ch2Dust.forEach(p=>{
      p.x+=p.vx;p.y+=p.vy;
      if(p.x<0||p.x>1)p.vx*=-1;
      if(p.y<0||p.y>1)p.vy*=-1;
      let px=p.x*W,py=p.y*H;
      if(doWarp){
        const dx=px-wx,dy=py-wy;
        const d2=dx*dx+dy*dy;
        if(d2<R2){
          const f=1-d2/R2;
          py+=str*f*f*40;
        }
      }
      ctx.beginPath();ctx.arc(px,py,p.r,0,Math.PI*2);
      ctx.fillStyle=`rgba(200,180,240,${p.a*(.5+str*.5)})`;ctx.fill();
    });

    // Ripple rings radiating outward
    for(let i=ch2Ripples.length-1;i>=0;i--){
      const rp=ch2Ripples[i];
      rp.r+=2;rp.a*=.97;
      if(rp.a<.01){ch2Ripples.splice(i,1);continue}
      ctx.beginPath();ctx.arc(rp.x,rp.y,rp.r,0,Math.PI*2);
      ctx.strokeStyle=`rgba(240,192,96,${rp.a*.3})`;ctx.lineWidth=1.5;ctx.stroke();
    }

    if(ch2Visible) animId=requestAnimationFrame(animate);
  }
  animate();
}

/* ============================================================
   CHAPTER 3: TIME DILATION — Two Clocks
   ============================================================ */
function initCanvas3(){
  const canvas=document.getElementById('canvas3');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  let W,H;function resize(){W=canvas.width=canvas.offsetWidth;H=canvas.height=canvas.offsetHeight}
  resize();window.addEventListener('resize',resize);
  let time=0;
  const roman=['XII','I','II','III','IV','V','VI','VII','VIII','IX','X','XI'];
  // Pendulum state
  const pendulums={left:{angle:0,vel:0},right:{angle:0,vel:0}};

  function drawClock(cx,cy,radius,speed,label,bgColor,isRight){
    // Clock face with metallic sheen
    const bg=ctx.createRadialGradient(cx-radius*.15,cy-radius*.15,radius*.05,cx,cy,radius);
    bg.addColorStop(0,isRight?'#2a1a10':'#2a2218');
    bg.addColorStop(.3,bgColor);
    bg.addColorStop(.7,'rgba(20,15,10,.85)');
    bg.addColorStop(1,'rgba(0,0,0,.95)');
    ctx.beginPath();ctx.arc(cx,cy,radius,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();
    // Metallic rim
    const rimG=ctx.createLinearGradient(cx-radius,cy-radius,cx+radius,cy+radius);
    rimG.addColorStop(0,'rgba(200,180,140,.5)');rimG.addColorStop(.3,'rgba(255,240,200,.3)');
    rimG.addColorStop(.5,'rgba(200,180,140,.5)');rimG.addColorStop(.7,'rgba(255,240,200,.3)');
    rimG.addColorStop(1,'rgba(200,180,140,.5)');
    ctx.strokeStyle=rimG;ctx.lineWidth=3;ctx.stroke();
    // Inner rim
    ctx.beginPath();ctx.arc(cx,cy,radius-4,0,Math.PI*2);ctx.strokeStyle='rgba(160,140,100,.2)';ctx.lineWidth=1;ctx.stroke();

    // Second hand angle for glow detection
    const secAngle=time*speed*Math.PI*2/60-Math.PI/2;
    const secNorm=((time*speed*Math.PI*2/60)%(Math.PI*2));

    // Tick marks with glow when second hand passes
    for(let i=0;i<12;i++){
      const a=i*Math.PI/6-Math.PI/2;
      const tickAngle=((i*Math.PI/6)%(Math.PI*2));
      const angleDiff=Math.abs(secNorm-tickAngle);
      const glowFactor=angleDiff<.3?1-angleDiff/.3:0;
      const x1=cx+Math.cos(a)*(radius-4);const y1=cy+Math.sin(a)*(radius-4);
      const x2=cx+Math.cos(a)*(radius-18);const y2=cy+Math.sin(a)*(radius-18);
      if(glowFactor>0){
        ctx.shadowColor=`rgba(240,200,100,${glowFactor*.6})`;ctx.shadowBlur=8;
      }
      ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);
      ctx.strokeStyle=`rgba(255,${220+Math.floor(glowFactor*35)},${180+Math.floor(glowFactor*75)},${.5+glowFactor*.4})`;
      ctx.lineWidth=i%3===0?2.5:1;ctx.stroke();
      ctx.shadowBlur=0;
      const tx=cx+Math.cos(a)*(radius-32);const ty=cy+Math.sin(a)*(radius-32);
      ctx.fillStyle='rgba(255,255,255,.7)';ctx.font=`${radius*.13}px Georgia`;ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(roman[i],tx,ty);
    }
    // Minute marks
    for(let i=0;i<60;i++){const a=i*Math.PI/30-Math.PI/2;const x1=cx+Math.cos(a)*(radius-4);const y1=cy+Math.sin(a)*(radius-4);const x2=cx+Math.cos(a)*(radius-10);const y2=cy+Math.sin(a)*(radius-10);ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.strokeStyle='rgba(255,255,255,.2)';ctx.lineWidth=.5;ctx.stroke()}

    // Hands
    const minAngle=time*speed*Math.PI*2/3600-Math.PI/2;
    const hrAngle=time*speed*Math.PI*2/43200-Math.PI/2;
    // Hour
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(hrAngle)*radius*.5,cy+Math.sin(hrAngle)*radius*.5);
    ctx.strokeStyle='#e0b050';ctx.lineWidth=3.5;ctx.lineCap='round';ctx.stroke();
    // Minute
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(minAngle)*radius*.7,cy+Math.sin(minAngle)*radius*.7);
    ctx.strokeStyle='#f0e0c8';ctx.lineWidth=2.5;ctx.stroke();
    // Second hand trailing afterimage
    for(let t=3;t>=0;t--){
      const trailAngle=secAngle-t*.04*speed;
      const trailAlpha=.08*(3-t);
      ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(trailAngle)*radius*.8,cy+Math.sin(trailAngle)*radius*.8);
      ctx.strokeStyle=`rgba(192,96,64,${trailAlpha})`;ctx.lineWidth=1.2;ctx.stroke();
    }
    // Second hand
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(secAngle)*radius*.8,cy+Math.sin(secAngle)*radius*.8);
    ctx.strokeStyle='#c06040';ctx.lineWidth=1.5;ctx.stroke();
    // Subtle gear mechanism visible through glass at center
    ctx.save();ctx.globalAlpha=.08;
    for(let g=0;g<6;g++){
      const ga=time*speed*.5+g*Math.PI/3;
      const gx=cx+Math.cos(ga)*12;const gy=cy+Math.sin(ga)*12;
      ctx.beginPath();ctx.arc(gx,gy,4,0,Math.PI*2);
      ctx.strokeStyle='rgba(180,160,120,.5)';ctx.lineWidth=.8;ctx.stroke();
      // Gear teeth
      for(let t=0;t<6;t++){
        const ta=t*Math.PI/3+time*speed*.3;
        ctx.beginPath();
        ctx.moveTo(gx+Math.cos(ta)*3.5,gy+Math.sin(ta)*3.5);
        ctx.lineTo(gx+Math.cos(ta)*5,gy+Math.sin(ta)*5);
        ctx.stroke();
      }
    }
    ctx.restore();
    // Clock glass reflection (curved highlight sweep)
    ctx.save();ctx.globalAlpha=.06;
    ctx.beginPath();
    ctx.arc(cx,cy,radius-2,-.8,-2.4,true);
    ctx.quadraticCurveTo(cx-radius*.3,cy-radius*.5,cx+radius*.3,cy-radius*.8);
    ctx.strokeStyle='rgba(255,255,255,.8)';ctx.lineWidth=radius*.15;ctx.stroke();
    ctx.restore();
    // Scratches on clock face glass
    ctx.save();ctx.globalAlpha=.04;ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=.4;
    ctx.beginPath();ctx.moveTo(cx-radius*.4,cy-radius*.3);ctx.lineTo(cx+radius*.1,cy+radius*.2);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx+radius*.2,cy-radius*.5);ctx.lineTo(cx+radius*.35,cy-radius*.1);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx-radius*.2,cy+radius*.1);ctx.lineTo(cx+radius*.15,cy+radius*.35);ctx.stroke();
    ctx.restore();
    // Metal patina/oxidation on frame
    ctx.save();ctx.globalAlpha=.05;
    ctx.beginPath();ctx.arc(cx-radius*.7,cy+radius*.6,radius*.15,0,Math.PI*2);
    ctx.fillStyle='rgba(100,140,120,.3)';ctx.fill();
    ctx.beginPath();ctx.arc(cx+radius*.8,cy-radius*.4,radius*.12,0,Math.PI*2);
    ctx.fillStyle='rgba(90,130,110,.25)';ctx.fill();
    ctx.restore();
    // Condensation droplets on glass
    ctx.save();ctx.globalAlpha=.03;
    for(let d=0;d<5;d++){
      const dx=cx+Math.cos(d*1.8+.5)*radius*.6;
      const dy=cy+Math.sin(d*2.3+1)*radius*.5;
      ctx.beginPath();ctx.arc(dx,dy,1+d*.3,0,Math.PI*2);
      ctx.fillStyle='rgba(200,220,255,.4)';ctx.fill();
    }
    ctx.restore();
    // Beveled metal edge (gradient ring around clock)
    ctx.beginPath();ctx.arc(cx,cy,radius+2,0,Math.PI*2);
    const bevelG=ctx.createLinearGradient(cx-radius,cy-radius,cx+radius,cy+radius);
    bevelG.addColorStop(0,'rgba(180,160,120,.3)');bevelG.addColorStop(.25,'rgba(255,240,200,.5)');
    bevelG.addColorStop(.5,'rgba(180,160,120,.3)');bevelG.addColorStop(.75,'rgba(255,240,200,.5)');
    bevelG.addColorStop(1,'rgba(180,160,120,.3)');
    ctx.strokeStyle=bevelG;ctx.lineWidth=2.5;ctx.stroke();
    // Center dot with metallic sheen
    const cdG=ctx.createRadialGradient(cx-1,cy-1,1,cx,cy,5);
    cdG.addColorStop(0,'#fff0c0');cdG.addColorStop(.5,'#e0b050');cdG.addColorStop(1,'#806020');
    ctx.beginPath();ctx.arc(cx,cy,5,0,Math.PI*2);ctx.fillStyle=cdG;ctx.fill();

    // Pendulum below clock
    const pend=isRight?pendulums.right:pendulums.left;
    const pendLen=radius*.6;
    const pendX=cx+Math.sin(pend.angle)*pendLen;
    const pendY=cy+radius+8+Math.cos(pend.angle)*pendLen;
    ctx.beginPath();ctx.moveTo(cx,cy+radius+4);ctx.lineTo(pendX,pendY);
    ctx.strokeStyle='rgba(200,180,140,.4)';ctx.lineWidth=1;ctx.stroke();
    // Pendulum bob
    const pbG=ctx.createRadialGradient(pendX-2,pendY-2,1,pendX,pendY,6);
    pbG.addColorStop(0,'#ffd080');pbG.addColorStop(1,'#a08040');
    ctx.beginPath();ctx.arc(pendX,pendY,6,0,Math.PI*2);ctx.fillStyle=pbG;ctx.fill();

    // Label
    ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='14px Georgia';ctx.textAlign='center';ctx.fillText(label,cx,cy+radius+pendLen+25);
  }
  function animate(){
    time+=.016;ctx.clearRect(0,0,W,H);
    drawStars(ctx,W,H,50,time);drawWarmVignette(ctx,W,H);

    // Update pendulums
    const gravity=9.8;const pLen=60;
    pendulums.left.vel+=(-gravity/pLen)*Math.sin(pendulums.left.angle)*.016;
    pendulums.left.vel*=.999;pendulums.left.angle+=pendulums.left.vel*.016*60;
    if(Math.abs(pendulums.left.angle)<.001&&Math.abs(pendulums.left.vel)<.01)pendulums.left.angle=.3;
    pendulums.right.vel+=(-gravity/pLen)*Math.sin(pendulums.right.angle)*.016*.3;
    pendulums.right.vel*=.999;pendulums.right.angle+=pendulums.right.vel*.016*60;
    if(Math.abs(pendulums.right.angle)<.001&&Math.abs(pendulums.right.vel)<.01)pendulums.right.angle=.3;

    // Divider
    ctx.beginPath();ctx.moveTo(W/2,20);ctx.lineTo(W/2,H-20);ctx.strokeStyle='rgba(240,200,140,.1)';ctx.lineWidth=1;ctx.setLineDash([5,5]);ctx.stroke();ctx.setLineDash([]);
    // Earth side label
    ctx.fillStyle='rgba(220,180,120,.4)';ctx.font='12px Georgia';ctx.textAlign='center';ctx.fillText('🌍 Earth Surface',W*.25,30);
    ctx.fillStyle='rgba(200,160,100,.4)';ctx.fillText('🕳️ Near Black Hole',W*.75,30);

    // Animated distortion rings around right clock
    const r=Math.min(W*.18,H*.35);
    for(let i=0;i<3;i++){
      const ringR=r+15+i*12+5*Math.sin(time*1.5+i);
      ctx.beginPath();ctx.arc(W*.75,H*.48,ringR,0,Math.PI*2);
      ctx.strokeStyle=`rgba(180,120,40,${.06-.015*i})`;ctx.lineWidth=1;ctx.stroke();
    }

    drawClock(W*.25,H*.48,r,1,'Normal Time','#1a1410',false);
    drawClock(W*.75,H*.48,r,.3,'Dilated Time','#1a1210',true);
    // Time particles - fast around left clock, slow around right
    for(let i=0;i<4;i++){
      const a=time*2+i*Math.PI/2;const pr=r+20+8*Math.sin(time*3+i);
      const px=W*.25+Math.cos(a)*pr;const py=H*.48+Math.sin(a)*pr;
      ctx.beginPath();ctx.arc(px,py,2,0,Math.PI*2);ctx.fillStyle='rgba(240,200,120,.4)';ctx.shadowColor='rgba(240,200,120,.4)';ctx.shadowBlur=6;ctx.fill();ctx.shadowBlur=0;
    }
    for(let i=0;i<4;i++){
      const a=time*.6+i*Math.PI/2;const pr2=r+20+8*Math.sin(time+i);
      const px=W*.75+Math.cos(a)*pr2;const py=H*.48+Math.sin(a)*pr2;
      ctx.beginPath();ctx.arc(px,py,2,0,Math.PI*2);ctx.fillStyle='rgba(200,150,80,.3)';ctx.shadowColor='rgba(200,150,80,.3)';ctx.shadowBlur=6;ctx.fill();ctx.shadowBlur=0;
    }
    // Gravity well visual near right clock
    const wellG=ctx.createRadialGradient(W*.75,H*.48,r+5,W*.75,H*.48,r+60);
    wellG.addColorStop(0,'rgba(180,120,40,.08)');wellG.addColorStop(1,'rgba(0,0,0,0)');
    ctx.beginPath();ctx.arc(W*.75,H*.48,r+60,0,Math.PI*2);ctx.fillStyle=wellG;ctx.fill();
    // Dust particles floating in air
    for(let d=0;d<12;d++){
      const dx=(Math.sin(d*73.1+time*.3)*.5+.5)*W;
      const dy=(Math.cos(d*137.3+time*.2)*.5+.5)*H;
      const da=.5+.5*Math.sin(time*.8+d*2.1);
      ctx.beginPath();ctx.arc(dx,dy,.5+d%2*.3,0,Math.PI*2);
      ctx.fillStyle=`rgba(200,180,140,${da*.06})`;ctx.fill();
    }
    // Volumetric atmosphere (subtle warm fog)
    ctx.save();ctx.globalAlpha=.02;
    const fogG=ctx.createLinearGradient(0,H*.7,0,H);
    fogG.addColorStop(0,'rgba(180,140,80,0)');fogG.addColorStop(1,'rgba(180,140,80,.3)');
    ctx.fillStyle=fogG;ctx.fillRect(0,0,W,H);
    ctx.restore();
    requestAnimationFrame(animate);
  }
  animate();
}

/* ============================================================
   CHAPTER 4: LIGHT BENDS — Three.js GPU-accelerated with Bloom
   Vanilla params: GRID=21, GRID_EXTENT=280, depress(), GM=150,
   PHOTON_SPEED=2.5, MINIMALIST (grid + sun + one beam)
   ============================================================ */
function initCanvas4(){
  /* Deferred to module script — see initThreeChapter4() below */
}

/* ============================================================
   CHAPTER 5: BLACK HOLES — Three.js GPU-accelerated with Bloom
   Vanilla params: 14 accretion rings, 50 stars, stretch cap 3,
   warm star colors (240,220,200), gold photon ring (#f0be50),
   softer trail clear (#050210), NO jets
   ============================================================ */
function initCanvas5(){
  /* Deferred to module script — see initThreeChapter5() below */
}

/* ============================================================
   CHAPTER 6: GRAVITATIONAL WAVES — Spiral Merger
   ============================================================ */
function initCanvas6(){
  const canvas=document.getElementById('canvas6');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  let W,H;function resize(){W=canvas.width=canvas.offsetWidth;H=canvas.height=canvas.offsetHeight}
  resize();window.addEventListener('resize',resize);
  let time=0;let mergePhase=0;
  let spiralDist=120,flashAlpha=0;
  let shakeX=0,shakeY=0;
  const trails1=[],trails2=[];
  const ripples=[];
  const afterglowParticles=[];
  function animate(){
    time+=.016;ctx.clearRect(0,0,W,H);
    // Screen shake decay
    shakeX*=.9;shakeY*=.9;
    ctx.save();
    ctx.translate(shakeX,shakeY);
    drawStars(ctx,W,H,70,time);drawWarmVignette(ctx,W,H);
    const cx=W/2,cy=H/2;
    // Spacetime grid with interference
    const spacing=40;
    for(let r=0;r<H/spacing;r++){
      ctx.beginPath();
      for(let c=0;c<=W/spacing;c++){
        let gx=c*spacing,gy=r*spacing;
        let totalDisp=0;
        ripples.forEach(rp=>{
          const d=dist(gx,gy,cx,cy);
          const wave=Math.sin((d-rp.r)*.05)*rp.amp*Math.exp(-.001*(d-rp.r)*(d-rp.r));
          totalDisp+=wave;
          // Interference: second wave offset
          const wave2=Math.sin((d-rp.r)*.08+1)*rp.amp*.5*Math.exp(-.0015*(d-rp.r)*(d-rp.r));
          totalDisp+=wave2;
        });
        gy+=totalDisp;
        // Color shifting based on displacement
        if(c===0)ctx.moveTo(gx,gy);else ctx.lineTo(gx,gy);
      }
      const intensity=Math.abs(Math.sin(time+r*.3))*.15;
      const rVal=Math.floor(100+140*intensity);
      const gVal=Math.floor(160-60*intensity);
      const bVal=Math.floor(200-100*intensity);
      ctx.strokeStyle=`rgba(${rVal},${gVal},${bVal},.15)`;ctx.lineWidth=.5;ctx.stroke();
    }
    if(mergePhase===0){
      spiralDist=Math.max(5,spiralDist-.15);
      const speed=3+100/(spiralDist+10);
      const a1=time*speed;const a2=a1+Math.PI;
      const x1=cx+Math.cos(a1)*spiralDist;const y1=cy+Math.sin(a1)*spiralDist;
      const x2=cx+Math.cos(a2)*spiralDist;const y2=cy+Math.sin(a2)*spiralDist;
      trails1.push({x:x1,y:y1,a:1});trails2.push({x:x2,y:y2,a:1});
      if(trails1.length>80)trails1.shift();if(trails2.length>80)trails2.shift();
      [trails1,trails2].forEach((trail,idx)=>{
        ctx.beginPath();trail.forEach((p,i)=>{p.a*=.97;i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y)});
        ctx.strokeStyle=idx===0?'rgba(240,180,80,.35)':'rgba(210,130,60,.35)';ctx.lineWidth=2;ctx.stroke();
      });
      // Draw objects with gravity wells
      [[x1,y1,'#e8a040'],[x2,y2,'#d07030']].forEach(([ox,oy,col])=>{
        // Gravity well
        const gwG=ctx.createRadialGradient(ox,oy,6,ox,oy,30);
        gwG.addColorStop(0,`rgba(240,180,80,.15)`);gwG.addColorStop(1,'rgba(0,0,0,0)');
        ctx.beginPath();ctx.arc(ox,oy,30,0,Math.PI*2);ctx.fillStyle=gwG;ctx.fill();
        // Mass
        ctx.beginPath();ctx.arc(ox,oy,8+2*Math.sin(time*5),0,Math.PI*2);
        ctx.fillStyle=col;ctx.shadowColor=col;ctx.shadowBlur=20;ctx.fill();ctx.shadowBlur=0;
      });
      if(spiralDist<=5){mergePhase=1;flashAlpha=1;ripples.push({r:0,amp:20});
        shakeX=(Math.random()-.5)*12;shakeY=(Math.random()-.5)*12;
        for(let i=0;i<20;i++)afterglowParticles.push({x:cx,y:cy,vx:(Math.random()-.5)*3,vy:(Math.random()-.5)*3,life:1,r:1+Math.random()*2});
      }
    }else if(mergePhase===1){
      flashAlpha*=.92;
      shakeX+=(Math.random()-.5)*flashAlpha*8;shakeY+=(Math.random()-.5)*flashAlpha*8;
      ctx.fillStyle=`rgba(255,255,220,${flashAlpha})`;ctx.fillRect(0,0,W,H);
      if(flashAlpha<.01){mergePhase=2}
    }else{
      ripples.forEach(rp=>{rp.r+=2;rp.amp*=.995});
      ripples.forEach(rp=>{
        for(let i=0;i<3;i++){
          const ringR=rp.r+i*15;
          const t=ringR/(Math.max(W,H));
          const r2=Math.floor(100+140*t);const g2=Math.floor(180-80*t);const b2=Math.floor(240-180*t);
          ctx.beginPath();ctx.arc(cx,cy,ringR,0,Math.PI*2);
          ctx.strokeStyle=`rgba(${r2},${g2},${b2},${rp.amp*.035})`;ctx.lineWidth=2;ctx.stroke();
        }
      });
      // Afterglow particles following wave fronts
      afterglowParticles.forEach(p=>{
        p.x+=p.vx;p.y+=p.vy;p.life*=.99;p.vx*=.99;p.vy*=.99;
        if(p.life>.01){
          ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);
          ctx.fillStyle=`rgba(240,200,100,${p.life*.5})`;ctx.shadowColor='rgba(240,200,100,.3)';ctx.shadowBlur=6;ctx.fill();ctx.shadowBlur=0;
        }
      });
      // Merged object
      ctx.beginPath();ctx.arc(cx,cy,12+2*Math.sin(time*3),0,Math.PI*2);
      const mg=ctx.createRadialGradient(cx,cy,2,cx,cy,14);mg.addColorStop(0,'#ffffff');mg.addColorStop(.5,'#ffd090');mg.addColorStop(1,'rgba(240,180,80,0)');
      ctx.fillStyle=mg;ctx.shadowColor='#ffd090';ctx.shadowBlur=25;ctx.fill();ctx.shadowBlur=0;
      if(ripples.length&&ripples[0].r>Math.max(W,H)){
        mergePhase=0;spiralDist=120;trails1.length=0;trails2.length=0;ripples.length=0;afterglowParticles.length=0;
      }
    }
    ctx.restore();
    requestAnimationFrame(animate);
  }
  animate();
}

/* ============================================================
   CHAPTER 7: SPEED OF LIGHT — Rocketship
   ============================================================ */
function initCanvas7(){
  const canvas=document.getElementById('canvas7');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  let W,H;function resize(){W=canvas.width=canvas.offsetWidth;H=canvas.height=canvas.offsetHeight}
  resize();window.addEventListener('resize',resize);
  let time=0;let speed=0;
  const bgStars=Array.from({length:80},()=>({x:rand(0,1),y:rand(0,1),z:rand(.5,2)}));
  function drawRocket(x,y,s){
    ctx.save();ctx.translate(x,y);
    // Motion blur at high speeds
    if(s>.5){
      ctx.globalAlpha=.15;
      for(let b=1;b<=3;b++){
        ctx.save();ctx.translate(-b*s*8,0);
        ctx.beginPath();ctx.moveTo(40,0);ctx.quadraticCurveTo(45,-12,20,-12);ctx.lineTo(-25,-10);ctx.lineTo(-25,10);ctx.lineTo(20,12);ctx.quadraticCurveTo(45,12,40,0);ctx.closePath();
        ctx.fillStyle='rgba(200,200,220,.3)';ctx.fill();
        ctx.restore();
      }
      ctx.globalAlpha=1;
    }
    // Main body
    ctx.beginPath();ctx.moveTo(40,0);ctx.quadraticCurveTo(45,-12,20,-12);ctx.lineTo(-25,-10);ctx.lineTo(-25,10);ctx.lineTo(20,12);ctx.quadraticCurveTo(45,12,40,0);ctx.closePath();
    const rg=ctx.createLinearGradient(-25,-12,40,12);rg.addColorStop(0,'#bbbbbb');rg.addColorStop(.3,'#e8e8e8');rg.addColorStop(.5,'#ffffff');rg.addColorStop(.7,'#dddddd');rg.addColorStop(1,'#999999');
    ctx.fillStyle=rg;ctx.fill();ctx.strokeStyle='#888';ctx.lineWidth=.5;ctx.stroke();
    // Hull specular highlight
    ctx.beginPath();ctx.moveTo(35,-3);ctx.quadraticCurveTo(25,-10,5,-10);
    ctx.strokeStyle='rgba(255,255,255,.25)';ctx.lineWidth=1.5;ctx.stroke();
    // Heat shield glow at nose (when speed > 0.5)
    if(s>.5){
      const heatAlpha=(s-.5)*1.5;
      const hsg=ctx.createRadialGradient(42,0,0,42,0,8);
      hsg.addColorStop(0,`rgba(255,200,100,${heatAlpha*.6})`);
      hsg.addColorStop(.5,`rgba(255,120,40,${heatAlpha*.3})`);
      hsg.addColorStop(1,'rgba(255,80,20,0)');
      ctx.beginPath();ctx.arc(42,0,8,0,Math.PI*2);ctx.fillStyle=hsg;ctx.fill();
    }
    // Panel lines
    ctx.strokeStyle='rgba(100,100,100,.2)';ctx.lineWidth=.4;
    ctx.beginPath();ctx.moveTo(0,-12);ctx.lineTo(0,12);ctx.stroke();
    ctx.beginPath();ctx.moveTo(-12,-11);ctx.lineTo(-12,11);ctx.stroke();
    // Panel seam rivets (small circles with highlights)
    for(let i=0;i<6;i++){
      const ry=-10+i*4;
      ctx.beginPath();ctx.arc(5,ry,0.9,0,Math.PI*2);ctx.fillStyle='rgba(120,120,120,.3)';ctx.fill();
      ctx.beginPath();ctx.arc(5-.3,ry-.3,0.3,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.2)';ctx.fill();
    }
    for(let i=0;i<5;i++){
      const ry=-8+i*4;
      ctx.beginPath();ctx.arc(-8,ry,0.8,0,Math.PI*2);ctx.fillStyle='rgba(120,120,120,.25)';ctx.fill();
      ctx.beginPath();ctx.arc(-8-.3,ry-.3,0.25,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.15)';ctx.fill();
    }
    // Heat discoloration on hull near exhaust
    ctx.save();ctx.globalAlpha=.08;
    const hdG=ctx.createLinearGradient(-25,0,-10,0);
    hdG.addColorStop(0,'rgba(180,140,60,1)');hdG.addColorStop(.5,'rgba(160,120,80,.5)');hdG.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=hdG;ctx.fillRect(-25,-10,20,20);ctx.restore();
    // Control surface flaps
    ctx.fillStyle='rgba(160,160,170,.4)';
    ctx.beginPath();ctx.moveTo(-22,-10);ctx.lineTo(-18,-10);ctx.lineTo(-18,-12);ctx.lineTo(-22,-11);ctx.fill();
    ctx.beginPath();ctx.moveTo(-22,10);ctx.lineTo(-18,10);ctx.lineTo(-18,12);ctx.lineTo(-22,11);ctx.fill();
    // Vents on hull
    ctx.strokeStyle='rgba(80,80,80,.15)';ctx.lineWidth=.3;
    for(let v=0;v<3;v++){ctx.beginPath();ctx.moveTo(-15+v*4,-8);ctx.lineTo(-15+v*4,-6);ctx.stroke();}
    // Antenna with guy-wires
    ctx.beginPath();ctx.moveTo(35,-12);ctx.lineTo(38,-18);ctx.strokeStyle='rgba(180,180,180,.6)';ctx.lineWidth=1;ctx.stroke();
    ctx.beginPath();ctx.arc(38,-18,1.5,0,Math.PI*2);ctx.fillStyle='#ff4444';ctx.fill();
    // Guy-wires from antenna tip
    ctx.strokeStyle='rgba(160,160,160,.15)';ctx.lineWidth=.3;
    ctx.beginPath();ctx.moveTo(38,-18);ctx.lineTo(30,-10);ctx.stroke();
    ctx.beginPath();ctx.moveTo(38,-18);ctx.lineTo(25,-11);ctx.stroke();
    // Thruster bell interior detail
    ctx.save();ctx.globalAlpha=.3;
    ctx.beginPath();ctx.ellipse(-25,0,3,7,0,0,Math.PI*2);
    ctx.fillStyle='rgba(60,40,30,.5)';ctx.fill();
    ctx.beginPath();ctx.ellipse(-25,0,2,5,0,0,Math.PI*2);
    ctx.fillStyle='rgba(40,25,15,.4)';ctx.fill();
    ctx.restore();
    // Window with pilot silhouette
    ctx.beginPath();ctx.arc(15,0,5,0,Math.PI*2);
    const wg=ctx.createRadialGradient(14,-1,1,15,0,5);wg.addColorStop(0,'#aaddff');wg.addColorStop(1,'#4488cc');
    ctx.fillStyle=wg;ctx.fill();ctx.strokeStyle='rgba(100,100,100,.3)';ctx.lineWidth=.5;ctx.stroke();
    // Tiny pilot silhouette
    ctx.save();ctx.beginPath();ctx.arc(15,0,4.5,0,Math.PI*2);ctx.clip();
    ctx.fillStyle='rgba(30,30,50,.3)';
    // Head
    ctx.beginPath();ctx.arc(15,-1,1.8,0,Math.PI*2);ctx.fill();
    // Shoulders
    ctx.beginPath();ctx.moveTo(12.5,1);ctx.quadraticCurveTo(15,0,17.5,1);ctx.lineTo(17.5,4);ctx.lineTo(12.5,4);ctx.closePath();ctx.fill();
    ctx.restore();
    // Fins with gradient
    const finG=ctx.createLinearGradient(-35,-22,-20,-10);finG.addColorStop(0,'#dd4444');finG.addColorStop(1,'#992222');
    ctx.beginPath();ctx.moveTo(-25,-10);ctx.lineTo(-35,-22);ctx.lineTo(-20,-10);ctx.fillStyle=finG;ctx.fill();
    ctx.beginPath();ctx.moveTo(-25,10);ctx.lineTo(-35,22);ctx.lineTo(-20,10);ctx.fillStyle=finG;ctx.fill();
    // Turbulent exhaust with inner/outer cone
    const flameLen=20+s*60+10*Math.sin(time*20);
    // Outer cone (redder)
    const fg2=ctx.createLinearGradient(-25,0,-25-flameLen*1.1,0);
    fg2.addColorStop(0,'rgba(255,100,30,.5)');fg2.addColorStop(.5,'rgba(255,30,0,.2)');fg2.addColorStop(1,'rgba(200,0,0,0)');
    ctx.beginPath();ctx.moveTo(-25,-8);
    ctx.quadraticCurveTo(-25-flameLen*.6,-5+6*Math.sin(time*12),-25-flameLen*1.1,0);
    ctx.quadraticCurveTo(-25-flameLen*.6,5+6*Math.sin(time*12+2),-25,8);ctx.fillStyle=fg2;ctx.fill();
    // Inner cone (white-hot)
    const fg=ctx.createLinearGradient(-25,0,-25-flameLen*.7,0);fg.addColorStop(0,'rgba(255,255,230,.95)');fg.addColorStop(.3,'rgba(255,200,80,.7)');fg.addColorStop(.7,'rgba(255,100,20,.3)');fg.addColorStop(1,'rgba(255,50,0,0)');
    ctx.beginPath();ctx.moveTo(-25,-4);
    ctx.quadraticCurveTo(-25-flameLen*.5,-2+3*Math.sin(time*18),-25-flameLen*.7,0);
    ctx.quadraticCurveTo(-25-flameLen*.5,2+3*Math.sin(time*18+1),-25,4);ctx.fillStyle=fg;ctx.fill();
    // Cherenkov radiation ring when approaching c
    if(s>.85){
      const cherenkovAlpha=(s-.85)*6;
      ctx.beginPath();ctx.ellipse(30,0,8+s*5,20+s*10,0,0,Math.PI*2);
      ctx.strokeStyle=`rgba(100,180,255,${cherenkovAlpha*.3})`;ctx.lineWidth=2;
      ctx.shadowColor=`rgba(100,180,255,${cherenkovAlpha*.4})`;ctx.shadowBlur=10;ctx.stroke();ctx.shadowBlur=0;
    }
    ctx.restore();
  }
  function animate(){
    time+=.016;
    speed=(.5+.5*Math.sin(time*.4))*.95;// oscillate speed
    ctx.fillStyle='rgba(18,5,31,.3)';ctx.fillRect(0,0,W,H);
    // Star streaks with red/blueshift
    bgStars.forEach(s=>{
      const streak=1+speed*50*s.z;
      const sx=s.x*W;const sy=s.y*H;
      s.x-=(.001+speed*.02)*s.z;
      if(s.x<0)s.x=1;
      ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx+streak,sy);
      // Blueshift ahead (right), redshift behind (left)
      const rocketX=W*.35;
      if(speed>.3){
        const shift=(sx>rocketX)?1:-1;
        const shiftAmt=speed*.7;
        if(shift>0){
          ctx.strokeStyle=`rgba(${Math.floor(180-80*shiftAmt)},${Math.floor(200-40*shiftAmt)},255,${.25+speed*.45})`;
        }else{
          ctx.strokeStyle=`rgba(255,${Math.floor(200-80*shiftAmt)},${Math.floor(160-100*shiftAmt)},${.25+speed*.45})`;
        }
      }else{
        ctx.strokeStyle=`rgba(255,230,180,${.25+speed*.45})`;
      }
      ctx.lineWidth=s.z;ctx.stroke();
    });
    // Speed gauge with illuminated tick marks
    const gaugeX=W-80,gaugeY=40,gaugeH=H-80;
    ctx.fillStyle='rgba(255,255,255,.07)';ctx.fillRect(gaugeX,gaugeY,20,gaugeH);
    const fillH=speed*gaugeH;
    const gg=ctx.createLinearGradient(gaugeX,gaugeY+gaugeH-fillH,gaugeX,gaugeY+gaugeH);
    gg.addColorStop(0,'#c84030');gg.addColorStop(.5,'#e0a040');gg.addColorStop(1,'#a0c060');
    ctx.fillStyle=gg;ctx.fillRect(gaugeX,gaugeY+gaugeH-fillH,20,fillH);
    // Illuminated tick marks
    for(let t=0;t<=10;t++){
      const ty=gaugeY+gaugeH-t/10*gaugeH;
      const lit=speed>=t/10;
      ctx.beginPath();ctx.moveTo(gaugeX-3,ty);ctx.lineTo(gaugeX+23,ty);
      ctx.strokeStyle=lit?`rgba(255,220,120,.6)`:'rgba(255,255,255,.15)';ctx.lineWidth=1;ctx.stroke();
      if(lit&&t>0){ctx.shadowColor='rgba(255,220,120,.5)';ctx.shadowBlur=4;
        ctx.beginPath();ctx.moveTo(gaugeX-3,ty);ctx.lineTo(gaugeX+23,ty);ctx.stroke();ctx.shadowBlur=0;}
    }
    ctx.strokeStyle='rgba(255,255,255,.3)';ctx.strokeRect(gaugeX,gaugeY,20,gaugeH);
    ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='11px Georgia';ctx.textAlign='center';
    ctx.fillText(`${(speed*100).toFixed(0)}% c`,gaugeX+10,gaugeY+gaugeH+18);
    // Light barrier visual
    if(speed>.8){
      const barrier=ctx.createRadialGradient(W*.35,H/2,10,W*.35,H/2,100+speed*50);
      barrier.addColorStop(0,`rgba(255,220,140,${(speed-.8)*1.5})`);barrier.addColorStop(1,'rgba(255,200,100,0)');
      ctx.fillStyle=barrier;ctx.fillRect(0,0,W,H);
      // Doppler shift: blue ahead, red behind
      const shiftA=(speed-.8)*3;
      const blueG=ctx.createLinearGradient(W*.35+50,0,W,0);blueG.addColorStop(0,`rgba(200,220,255,${shiftA*.1})`);blueG.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=blueG;ctx.fillRect(W*.35,0,W*.65,H);
      const redG=ctx.createLinearGradient(W*.35-50,0,0,0);redG.addColorStop(0,`rgba(200,80,40,${shiftA*.08})`);redG.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=redG;ctx.fillRect(0,0,W*.35,H);
    }
    // Exhaust particles — subtle
    if(speed>.2){for(let i=0;i<Math.ceil(speed*2);i++){
      const px=W*.35-30-rand(10,50)*speed;const py=H/2+rand(-6,6);
      const pr=rand(1,2.5)*speed;
      ctx.beginPath();ctx.arc(px,py,pr,0,Math.PI*2);
      ctx.fillStyle=`rgba(240,${rand(150,200)},${rand(80,140)},${rand(.15,.35)})`;ctx.fill();
    }}
    drawRocket(W*.35,H/2,speed);
    requestAnimationFrame(animate);
  }
  ctx.fillStyle='#12051f';ctx.fillRect(0,0,W,H);
  animate();
}

/* ============================================================
   CHAPTER 8: E=mc² — Dramatic Explosion
   ============================================================ */
function initCanvas8(){
  const canvas=document.getElementById('canvas8');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  let W,H;function resize(){W=canvas.width=canvas.offsetWidth;H=canvas.height=canvas.offsetHeight}
  resize();window.addEventListener('resize',resize);
  let time=0;let phase=0;// 0=equation, 1=converge, 2=explode
  let phaseTime=0;
  let screenFlash=0;
  const particles=[];
  const shockwaves=[];
  // Orbiting electrons
  const electrons=[
    {angle:0,speed:3,radius:35,size:3},
    {angle:Math.PI*.67,speed:4.2,radius:28,size:2.5},
    {angle:Math.PI*1.33,speed:2.5,radius:42,size:2.8}
  ];
  function animate(){
    time+=.016;phaseTime+=.016;
    ctx.fillStyle='rgba(15,5,5,.12)';ctx.fillRect(0,0,W,H);
    drawStars(ctx,W,H,40,time);drawWarmVignette(ctx,W,H);
    const cx=W/2,cy=H/2;
    if(phase===0){
      // Equation appearing with glow
      const letters=['E',' ','=',' ','m','c','²'];
      const progress=clamp(phaseTime/3,0,1);
      const shown=Math.floor(progress*letters.length);
      ctx.font='bold 60px Georgia';ctx.textAlign='center';ctx.textBaseline='middle';
      let xOff=-90;
      for(let i=0;i<=shown&&i<letters.length;i++){
        const charAlpha=i===shown?clamp((progress*letters.length-shown),0,1):1;
        ctx.fillStyle=`rgba(240,190,80,${charAlpha})`;
        ctx.shadowColor='rgba(240,180,80,.5)';ctx.shadowBlur=20;
        ctx.fillText(letters[i],cx+xOff,cy);
        ctx.shadowBlur=0;
        xOff+=i===6?20:30;
      }
      if(phaseTime>4){phase=1;phaseTime=0}
    }else if(phase===1){
      // Mass particle converging with orbiting electrons
      const shrink=clamp(1-phaseTime/2,0,1);
      const r=30*shrink+3;
      // Orbiting electrons with trails
      electrons.forEach(e=>{
        e.angle+=e.speed*.016;
        const eR=r+e.radius*shrink;
        const ex=cx+Math.cos(e.angle)*eR;
        const ey=cy+Math.sin(e.angle)*eR*.6;
        // Phosphor-trail afterglow
        for(let t=12;t>=0;t--){
          const ta=e.angle-t*.1;
          const tx=cx+Math.cos(ta)*eR;
          const ty=cy+Math.sin(ta)*eR*.6;
          ctx.beginPath();ctx.arc(tx,ty,e.size*(1-t*.06),0,Math.PI*2);
          ctx.fillStyle=`rgba(100,180,255,${.04*(12-t)})`;ctx.fill();
          // Phosphor glow
          if(t<6){
            ctx.beginPath();ctx.arc(tx,ty,e.size*2*(1-t*.1),0,Math.PI*2);
            ctx.fillStyle=`rgba(80,150,255,${.01*(6-t)})`;ctx.fill();
          }
        }
        ctx.beginPath();ctx.arc(ex,ey,e.size,0,Math.PI*2);
        ctx.fillStyle='rgba(120,200,255,.8)';ctx.shadowColor='rgba(100,180,255,.6)';ctx.shadowBlur=8;ctx.fill();ctx.shadowBlur=0;
      });
      // Nucleus with protons/neutrons (small spheres)
      ctx.save();
      // Draw individual nucleons
      const nucleonCount=Math.max(3,Math.floor(r/3));
      for(let n=0;n<nucleonCount;n++){
        const na=n*Math.PI*2/nucleonCount+time*2;
        const nr2=r*.4;
        const nnx=cx+Math.cos(na)*nr2*(1+.2*Math.sin(time*5+n));
        const nny=cy+Math.sin(na)*nr2*(1+.2*Math.cos(time*5+n));
        const nR=r*.25;
        const isProton=n%2===0;
        const ncG=ctx.createRadialGradient(nnx-nR*.2,nny-nR*.2,nR*.1,nnx,nny,nR);
        if(isProton){ncG.addColorStop(0,'#ff8888');ncG.addColorStop(1,'#cc3333')}
        else{ncG.addColorStop(0,'#8888ff');ncG.addColorStop(1,'#3333cc')}
        ctx.beginPath();ctx.arc(nnx,nny,nR,0,Math.PI*2);ctx.fillStyle=ncG;ctx.fill();
        // Nucleon highlight
        ctx.beginPath();ctx.arc(nnx-nR*.2,nny-nR*.3,nR*.35,0,Math.PI*2);
        ctx.fillStyle='rgba(255,255,255,.3)';ctx.fill();
      }
      ctx.restore();
      // Overall nucleus glow
      ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);
      const g=ctx.createRadialGradient(cx,cy,1,cx,cy,r);g.addColorStop(0,'rgba(255,255,255,.6)');g.addColorStop(.5,'rgba(255,220,100,.3)');g.addColorStop(1,'rgba(255,100,0,.1)');
      ctx.fillStyle=g;ctx.shadowColor='#ffdd66';ctx.shadowBlur=30;ctx.fill();ctx.shadowBlur=0;
      // Glow intensifies
      ctx.font='bold 60px Georgia';ctx.textAlign='center';ctx.fillStyle=`rgba(240,190,80,${.3+.7*Math.sin(time*10)})`;
      ctx.shadowColor='rgba(240,180,80,.6)';ctx.shadowBlur=30;ctx.fillText('E = mc²',cx,cy-80);ctx.shadowBlur=0;
      if(phaseTime>2){
        phase=2;phaseTime=0;screenFlash=1;
        for(let i=0;i<120;i++){const a=rand(0,Math.PI*2);const sp=rand(1,8);particles.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,hue:rand(20,60),r:rand(1,4),glow:rand(.3,1)})}
        shockwaves.push({r:0,a:1});shockwaves.push({r:0,a:.7});
      }
    }else{
      // Screen flash on detonation
      if(screenFlash>.01){
        ctx.fillStyle=`rgba(255,255,255,${screenFlash})`;ctx.fillRect(0,0,W,H);
        screenFlash*=.9;
      }
      // Explosion particles with varying glow
      particles.forEach(p=>{
        p.x+=p.vx;p.y+=p.vy;p.vx*=.98;p.vy*=.98;p.life*=.985;
        if(p.life>.01){
          const glowI=p.glow||.5;
          ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);
          ctx.fillStyle=`hsla(${p.hue},90%,${40+glowI*30}%,${p.life*glowI})`;
          ctx.shadowColor=`hsla(${p.hue},90%,60%,${glowI*.5})`;ctx.shadowBlur=6+glowI*6;ctx.fill();ctx.shadowBlur=0;
        }
      });
      // Multiple shockwave rings
      shockwaves.forEach((sw,idx)=>{
        sw.r+=4-idx*1;sw.a*=.98;
        ctx.beginPath();ctx.arc(cx,cy,sw.r,0,Math.PI*2);
        ctx.strokeStyle=`rgba(255,${200-idx*40},${100-idx*30},${sw.a})`;ctx.lineWidth=3-idx;
        ctx.shadowColor=`rgba(255,200,100,${sw.a*.4})`;ctx.shadowBlur=10;ctx.stroke();ctx.shadowBlur=0;
      });
      // Mushroom cloud silhouette forming
      const cloudProgress=clamp(phaseTime/3,0,1);
      if(cloudProgress>.1){
        const ca=cloudProgress*.4;
        // Stem
        ctx.beginPath();ctx.moveTo(cx-8,cy);ctx.lineTo(cx-12,cy-40*cloudProgress);
        ctx.lineTo(cx+12,cy-40*cloudProgress);ctx.lineTo(cx+8,cy);ctx.closePath();
        ctx.fillStyle=`rgba(80,40,20,${ca})`;ctx.fill();
        // Cap
        ctx.beginPath();ctx.ellipse(cx,cy-45*cloudProgress,30*cloudProgress,18*cloudProgress,0,0,Math.PI*2);
        ctx.fillStyle=`rgba(100,50,20,${ca*.8})`;ctx.fill();
        ctx.beginPath();ctx.ellipse(cx,cy-50*cloudProgress,22*cloudProgress,12*cloudProgress,0,0,Math.PI*2);
        ctx.fillStyle=`rgba(140,70,30,${ca*.6})`;ctx.fill();
      }
      // Volumetric god rays radiating from center
      const godRayAlpha=clamp(1-phaseTime/4,0,1);
      if(godRayAlpha>.01){
        ctx.save();ctx.globalCompositeOperation='screen';
        for(let ray=0;ray<12;ray++){
          const ra=ray*Math.PI/6+time*.1;
          const rayLen=80+phaseTime*40;
          const rw=3+phaseTime*2;
          ctx.beginPath();
          ctx.moveTo(cx+Math.cos(ra-rw*.01)*5,cy+Math.sin(ra-rw*.01)*5);
          ctx.lineTo(cx+Math.cos(ra-rw*.005)*rayLen,cy+Math.sin(ra-rw*.005)*rayLen);
          ctx.lineTo(cx+Math.cos(ra+rw*.005)*rayLen,cy+Math.sin(ra+rw*.005)*rayLen);
          ctx.closePath();
          const rg2=ctx.createLinearGradient(cx,cy,cx+Math.cos(ra)*rayLen,cy+Math.sin(ra)*rayLen);
          rg2.addColorStop(0,`rgba(255,240,180,${godRayAlpha*.15})`);
          rg2.addColorStop(.5,`rgba(255,200,100,${godRayAlpha*.06})`);
          rg2.addColorStop(1,'rgba(255,150,50,0)');
          ctx.fillStyle=rg2;ctx.fill();
        }
        ctx.globalCompositeOperation='source-over';ctx.restore();
      }
      // Debris fragments with individual shapes
      const debrisCount=Math.min(15,Math.floor(phaseTime*5));
      for(let d=0;d<debrisCount;d++){
        const da=d*Math.PI*2/debrisCount+time*.2;
        const dd=20+phaseTime*30+d*8;
        const dx=cx+Math.cos(da)*dd;
        const dy=cy+Math.sin(da)*dd-phaseTime*d*.5;
        const ds=2+d%3;
        ctx.save();ctx.translate(dx,dy);ctx.rotate(time*3+d);
        ctx.fillStyle=`rgba(${80+d*10},${40+d*5},${20+d*3},${clamp(.6-phaseTime*.1,0,.6)})`;
        // Random polygon shapes for debris
        ctx.beginPath();
        const sides=3+d%3;
        for(let s=0;s<=sides;s++){
          const sa=s*Math.PI*2/sides;
          const sr=ds*(0.7+((s*d*17)%10)/10*0.6);
          s===0?ctx.moveTo(Math.cos(sa)*sr,Math.sin(sa)*sr):ctx.lineTo(Math.cos(sa)*sr,Math.sin(sa)*sr);
        }
        ctx.fill();ctx.restore();
      }
      // Heat distortion effect (wavy lines near center)
      if(phaseTime<3){
        ctx.save();ctx.globalAlpha=.04;ctx.strokeStyle='rgba(255,200,100,.3)';ctx.lineWidth=1;
        for(let h=0;h<5;h++){
          ctx.beginPath();
          for(let hx=-40;hx<=40;hx+=2){
            const hy=cy-20-h*12+Math.sin(hx*.2+time*8+h)*3*(1-phaseTime/3);
            hx===-40?ctx.moveTo(cx+hx,hy):ctx.lineTo(cx+hx,hy);
          }
          ctx.stroke();
        }
        ctx.restore();
      }
      // Smoke tendrils with turbulence
      if(phaseTime>.5){
        ctx.save();ctx.globalAlpha=clamp(.15-phaseTime*.02,0,.15);
        for(let s=0;s<4;s++){
          const sa=s*Math.PI/2+Math.sin(time+s)*0.3;
          const sd=30+phaseTime*20;
          ctx.beginPath();
          ctx.moveTo(cx,cy);
          for(let st=0;st<10;st++){
            const sx=cx+Math.cos(sa+Math.sin(st*.5+time*2)*0.4)*sd*st/10;
            const sy=cy+Math.sin(sa+Math.cos(st*.3+time*1.5)*0.3)*sd*st/10-st*3;
            ctx.lineTo(sx,sy);
          }
          ctx.strokeStyle='rgba(100,80,60,.5)';ctx.lineWidth=3+s;ctx.lineCap='round';ctx.stroke();
        }
        ctx.restore();
      }
      // Ground scorch patterns (bottom of canvas)
      if(phaseTime>.3){
        const scorchAlpha=clamp(phaseTime*.1,.01,.3);
        const scorchG=ctx.createRadialGradient(cx,H,10,cx,H,80+phaseTime*20);
        scorchG.addColorStop(0,`rgba(40,20,0,${scorchAlpha})`);
        scorchG.addColorStop(.5,`rgba(60,30,5,${scorchAlpha*.5})`);
        scorchG.addColorStop(1,'rgba(0,0,0,0)');
        ctx.fillStyle=scorchG;ctx.fillRect(cx-120,H-30,240,30);
      }
      // Center glow fading
      const glow=clamp(1-phaseTime/3,0,1);
      if(glow>.01){
        const eg=ctx.createRadialGradient(cx,cy,5,cx,cy,80*glow);eg.addColorStop(0,`rgba(255,255,200,${glow})`);eg.addColorStop(1,'rgba(255,100,0,0)');
        ctx.beginPath();ctx.arc(cx,cy,80*glow,0,Math.PI*2);ctx.fillStyle=eg;ctx.fill();
      }
      if(phaseTime>5){phase=0;phaseTime=0;particles.length=0;shockwaves.length=0;screenFlash=0;ctx.clearRect(0,0,W,H)}
    }
    requestAnimationFrame(animate);
  }
  animate();
}

/* ============================================================
   CHAPTER 9: LENGTH CONTRACTION — Side by Side Ships
   ============================================================ */
function initCanvas9(){
  const canvas=document.getElementById('canvas9');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  let W,H;function resize(){W=canvas.width=canvas.offsetWidth;H=canvas.height=canvas.offsetHeight}
  resize();window.addEventListener('resize',resize);
  let time=0;
  function drawShip(x,y,scaleX,scaleY,color,moving){
    ctx.save();ctx.translate(x,y);ctx.scale(scaleX,scaleY);
    // Hull glow
    ctx.shadowColor=color;ctx.shadowBlur=15;
    // Body with gradient
    ctx.beginPath();ctx.moveTo(50,0);ctx.quadraticCurveTo(55,-15,25,-15);ctx.lineTo(-30,-12);ctx.lineTo(-30,12);ctx.lineTo(25,15);ctx.quadraticCurveTo(55,15,50,0);
    const sg=ctx.createLinearGradient(-30,-15,50,15);sg.addColorStop(0,color);sg.addColorStop(.5,'#668899');sg.addColorStop(1,'#334455');
    ctx.fillStyle=sg;ctx.fill();ctx.shadowBlur=0;
    ctx.strokeStyle='rgba(200,220,255,.4)';ctx.lineWidth=1;ctx.stroke();
    // Panel lines
    ctx.strokeStyle='rgba(255,255,255,.1)';ctx.lineWidth=.5;
    ctx.beginPath();ctx.moveTo(0,-14);ctx.lineTo(0,14);ctx.stroke();
    ctx.beginPath();ctx.moveTo(-15,-13);ctx.lineTo(-15,13);ctx.stroke();
    // Windows with glow
    for(let i=0;i<3;i++){
      ctx.beginPath();ctx.arc(10-i*15,0,4.5,0,Math.PI*2);
      const wg=ctx.createRadialGradient(10-i*15,-1,1,10-i*15,0,4.5);
      wg.addColorStop(0,'#fff8e0');wg.addColorStop(1,'#c89848');
      ctx.fillStyle=wg;ctx.shadowColor='rgba(240,200,120,.5)';ctx.shadowBlur=8;ctx.fill();ctx.shadowBlur=0;
    }
    // Fins with gradient
    ctx.beginPath();ctx.moveTo(-30,-12);ctx.lineTo(-42,-25);ctx.lineTo(-22,-12);
    const fg1=ctx.createLinearGradient(-42,-25,-22,-12);fg1.addColorStop(0,'#ff4444');fg1.addColorStop(1,'#aa2222');
    ctx.fillStyle=fg1;ctx.fill();
    ctx.beginPath();ctx.moveTo(-30,12);ctx.lineTo(-42,25);ctx.lineTo(-22,12);ctx.fillStyle=fg1;ctx.fill();
    // Nose cone highlight
    ctx.beginPath();ctx.moveTo(50,0);ctx.quadraticCurveTo(48,-8,35,-10);ctx.quadraticCurveTo(42,-4,50,0);
    ctx.fillStyle='rgba(255,255,255,.15)';ctx.fill();
    // Engine exhaust if moving
    if(moving){
      const flameLen=15+8*Math.sin(time*18);
      const efg=ctx.createLinearGradient(-30,0,-30-flameLen,0);
      efg.addColorStop(0,'rgba(255,200,100,.8)');efg.addColorStop(.5,'rgba(240,150,60,.4)');efg.addColorStop(1,'rgba(200,100,40,0)');
      ctx.beginPath();ctx.moveTo(-30,-5);ctx.quadraticCurveTo(-30-flameLen*.7,3*Math.sin(time*12),-30-flameLen,0);
      ctx.quadraticCurveTo(-30-flameLen*.7,-3*Math.sin(time*12),-30,5);
      ctx.fillStyle=efg;ctx.shadowColor='rgba(240,180,80,.4)';ctx.shadowBlur=12;ctx.fill();ctx.shadowBlur=0;
    }
    ctx.restore();
  }
  // Speed-trail particles
  const streakStars=Array.from({length:50},()=>({x:rand(0,1),y:rand(0,1),z:rand(.5,2)}));
  function animate(){
    time+=.016;ctx.clearRect(0,0,W,H);
    drawStars(ctx,W,H,60,time);drawWarmVignette(ctx,W,H);
    const speed=.5+.45*Math.sin(time*.5);
    const gamma=1/Math.sqrt(1-speed*speed);
    const contraction=1/gamma;
    // Speed streaks on right side — dramatic with aberration
    streakStars.forEach(s=>{
      const sx=W*.5+s.x*W*.5;const sy=s.y*H;
      const streak=1+speed*45*s.z;
      // Relativistic aberration: stars cluster ahead (rightward)
      const aberration=speed>.3?s.x*(1+speed*.4):0;
      const ax=sx+aberration*20;
      ctx.beginPath();ctx.moveTo(ax,sy);ctx.lineTo(ax+streak,sy);
      const brightness=.1+speed*.35+aberration*.15;
      ctx.strokeStyle=`rgba(240,200,140,${Math.min(brightness,.7)})`;ctx.lineWidth=s.z*(.7+speed*.5);ctx.stroke();
      s.x-=(.002+speed*.02)*s.z;if(s.x<0)s.x=1;
    });
    // Labels
    ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='13px Georgia';ctx.textAlign='center';
    ctx.fillText('At Rest (v = 0)',W*.25,35);
    ctx.fillText(`At ${(speed*100).toFixed(0)}% Speed of Light`,W*.75,35);
    // Measurement ruler grid on right side
    const rulerY=H*.45-35;
    ctx.strokeStyle=`rgba(240,200,140,${.08+speed*.1})`;ctx.lineWidth=.5;
    for(let i=-5;i<=5;i++){
      const rx=W*.75+i*16*contraction;
      ctx.beginPath();ctx.moveTo(rx,rulerY);ctx.lineTo(rx,rulerY+70);ctx.stroke();
    }
    // Divider with glow
    ctx.beginPath();ctx.moveTo(W/2,20);ctx.lineTo(W/2,H-20);
    ctx.strokeStyle='rgba(240,200,140,.12)';ctx.lineWidth=1;ctx.setLineDash([5,5]);ctx.shadowColor='rgba(240,200,140,.15)';ctx.shadowBlur=5;ctx.stroke();ctx.shadowBlur=0;ctx.setLineDash([]);
    // Rest ship
    drawShip(W*.25,H*.45,1,1,'#8a7060',false);
    // Contracted ship with engine on
    drawShip(W*.75,H*.45,contraction,1,'#8a7060',true);
    // Length indicator arrows with glow
    const restLen=80,contractLen=80*contraction;
    ctx.shadowColor='rgba(255,215,0,.4)';ctx.shadowBlur=6;
    ctx.strokeStyle='#ffd700';ctx.lineWidth=1.5;ctx.lineCap='round';
    // Rest arrow
    ctx.beginPath();ctx.moveTo(W*.25-restLen/2,H*.45+40);ctx.lineTo(W*.25+restLen/2,H*.45+40);ctx.stroke();
    ctx.beginPath();ctx.moveTo(W*.25-restLen/2,H*.45+36);ctx.lineTo(W*.25-restLen/2,H*.45+44);ctx.stroke();
    ctx.beginPath();ctx.moveTo(W*.25+restLen/2,H*.45+36);ctx.lineTo(W*.25+restLen/2,H*.45+44);ctx.stroke();
    ctx.fillStyle='#ffd700';ctx.font='12px Georgia';ctx.fillText('L₀ = 100%',W*.25,H*.45+60);
    // Contracted arrow
    ctx.beginPath();ctx.moveTo(W*.75-contractLen/2,H*.45+40);ctx.lineTo(W*.75+contractLen/2,H*.45+40);ctx.stroke();
    ctx.beginPath();ctx.moveTo(W*.75-contractLen/2,H*.45+36);ctx.lineTo(W*.75-contractLen/2,H*.45+44);ctx.stroke();
    ctx.beginPath();ctx.moveTo(W*.75+contractLen/2,H*.45+36);ctx.lineTo(W*.75+contractLen/2,H*.45+44);ctx.stroke();
    ctx.fillText(`L = ${(contraction*100).toFixed(0)}%`,W*.75,H*.45+60);
    ctx.shadowBlur=0;
    // Gamma display with glow
    ctx.fillStyle='rgba(200,180,255,.5)';ctx.font='13px Georgia';
    ctx.shadowColor='rgba(200,180,255,.3)';ctx.shadowBlur=8;
    ctx.fillText(`Lorentz factor γ = ${gamma.toFixed(2)}`,W/2,H-22);
    ctx.shadowBlur=0;
    requestAnimationFrame(animate);
  }
  animate();
}

/* ============================================================
   CHAPTER 10: TWIN PARADOX — Aging Twins
   ============================================================ */
function initCanvas10(){
  const canvas=document.getElementById('canvas10');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  let W,H;function resize(){W=canvas.width=canvas.offsetWidth;H=canvas.height=canvas.offsetHeight}
  resize();window.addEventListener('resize',resize);
  let time=0;
  const pages=[];
  const timeParticles=[];// Floating time dust
  function drawTwin(x,y,age,label,isTravel){
    const skinBase=lerp(248,220,age);const skinMid=lerp(215,185,age);const skinDark=lerp(195,160,age);
    ctx.save();ctx.translate(x,y);
    // Aura glow
    const auraColor=isTravel?'rgba(100,180,255,.1)':'rgba(255,200,100,.1)';
    const ag=ctx.createRadialGradient(0,20,10,0,20,85);ag.addColorStop(0,auraColor);ag.addColorStop(1,'rgba(0,0,0,0)');
    ctx.beginPath();ctx.arc(0,20,85,0,Math.PI*2);ctx.fillStyle=ag;ctx.fill();
    // Drop shadow under character
    ctx.beginPath();ctx.ellipse(0,82,22,5,0,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.15)';ctx.fill();

    // === BODY — shaped torso, rounded shoulders, tapered waist ===
    ctx.beginPath();
    ctx.moveTo(-18,28);// left shoulder
    ctx.quadraticCurveTo(-24,35,-23,50);// upper left
    ctx.quadraticCurveTo(-22,65,-20,72);// waist taper
    ctx.quadraticCurveTo(-22,78,-25,82);// hip flare
    ctx.lineTo(25,82);// bottom
    ctx.quadraticCurveTo(22,78,20,72);// right hip
    ctx.quadraticCurveTo(22,65,23,50);// right side
    ctx.quadraticCurveTo(24,35,18,28);// right shoulder
    ctx.quadraticCurveTo(0,24,-18,28);// neckline
    ctx.closePath();
    const bg=ctx.createLinearGradient(-24,28,24,82);
    if(isTravel){
      bg.addColorStop(0,'#7088a0');bg.addColorStop(.3,'#5a7088');bg.addColorStop(.7,'#4a6078');bg.addColorStop(1,'#3a4e60');
    } else {
      const ageTint=age>.5?.15:0;
      bg.addColorStop(0,`rgb(${110+ageTint*40},${100+ageTint*30},${80+ageTint*20})`);
      bg.addColorStop(1,`rgb(${70+ageTint*30},${62+ageTint*25},${50+ageTint*15})`);
    }
    ctx.fillStyle=bg;ctx.shadowColor='rgba(0,0,0,.2)';ctx.shadowBlur=8;ctx.fill();ctx.shadowBlur=0;
    ctx.strokeStyle='rgba(255,255,255,.1)';ctx.lineWidth=.5;ctx.stroke();
    // Collar / neckline detail
    ctx.beginPath();ctx.moveTo(-12,28);ctx.quadraticCurveTo(0,24,12,28);
    ctx.strokeStyle=isTravel?'rgba(180,200,220,.3)':'rgba(200,180,140,.3)';ctx.lineWidth=1;ctx.stroke();
    // Shirt V-line underneath collar
    ctx.beginPath();ctx.moveTo(-6,28);ctx.lineTo(0,38);ctx.lineTo(6,28);
    ctx.strokeStyle='rgba(255,255,255,.08)';ctx.lineWidth=.6;ctx.stroke();
    // Side seam shadows
    ctx.beginPath();ctx.moveTo(-22,34);ctx.quadraticCurveTo(-20,55,-22,75);
    ctx.strokeStyle='rgba(0,0,0,.06)';ctx.lineWidth=1.5;ctx.stroke();
    ctx.beginPath();ctx.moveTo(22,34);ctx.quadraticCurveTo(20,55,22,75);ctx.stroke();

    // === ARMS — upper arm + forearm with proper joints ===
    // Left arm
    // Left arm with fill
    ctx.beginPath();
    ctx.moveTo(-18,28);ctx.quadraticCurveTo(-22,30,-26,38);ctx.quadraticCurveTo(-30,48,-27,58);
    ctx.quadraticCurveTo(-24,64,-20,68);ctx.lineTo(-16,64);ctx.quadraticCurveTo(-20,58,-22,50);
    ctx.quadraticCurveTo(-24,40,-18,32);ctx.closePath();
    const laG=ctx.createLinearGradient(-28,30,-16,68);
    if(isTravel){laG.addColorStop(0,'#6882a0');laG.addColorStop(1,'#4a6478')}
    else{laG.addColorStop(0,'rgb(100,90,75)');laG.addColorStop(1,'rgb(75,66,54)')}
    ctx.fillStyle=laG;ctx.fill();
    // Left hand — mitten style
    ctx.beginPath();ctx.ellipse(-20,70,5,4.5,-.2,0,Math.PI*2);
    const lhg=ctx.createRadialGradient(-21,69,1,-20,70,5);
    lhg.addColorStop(0,`rgb(${skinBase},${skinMid-10},${skinDark-50})`);
    lhg.addColorStop(1,`rgb(${skinMid},${skinDark-20},${skinDark-70})`);
    ctx.fillStyle=lhg;ctx.fill();
    // Thumb
    ctx.beginPath();ctx.ellipse(-16,68,2.5,2,0.4,0,Math.PI*2);ctx.fillStyle=lhg;ctx.fill();

    // Right arm
    ctx.beginPath();
    ctx.moveTo(18,28);ctx.quadraticCurveTo(22,30,26,38);ctx.quadraticCurveTo(30,48,27,58);
    ctx.quadraticCurveTo(24,64,20,68);ctx.lineTo(16,64);ctx.quadraticCurveTo(20,58,22,50);
    ctx.quadraticCurveTo(24,40,18,32);ctx.closePath();
    const raG=ctx.createLinearGradient(16,30,28,68);
    if(isTravel){raG.addColorStop(0,'#6882a0');raG.addColorStop(1,'#4a6478')}
    else{raG.addColorStop(0,'rgb(100,90,75)');raG.addColorStop(1,'rgb(75,66,54)')}
    ctx.fillStyle=raG;ctx.fill();
    // Right hand
    ctx.beginPath();ctx.ellipse(20,70,5,4.5,.2,0,Math.PI*2);
    ctx.fillStyle=lhg;ctx.fill();
    ctx.beginPath();ctx.ellipse(16,68,2.5,2,-0.4,0,Math.PI*2);ctx.fillStyle=lhg;ctx.fill();

    // === HEAD — warm skin with multiple gradient stops ===
    ctx.beginPath();ctx.arc(0,0,26,0,Math.PI*2);
    const hg=ctx.createRadialGradient(-6,-6,3,0,0,26);
    hg.addColorStop(0,`rgb(${skinBase+5},${skinMid},${skinDark-30})`);
    hg.addColorStop(.5,`rgb(${skinBase-5},${skinMid-15},${skinDark-50})`);
    hg.addColorStop(1,`rgb(${skinBase-25},${skinMid-40},${skinDark-70})`);
    ctx.fillStyle=hg;ctx.shadowColor='rgba(80,40,10,.15)';ctx.shadowBlur=6;ctx.fill();ctx.shadowBlur=0;
    // Jawline shadow
    ctx.beginPath();ctx.moveTo(-22,8);ctx.quadraticCurveTo(-10,26,0,28);ctx.quadraticCurveTo(10,26,22,8);
    ctx.strokeStyle=`rgba(150,100,50,${.06+age*.08})`;ctx.lineWidth=1.5;ctx.stroke();

    // === EARS ===
    ctx.beginPath();ctx.ellipse(-25,2,5,7,-.15,0,Math.PI*2);ctx.fillStyle=`rgb(${skinBase-10},${skinMid-25},${skinDark-55})`;ctx.fill();
    ctx.beginPath();ctx.ellipse(-25,2,2.5,4,-.15,0,Math.PI*2);ctx.fillStyle=`rgba(${skinDark-20},${skinDark-60},${skinDark-90},.2)`;ctx.fill();
    ctx.beginPath();ctx.ellipse(25,2,5,7,.15,0,Math.PI*2);ctx.fillStyle=`rgb(${skinBase-10},${skinMid-25},${skinDark-55})`;ctx.fill();
    ctx.beginPath();ctx.ellipse(25,2,2.5,4,.15,0,Math.PI*2);ctx.fillStyle=`rgba(${skinDark-20},${skinDark-60},${skinDark-90},.2)`;ctx.fill();

    // === HAIR — with gray transition ===
    const hairGray=lerp(0,1,age);
    const hR=lerp(55,215,hairGray),hG=lerp(35,215,hairGray),hB=lerp(18,215,hairGray);
    ctx.beginPath();ctx.arc(0,-8,28,Math.PI+.15,-.15);ctx.fillStyle=`rgb(${hR},${hG},${hB})`;ctx.fill();
    // Hair highlight
    ctx.beginPath();ctx.arc(0,-12,20,Math.PI+.3,-.3);ctx.fillStyle=`rgba(${hR+30},${hG+30},${hB+30},.3)`;ctx.fill();
    // Strands at top
    for(let i=-3;i<=3;i++){
      ctx.beginPath();ctx.moveTo(i*6,-32);ctx.quadraticCurveTo(i*7+2,-40+Math.abs(i),i*6+4,-34);
      ctx.strokeStyle=`rgba(${hR},${hG},${hB},.6)`;ctx.lineWidth=1.8;ctx.lineCap='round';ctx.stroke();
    }
    // Sideburns
    ctx.beginPath();ctx.moveTo(-23,-4);ctx.quadraticCurveTo(-26,4,-24,10);
    ctx.strokeStyle=`rgba(${hR},${hG},${hB},.5)`;ctx.lineWidth=3;ctx.stroke();
    ctx.beginPath();ctx.moveTo(23,-4);ctx.quadraticCurveTo(26,4,24,10);ctx.stroke();

    // === EYES — full Pixar detail with sclera, iris gradient, dual highlights, lashes ===
    const eyeSize=lerp(5.5,4,age);
    // Eyelash lines
    ctx.beginPath();ctx.moveTo(-14,-3);ctx.quadraticCurveTo(-8,-7,-2,-3.5);
    ctx.strokeStyle=`rgba(${hR*.3},${hG*.3},${hB*.3},.25)`;ctx.lineWidth=1;ctx.stroke();
    ctx.beginPath();ctx.moveTo(2,-3.5);ctx.quadraticCurveTo(8,-7,14,-3);ctx.stroke();
    // Sclera
    [-8,8].forEach(ex=>{
      ctx.beginPath();ctx.ellipse(ex,0,eyeSize,eyeSize*1.2,0,0,Math.PI*2);
      const ew=ctx.createRadialGradient(ex-.5,-.5,eyeSize*.1,ex,0,eyeSize);
      ew.addColorStop(0,'#ffffff');ew.addColorStop(.85,'#f5ede5');ew.addColorStop(1,'#e0d4c4');
      ctx.fillStyle=ew;ctx.fill();
      ctx.strokeStyle='rgba(100,70,40,.1)';ctx.lineWidth=.5;ctx.stroke();
    });
    // Iris with gradient
    const irisR=eyeSize*.65;
    [-8,8].forEach(ex=>{
      ctx.beginPath();ctx.arc(ex,.8,irisR,0,Math.PI*2);
      const ig=ctx.createRadialGradient(ex-.5,.3,irisR*.15,ex,.8,irisR);
      ig.addColorStop(0,'#8B6834');ig.addColorStop(.4,'#6B4423');ig.addColorStop(1,'#3B2413');
      ctx.fillStyle=ig;ctx.fill();
      // Iris ring
      ctx.beginPath();ctx.arc(ex,.8,irisR*.88,0,Math.PI*2);
      ctx.strokeStyle='rgba(120,80,30,.2)';ctx.lineWidth=.3;ctx.stroke();
    });
    // Pupils
    [-8,8].forEach(ex=>{
      ctx.beginPath();ctx.arc(ex,.8,irisR*.48,0,Math.PI*2);ctx.fillStyle='#0a0602';ctx.fill();
    });
    // Primary highlights (large)
    [-8,8].forEach(ex=>{
      ctx.beginPath();ctx.arc(ex+2,-1.8,irisR*.4,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.88)';ctx.fill();
    });
    // Secondary highlights (small)
    [-8,8].forEach(ex=>{
      ctx.beginPath();ctx.arc(ex-1.5,2.5,irisR*.2,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.5)';ctx.fill();
    });
    // Warm reflection dot
    [-8,8].forEach(ex=>{
      ctx.beginPath();ctx.arc(ex+1,1.5,.5,0,Math.PI*2);ctx.fillStyle='rgba(255,210,120,.35)';ctx.fill();
    });

    // Eyebrows
    ctx.lineWidth=2.2;ctx.lineCap='round';ctx.strokeStyle=`rgba(${hR*.4},${hG*.4},${hB*.4},.75)`;
    ctx.beginPath();ctx.moveTo(-15,-7);ctx.quadraticCurveTo(-8,-12.5,-1,-8);ctx.stroke();
    ctx.beginPath();ctx.moveTo(1,-8);ctx.quadraticCurveTo(8,-12.5,15,-7);ctx.stroke();

    // Cheeks — rosy glow
    ctx.beginPath();ctx.arc(-16,8,6,0,Math.PI*2);
    const cg1=ctx.createRadialGradient(-16,7,1,-16,8,6);cg1.addColorStop(0,'rgba(255,140,130,.3)');cg1.addColorStop(1,'rgba(255,140,130,0)');
    ctx.fillStyle=cg1;ctx.fill();
    ctx.beginPath();ctx.arc(16,8,6,0,Math.PI*2);ctx.fillStyle=cg1;ctx.fill();

    // === NOSE — defined shape ===
    ctx.beginPath();ctx.moveTo(-1,3);ctx.quadraticCurveTo(0,10,1,3);
    ctx.strokeStyle='rgba(170,120,70,.4)';ctx.lineWidth=1;ctx.stroke();
    ctx.beginPath();ctx.moveTo(-3.5,10);ctx.quadraticCurveTo(0,13.5,3.5,10);
    ctx.fillStyle=`rgba(${skinMid},${skinDark-20},${skinDark-50},.15)`;ctx.fill();
    ctx.strokeStyle='rgba(170,120,70,.3)';ctx.lineWidth=.8;ctx.stroke();

    // Wrinkles if aging
    if(age>.3){
      ctx.strokeStyle=`rgba(140,90,50,${age*.35})`;ctx.lineWidth=.7;ctx.lineCap='round';
      // Forehead lines
      ctx.beginPath();ctx.moveTo(-12,-18);ctx.lineTo(-4,-16.5);ctx.moveTo(-3,-19);ctx.lineTo(5,-17.5);ctx.stroke();
      ctx.beginPath();ctx.moveTo(4,-17);ctx.lineTo(12,-18.5);ctx.stroke();
      // Crow's feet
      ctx.beginPath();ctx.moveTo(-17,0);ctx.lineTo(-22,-2);ctx.moveTo(-17,2);ctx.lineTo(-22,4);ctx.stroke();
      ctx.beginPath();ctx.moveTo(17,0);ctx.lineTo(22,-2);ctx.moveTo(17,2);ctx.lineTo(22,4);ctx.stroke();
      // Nasolabial folds
      ctx.beginPath();ctx.moveTo(-5,9);ctx.quadraticCurveTo(-7,14,-10,17);ctx.stroke();
      ctx.beginPath();ctx.moveTo(5,9);ctx.quadraticCurveTo(7,14,10,17);ctx.stroke();
    }

    // === MOUTH ===
    ctx.beginPath();
    if(age>.5){
      ctx.moveTo(-6,15);ctx.quadraticCurveTo(0,17,6,15);
      ctx.strokeStyle='rgba(150,90,50,.5)';
    } else {
      ctx.moveTo(-8,13);ctx.quadraticCurveTo(0,21,8,13);
      ctx.strokeStyle='rgba(200,110,70,.65)';
    }
    ctx.lineWidth=1.6;ctx.lineCap='round';ctx.stroke();
    // Lip texture lines
    ctx.strokeStyle=`rgba(160,90,55,${.03+age*.02})`;ctx.lineWidth=.2;
    for(let l=-5;l<=5;l+=2){ctx.beginPath();ctx.moveTo(l,age>.5?14.5:13.5);ctx.lineTo(l,age>.5?16:17);ctx.stroke();}

    // Age spots on face
    if(age>.3){
      ctx.fillStyle=`rgba(150,100,50,${age*.1})`;
      ctx.beginPath();ctx.arc(-10,4,1.5,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(12,6,1.2,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(-6,18,1,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(8,-12,1.3,0,Math.PI*2);ctx.fill();
    }
    // Hand wrinkle lines and veins
    [-20,20].forEach(hx=>{
      const hy=70;
      if(age>.2){
        // Knuckle wrinkles
        ctx.strokeStyle=`rgba(140,90,50,${age*.15})`;ctx.lineWidth=.4;
        ctx.beginPath();ctx.moveTo(hx-2,hy-1);ctx.lineTo(hx+2,hy-1);ctx.stroke();
        ctx.beginPath();ctx.moveTo(hx-1.5,hy+1);ctx.lineTo(hx+1.5,hy+1);ctx.stroke();
        // Hand veins
        ctx.strokeStyle=`rgba(80,120,110,${age*.06})`;ctx.lineWidth=.35;
        ctx.beginPath();ctx.moveTo(hx-1,hy-3);ctx.quadraticCurveTo(hx,hy,hx+1,hy+3);ctx.stroke();
      }
      // Age spots on hands
      if(age>.4){
        ctx.fillStyle=`rgba(150,100,50,${age*.08})`;
        ctx.beginPath();ctx.arc(hx+1,hy-2,.8,0,Math.PI*2);ctx.fill();
      }
    });
    // Fabric texture on clothing
    ctx.save();ctx.globalAlpha=.03;
    for(let fy=30;fy<80;fy+=3){
      ctx.beginPath();ctx.moveTo(-22,fy);ctx.lineTo(22,fy);
      ctx.strokeStyle='rgba(255,255,255,.3)';ctx.lineWidth=.2;ctx.stroke();
    }
    ctx.restore();
    // Posture: slight hunch if aging
    // (Expressed through the whole body transform already)

    ctx.restore();
    // Label with glow
    ctx.fillStyle='rgba(255,255,255,.7)';ctx.font='13px Georgia';ctx.textAlign='center';
    ctx.shadowColor=isTravel?'rgba(100,150,255,.35)':'rgba(255,200,100,.35)';ctx.shadowBlur=6;
    ctx.fillText(label,x,y+100);ctx.shadowBlur=0;
  }
  function animate(){
    time+=.016;ctx.clearRect(0,0,W,H);
    drawStars(ctx,W,H,50,time);drawWarmVignette(ctx,W,H);
    const cx=W/2,cy=H/2;
    const ageFactor=.5+.5*Math.sin(time*.3);
    // Floating time dust particles
    if(Math.random()<.15){
      const side=Math.random()>.5;
      timeParticles.push({
        x:side?W*.15+rand(-40,40):W*.65+rand(-40,40),
        y:cy+rand(-60,60),a:1,r:rand(1,3),
        vy:rand(-.5,-.1),vx:rand(-.3,.3),
        hue:side?40:220
      });
    }
    timeParticles.forEach(p=>{
      p.y+=p.vy;p.x+=p.vx;p.a*=.99;
      if(p.a>.01){
        ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fillStyle=`hsla(${p.hue},60%,70%,${p.a*.4})`;
        ctx.shadowColor=`hsla(${p.hue},60%,70%,.3)`;ctx.shadowBlur=6;
        ctx.fill();ctx.shadowBlur=0;
      }
    });
    while(timeParticles.length>100)timeParticles.shift();
    // Calendar pages floating on Earth side
    if(Math.random()<.1){
      pages.push({x:W*.3+rand(-40,40),y:cy-60,vy:rand(.5,2),vx:rand(-.8,.8),rot:0,rotV:rand(-.05,.05),a:1});
    }
    pages.forEach(p=>{
      p.y+=p.vy;p.x+=p.vx;p.rot+=p.rotV;p.a*=.99;
      if(p.a>.01){
        ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.globalAlpha=p.a;
        ctx.fillStyle='#fffff0';ctx.shadowColor='rgba(255,255,200,.2)';ctx.shadowBlur=4;
        ctx.fillRect(-10,-12,20,24);ctx.shadowBlur=0;
        ctx.strokeStyle='#ccc';ctx.lineWidth=.5;ctx.strokeRect(-10,-12,20,24);
        // Red header bar
        ctx.fillStyle='rgba(204,68,68,.8)';ctx.fillRect(-10,-12,20,6);
        ctx.fillStyle='#333';ctx.font='bold 9px sans-serif';ctx.textAlign='center';ctx.fillText(randInt(1,31).toString(),0,5);
        ctx.globalAlpha=1;ctx.restore();
      }
    });
    while(pages.length>50)pages.shift();
    // Spacetime path arc (traveler)
    ctx.beginPath();
    ctx.moveTo(W*.7,cy+75);
    ctx.quadraticCurveTo(W*.85,cy-80,W*.7,cy-75);
    ctx.strokeStyle='rgba(240,200,140,.12)';ctx.lineWidth=1.5;ctx.setLineDash([4,4]);ctx.stroke();ctx.setLineDash([]);
    // Tiny rocket on path with light trail
    const rocketAngle=time*.8;const rocketT=.5+.5*Math.sin(rocketAngle);
    const rocketX=W*.7+35*Math.cos(rocketAngle);
    const rocketY=cy-75+150*rocketT;
    // Light trail
    ctx.beginPath();
    for(let t=0;t<20;t++){
      const ta=rocketAngle-t*.08;const tt=.5+.5*Math.sin(ta);
      const tx=W*.7+35*Math.cos(ta);const ty=cy-75+150*tt;
      t===0?ctx.moveTo(tx,ty):ctx.lineTo(tx,ty);
    }
    ctx.strokeStyle='rgba(100,180,255,.15)';ctx.lineWidth=3;ctx.stroke();
    ctx.strokeStyle='rgba(200,220,255,.08)';ctx.lineWidth=6;ctx.stroke();
    // Doppler-shifted stars along travel path
    for(let i=0;i<8;i++){
      const sa=rocketAngle+i*.4;const sDir=Math.cos(sa);
      const starCol=sDir>0?`rgba(100,150,255,.3)`:`rgba(255,150,100,.3)`;
      const stx=W*.7+50*Math.cos(sa);const sty=cy+60*Math.sin(sa);
      ctx.beginPath();ctx.arc(stx,sty,1.5,0,Math.PI*2);ctx.fillStyle=starCol;ctx.fill();
    }
    ctx.save();ctx.translate(rocketX,rocketY);ctx.rotate(Math.sin(rocketAngle)*0.3+Math.PI*.25);
    // Mini rocket ship with windows
    ctx.beginPath();ctx.moveTo(0,-8);ctx.quadraticCurveTo(-4,-4,-4,4);ctx.lineTo(4,4);ctx.quadraticCurveTo(4,-4,0,-8);ctx.closePath();
    ctx.fillStyle='#aabbcc';ctx.fill();
    // Windows with warm light
    ctx.beginPath();ctx.arc(0,-2,1.5,0,Math.PI*2);
    ctx.fillStyle='rgba(255,220,120,.8)';ctx.shadowColor='rgba(255,200,80,.5)';ctx.shadowBlur=4;ctx.fill();
    ctx.beginPath();ctx.arc(0,2,1.2,0,Math.PI*2);
    ctx.fillStyle='rgba(255,210,100,.6)';ctx.fill();ctx.shadowBlur=0;
    // Fins
    ctx.fillStyle='#dd4444';
    ctx.beginPath();ctx.moveTo(-4,3);ctx.lineTo(-7,6);ctx.lineTo(-3,5);ctx.fill();
    ctx.beginPath();ctx.moveTo(4,3);ctx.lineTo(7,6);ctx.lineTo(3,5);ctx.fill();
    // Exhaust
    ctx.beginPath();ctx.moveTo(-2,4);ctx.quadraticCurveTo(0,8+Math.sin(time*15)*2,2,4);
    ctx.fillStyle='rgba(255,180,60,.6)';ctx.fill();
    ctx.restore();
    // Divider
    ctx.beginPath();ctx.moveTo(cx,30);ctx.lineTo(cx,H-30);
    ctx.strokeStyle='rgba(255,255,255,.08)';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.stroke();ctx.setLineDash([]);
    // Earth with continent outlines
    ctx.save();ctx.translate(W*.3,cy+85);
    // Earth sphere
    const earthR=14;
    const eG=ctx.createRadialGradient(-3,-3,2,0,0,earthR);
    eG.addColorStop(0,'#5588dd');eG.addColorStop(.4,'#3366bb');eG.addColorStop(.8,'#224488');eG.addColorStop(1,'#112244');
    ctx.beginPath();ctx.arc(0,0,earthR,0,Math.PI*2);ctx.fillStyle=eG;ctx.fill();
    // Simplified continent outlines (rotating)
    ctx.save();ctx.beginPath();ctx.arc(0,0,earthR-.5,0,Math.PI*2);ctx.clip();
    const rot=time*.1;
    ctx.fillStyle='rgba(80,180,80,.5)';
    // Americas-like shape
    ctx.beginPath();
    const ax=-4+Math.sin(rot)*8;
    ctx.moveTo(ax-2,-10);ctx.quadraticCurveTo(ax-4,-6,ax-3,-2);ctx.quadraticCurveTo(ax-5,2,ax-3,6);
    ctx.quadraticCurveTo(ax-2,10,ax,8);ctx.quadraticCurveTo(ax+2,4,ax+1,-2);ctx.quadraticCurveTo(ax+3,-6,ax,-10);
    ctx.fill();
    // Europe/Africa shape
    const bx=6+Math.sin(rot)*8;
    ctx.beginPath();
    ctx.moveTo(bx-1,-8);ctx.quadraticCurveTo(bx+2,-4,bx+1,0);ctx.quadraticCurveTo(bx+3,4,bx+1,8);
    ctx.quadraticCurveTo(bx-1,6,bx-2,2);ctx.quadraticCurveTo(bx-3,-2,bx-1,-8);
    ctx.fill();
    ctx.restore();
    // Atmosphere rim
    ctx.beginPath();ctx.arc(0,0,earthR+1,0,Math.PI*2);
    ctx.strokeStyle='rgba(100,180,255,.2)';ctx.lineWidth=2;ctx.stroke();
    ctx.restore();

    // Earth twin (ages)
    drawTwin(W*.3,cy-15,ageFactor,'🌍 Earth Twin',false);
    // Traveler twin (stays young)
    drawTwin(W*.7,cy-15,ageFactor*.1,'🚀 Traveler Twin',true);
    // Age labels with glow
    ctx.textAlign='center';ctx.font='14px Georgia';
    ctx.fillStyle='rgba(255,215,0,.8)';ctx.shadowColor='rgba(255,215,0,.4)';ctx.shadowBlur=8;
    ctx.fillText(`Age: ${(25+ageFactor*50).toFixed(0)} years`,W*.3,cy+110);
    ctx.fillText(`Age: ${(25+ageFactor*5).toFixed(0)} years`,W*.7,cy+110);
    ctx.shadowBlur=0;
    // Timeline visualization: proper time vs coordinate time
    const barY=H-48,barW=W*.6,barX=(W-barW)/2;
    ctx.fillStyle='rgba(255,255,255,.04)';ctx.fillRect(barX,barY-2,barW,22);
    const earthFill=barW*(.5+ageFactor*.5);const travelFill=barW*(.5+ageFactor*.05);
    // Earth proper time (gold)
    ctx.fillStyle='rgba(255,180,80,.5)';ctx.fillRect(barX,barY,earthFill,6);
    ctx.shadowColor='rgba(255,180,80,.3)';ctx.shadowBlur=4;
    ctx.fillRect(barX,barY,earthFill,6);ctx.shadowBlur=0;
    // Traveler proper time (blue)
    ctx.fillStyle='rgba(100,180,255,.5)';ctx.fillRect(barX,barY+10,travelFill,6);
    ctx.shadowColor='rgba(100,180,255,.3)';ctx.shadowBlur=4;
    ctx.fillRect(barX,barY+10,travelFill,6);ctx.shadowBlur=0;
    // Labels
    ctx.fillStyle='rgba(255,200,100,.5)';ctx.font='9px Georgia';ctx.textAlign='left';
    ctx.fillText('Coordinate time (Earth)',barX,barY-5);
    ctx.fillStyle='rgba(100,180,255,.5)';
    ctx.fillText('Proper time (Traveler)',barX,barY+24);
    ctx.textAlign='center';
    ctx.fillStyle='rgba(255,255,255,.3)';ctx.font='10px Georgia';
    ctx.fillText(`Δτ = ${((ageFactor*.5-ageFactor*.05)*50).toFixed(0)} years difference`,W/2,barY+36);
    requestAnimationFrame(animate);
  }
  animate();
}

/* ============================================================
   TYPEWRITER EFFECT
   ============================================================ */
function initTypewriters(){
  const observer=new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        const el=e.target;
        if(el.dataset.typed)return;
        el.dataset.typed='1';
        const text=el.dataset.text||'';
        let i=0;el.textContent='';
        function type(){
          if(i<text.length){el.textContent+=text[i];i++;setTimeout(type,25+Math.random()*15)}
          else{el.classList.add('done')}
        }
        type();
      }
    });
  },{threshold:.5});
  document.querySelectorAll('.typewriter').forEach(el=>observer.observe(el));
}

/* ============================================================
   NAV DOTS SETUP
   ============================================================ */
function initNavDots(){
  const container=document.getElementById('nav-dots');
  const chapters=document.querySelectorAll('.chapter');
  chapters.forEach((ch,i)=>{
    const dot=document.createElement('div');dot.className='nav-dot';
    const tip=document.createElement('span');tip.className='tooltip';tip.textContent=ch.dataset.title||`Chapter ${i+1}`;
    dot.appendChild(tip);
    dot.addEventListener('click',()=>ch.scrollIntoView({behavior:'smooth'}));
    container.appendChild(dot);
  });
}

/* ============================================================
   SCROLL HANDLING — Progress, Nav, Parallax
   ============================================================ */
function initScroll(){
  const bar=document.getElementById('progress-bar');
  const dots=document.querySelectorAll('.nav-dot');
  const chapters=document.querySelectorAll('.chapter');
  const scrollInd=document.getElementById('scroll-indicator');
  // Fade-in observer for chapters
  const fadeObs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{if(e.isIntersecting)e.target.classList.add('in-view')});
  },{threshold:.15});
  chapters.forEach(ch=>fadeObs.observe(ch));
  function onScroll(){
    const scrollTop=window.scrollY;const docH=document.body.scrollHeight-window.innerHeight;
    const progress=clamp(scrollTop/docH,0,1);
    bar.style.width=`${progress*100}%`;
    if(scrollTop>200)scrollInd.style.opacity='0';else scrollInd.style.opacity='1';
    chapters.forEach((ch,i)=>{
      const rect=ch.getBoundingClientRect();
      const inView=rect.top<window.innerHeight*.5&&rect.bottom>window.innerHeight*.5;
      if(dots[i])dots[i].classList.toggle('active',inView);
    });
  }
  window.addEventListener('scroll',onScroll,{passive:true});
  onScroll();
}

/* ============================================================
   LOADING SCREEN
   ============================================================ */
function initLoader(){
  const bar=document.getElementById('loader-bar');
  let prog=0;
  const interval=setInterval(()=>{
    prog+=rand(3,12);if(prog>100)prog=100;
    bar.style.width=prog+'%';
    if(prog>=100){clearInterval(interval);setTimeout(()=>{document.getElementById('loader').classList.add('hidden')},400)}
  },100);
}

/* ============================================================
   INIT EINSTEIN CHARACTERS
   ============================================================ */
function initEinsteins(){
  const poseMap={
    'einstein-1':'wave','einstein-2':'explain','einstein-3':'think',
    'einstein-4':'curious','einstein-5':'mindblown','einstein-6':'wonder',
    'einstein-7':'excited','einstein-8':'proud','einstein-9':'point','einstein-10':'present'
  };
  Object.entries(poseMap).forEach(([id,pose])=>createEinstein(id,pose));
  // Squash & stretch on scroll into view
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){e.target.classList.add('squash');setTimeout(()=>e.target.classList.remove('squash'),500)}
    });
  },{threshold:.5});
  document.querySelectorAll('.einstein-wrap').forEach(el=>obs.observe(el));
}

/* ============================================================
   CANVAS VISIBILITY — Only animate when visible
   ============================================================ */
function initCanvasAnimations(){
  const inits={
    canvas1:initCanvas1,canvas2:initCanvas2,canvas3:initCanvas3,
    canvas6:initCanvas6,
    canvas7:initCanvas7,canvas8:initCanvas8,canvas9:initCanvas9,canvas10:initCanvas10
  };
  const started=new Set();

  function tryInit(id){
    if(started.has(id))return;
    started.add(id);
    if(inits[id]){
      try{inits[id]()}catch(err){console.error('Canvas init error:',id,err)}
    }
  }

  // Always init canvas1 immediately since it's at the top
  tryInit('canvas1');

  // Use observer for the rest
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting)tryInit(e.target.id);
    });
  },{threshold:.05});
  Object.keys(inits).forEach(id=>{const el=document.getElementById(id);if(el)obs.observe(el)});
}

/* ============================================================
   BOOT
   ============================================================ */
document.addEventListener('DOMContentLoaded',()=>{
  initLoader();
  initNavDots();
  initScroll();
  initTypewriters();
  initEinsteins();
  initCanvasAnimations();
/* canvas1 direct init removed */
});
</script>

<!-- Three.js GPU-accelerated chapters (4 & 5) -->
<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

/* ===== HELPER: create Three.js scene kit ===== */
function createKit(containerId, opts={}) {
  const el = document.getElementById(containerId);
  if (!el) return null;
  const w = el.clientWidth || 700, h = el.clientHeight || 400;
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(opts.bg || 0x12051f);
  const camera = new THREE.PerspectiveCamera(opts.fov || 50, w/h, 0.1, 1000);
  camera.position.set(opts.cx||0, opts.cy||0, opts.cz||10);
  if (opts.lookAt) camera.lookAt(...opts.lookAt);
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(w, h);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.domElement.style.borderRadius = '16px';
  el.appendChild(renderer.domElement);
  let composer = null;
  if (opts.bloom) {
    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(
      new THREE.Vector2(w, h),
      opts.bloomStr || 1.2, opts.bloomRad || 0.4, opts.bloomThr || 0.2
    ));
  }
  return { scene, camera, renderer, composer, el, w, h };
}

/* ===== CHAPTER 4: LIGHT BENDING — 3D grid + sun + photon beam with bloom =====
   Matches vanilla: depress() grid, GM-based photon simulation, minimalist style */
function initThreeChapter4() {
  const kit = createKit('tc4', {
    bg: 0x12051f, fov: 45, cx: 0, cy: 6, cz: 18,
    lookAt: [0, -1, 0],
    bloom: true, bloomStr: 1.0, bloomRad: 0.5, bloomThr: 0.25
  });
  if (!kit) return;
  const { scene, camera, composer } = kit;

  // 3D grid matching vanilla: 21 lines, extent maps to ~10 units in Three.js
  const GRID = 21, EXT = 10, DEP_DEPTH = 3, DEP_RAD = 8;

  function depress(x, z) {
    const d = Math.sqrt(x*x + z*z);
    if (d > DEP_RAD) return 0;
    const f = 1 - d / DEP_RAD;
    return -DEP_DEPTH * f * f; // negative = downward
  }

  // Build grid lines as LineSegments
  const gridPts = [];
  // Horizontal (constant z)
  for (let r = 0; r < GRID; r++) {
    const z = (r/(GRID-1) - 0.5) * EXT * 2;
    for (let c = 0; c < GRID*3 - 1; c++) {
      const x1 = (c/(GRID*3-1) - 0.5) * EXT * 2;
      const x2 = ((c+1)/(GRID*3-1) - 0.5) * EXT * 2;
      gridPts.push(x1, depress(x1,z), z, x2, depress(x2,z), z);
    }
  }
  // Vertical (constant x)
  for (let c = 0; c < GRID; c++) {
    const x = (c/(GRID-1) - 0.5) * EXT * 2;
    for (let r = 0; r < GRID*3 - 1; r++) {
      const z1 = (r/(GRID*3-1) - 0.5) * EXT * 2;
      const z2 = ((r+1)/(GRID*3-1) - 0.5) * EXT * 2;
      gridPts.push(x, depress(x,z1), z1, x, depress(x,z2), z2);
    }
  }
  const gridGeo = new THREE.BufferGeometry();
  gridGeo.setAttribute('position', new THREE.Float32BufferAttribute(gridPts, 3));
  const gridMesh = new THREE.LineSegments(gridGeo,
    new THREE.LineBasicMaterial({ color: 0x8c96dc, transparent: true, opacity: 0.2 })
  );
  scene.add(gridMesh);

  // Sun at depression center
  const sunGeo = new THREE.SphereGeometry(0.6, 24, 24);
  const sunMat = new THREE.MeshBasicMaterial({ color: 0xffcc44 });
  const sun = new THREE.Mesh(sunGeo, sunMat);
  sun.position.set(0, depress(0,0), 0);
  scene.add(sun);
  // Sun glow
  const glowMat = new THREE.MeshBasicMaterial({ color: 0xffaa22, transparent: true, opacity: 0.15 });
  const glow = new THREE.Mesh(new THREE.SphereGeometry(1.2, 24, 24), glowMat);
  glow.position.copy(sun.position);
  scene.add(glow);

  // Photon path — simulate with vanilla-matching physics (scaled to Three.js units)
  // GM=10, dt=0.01, PHOTON_SPEED=2.5, IMPACT_PARAM=EXT*0.5
  const photonPts = [];
  {
    const GM = 10, dt = 0.01, PS = 2.5, MAX = 80000;
    let px = EXT * 0.5, pz = -EXT * 0.95;
    let vx = 0, vz = PS;
    for (let i = 0; i < MAX; i++) {
      const dx = -px, dz = -pz;
      const d = Math.sqrt(dx*dx + dz*dz);
      if (d < 0.5) break;
      const a = GM / (d*d*d);
      vx += dx * a * dt;
      vz += dz * a * dt;
      const spd = Math.sqrt(vx*vx + vz*vz);
      vx = vx/spd * PS; vz = vz/spd * PS;
      px += vx * dt; pz += vz * dt;
      if (pz > EXT) break;
      if (i % 10 === 0) {
        photonPts.push(new THREE.Vector3(px, depress(px, pz) + 0.05, pz));
      }
    }
  }
  const beamCurve = new THREE.CatmullRomCurve3(photonPts);
  // Faint full path
  const pathGeo = new THREE.TubeGeometry(beamCurve, 200, 0.02, 4, false);
  const pathMat = new THREE.MeshBasicMaterial({ color: 0xe8c840, transparent: true, opacity: 0.07 });
  scene.add(new THREE.Mesh(pathGeo, pathMat));
  // Bright trail tube (animated via opacity)
  const trailGeo = new THREE.TubeGeometry(beamCurve, 200, 0.035, 6, false);
  const trailMat = new THREE.MeshBasicMaterial({ color: 0xffd750, transparent: true, opacity: 0.45 });
  const trail = new THREE.Mesh(trailGeo, trailMat);
  scene.add(trail);
  // Photon dot
  const photon = new THREE.Mesh(
    new THREE.SphereGeometry(0.12, 12, 12),
    new THREE.MeshBasicMaterial({ color: 0xfff0c0 })
  );
  scene.add(photon);

  let time = 0;
  const ch4Obs = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting && !ch4Running) { ch4Running = true; animateCh4(); }
    else if (!entries[0].isIntersecting) ch4Running = false;
  }, { threshold: 0.05 });
  let ch4Running = false;
  ch4Obs.observe(kit.el);

  function animateCh4() {
    if (!ch4Running) return;
    requestAnimationFrame(animateCh4);
    time += 0.016;
    const t = (time * 0.15) % 1;
    const pt = beamCurve.getPointAt(t);
    photon.position.copy(pt);
    glow.scale.setScalar(1 + 0.1 * Math.sin(time * 3));
    composer.render();
  }
}

/* ===== CHAPTER 5: BLACK HOLES — GPU bloom =====
   Vanilla params: 14 rings, 50 stars, stretch cap 3, warm (240,220,200),
   gold photon ring #f0be50, softer trail #050210, NO jets */
function initThreeChapter5() {
  const kit = createKit('tc5', {
    bg: 0x050210, fov: 50, cx: 0, cy: 0, cz: 10,
    bloom: true, bloomStr: 1.5, bloomRad: 0.6, bloomThr: 0.15
  });
  if (!kit) return;
  const { scene, camera, composer } = kit;

  // Event horizon
  scene.add(new THREE.Mesh(
    new THREE.SphereGeometry(1, 32, 32),
    new THREE.MeshBasicMaterial({ color: 0x000000 })
  ));

  // Photon ring (gold) — vanilla #f0be50
  const photonRing = new THREE.Mesh(
    new THREE.RingGeometry(1.05, 1.15, 64),
    new THREE.MeshBasicMaterial({ color: 0xf0be50, side: THREE.DoubleSide, transparent: true, opacity: 0.7 })
  );
  scene.add(photonRing);

  // 14 accretion rings — wider spacing, lower opacity (vanilla: 38+ring*5.5 px → scaled)
  for (let i = 0; i < 14; i++) {
    const inner = 1.4 + i * 0.28;
    const outer = inner + 0.18;
    const hue = 0.14 - i * 0.007; // warm → cooler
    const c = new THREE.Color().setHSL(hue, 0.8, 0.52 + i * 0.02);
    const ring = new THREE.Mesh(
      new THREE.RingGeometry(inner, outer, 64),
      new THREE.MeshBasicMaterial({ color: c, side: THREE.DoubleSide, transparent: true, opacity: 0.5 - i * 0.025 })
    );
    ring.rotation.x = Math.PI * 0.42;
    scene.add(ring);
  }

  // 50 stars with warm colors (240,220,200) and stretch cap 3
  const stars = [];
  for (let i = 0; i < 50; i++) {
    const s = new THREE.Mesh(
      new THREE.SphereGeometry(0.04, 6, 6),
      new THREE.MeshBasicMaterial({ color: new THREE.Color(240/255, 220/255, 200/255), transparent: true })
    );
    const angle = Math.random() * Math.PI * 2;
    const radius = 3 + Math.random() * 5;
    s.userData = {
      angle, radius,
      speed: 0.001 + Math.random() * 0.004,
      z: (Math.random() - 0.5) * 4,
      brightness: 0.3 + Math.random() * 0.6
    };
    s.material.opacity = s.userData.brightness;
    scene.add(s);
    stars.push(s);
  }

  let time = 0;
  const ch5Obs = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting && !ch5Running) { ch5Running = true; animateCh5(); }
    else if (!entries[0].isIntersecting) ch5Running = false;
  }, { threshold: 0.05 });
  let ch5Running = false;
  ch5Obs.observe(kit.el);

  function animateCh5() {
    if (!ch5Running) return;
    requestAnimationFrame(animateCh5);
    time += 0.016;

    stars.forEach(s => {
      s.userData.angle += s.userData.speed;
      let r = s.userData.radius;
      // Slow spiral inward
      s.userData.radius -= 0.0005;
      if (s.userData.radius < 1.2) {
        s.userData.radius = 3 + Math.random() * 5;
        s.userData.angle = Math.random() * Math.PI * 2;
      }
      s.position.x = Math.cos(s.userData.angle) * r;
      s.position.y = Math.sin(s.userData.angle) * r * 0.4;
      s.position.z = s.userData.z;
      // Spaghettification with cap at 3 (vanilla)
      const stretch = r < 2.5 ? Math.min(1 + (2.5 - r) * 2, 3) : 1;
      s.scale.set(1, stretch, 1);
    });

    photonRing.rotation.z += 0.005;
    composer.render();
  }
}

/* ===== INIT Three.js chapters ===== */
const tc4Obs = new IntersectionObserver(entries => {
  if (entries[0].isIntersecting) { tc4Obs.disconnect(); initThreeChapter4(); }
}, { threshold: 0.05 });
const tc5Obs = new IntersectionObserver(entries => {
  if (entries[0].isIntersecting) { tc5Obs.disconnect(); initThreeChapter5(); }
}, { threshold: 0.05 });
const tc4El = document.getElementById('tc4');
const tc5El = document.getElementById('tc5');
if (tc4El) tc4Obs.observe(tc4El);
if (tc5El) tc5Obs.observe(tc5El);
</script>
</body>
</html>
